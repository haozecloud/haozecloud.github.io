<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>原点独白</title>

  
    <meta name="description" content="diff -uNr postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README— postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README	1970-01-01 01:00:00.000000000 +0">
<meta property="og:type" content="article">
<meta property="og:title" content="原点独白">
<meta property="og:url" content="https://haozecloud.github.io/2023/09/28/Linux%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/wireshark/postfix/postfix-vda-v13-2.10.0.patch/index.html">
<meta property="og:site_name" content="原点独白">
<meta property="og:description" content="diff -uNr postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README— postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README	1970-01-01 01:00:00.000000000 +0">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-09-28T05:27:17.771Z">
<meta property="article:modified_time" content="2023-09-21T10:55:00.820Z">
<meta property="article:author" content="Zhang Hao Ze">
<meta name="twitter:card" content="summary">
  
  
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  
    <link rel="shortcut icon" href="https://img1.imgtp.com/2023/09/25/3pQ59aAI.png">
  

  

  


  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://img1.imgtp.com/2023/09/25/3pQ59aAI.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">原点独白</div><div class="sub cap">微信公众号</div></a></div>

<nav class="menu dis-select"><a class="nav-item active" href="/">文章</a><a class="nav-item" href="/wiki/">项目</a><a class="nav-item" href="/images/">照片</a><a class="nav-item" href="/more/">日常</a></nav>
</header>


<div class="widgets">

<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">本文目录</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#diff-uNr-postfix-2-10-0-orig-README-FILES-VDA-README-postfix-2-10-0-README-FILES-VDA-README%E2%80%94-postfix-2-10-0-orig-README-FILES-VDA-README1970-01-01-01-00-00-000000000-0100-postfix-2-10-0-README-FILES-VDA-README2013-06-07-13-21-22-837143270-0200-0-0-1-10-Postfix-VDA-patch-for-maildir-quota-support-by-Anderson-Nadal-x61-x6e-x64-x65-x72-x6e-97-100-x61-x6c-x40-103-x6d-97-x69-108-x2e-99-x6f-x6d-Tomas-Macek-x6d-x61-x63-x61-x30-50-x40-97-116-x6c-x61-x73-46-x63-122-Lucca-Longinotti-See-VDA-patch-official-website-http-vda-sf-net-for-instructions-howto-patch-the-Postfix%E2%80%99s-sourcetree-and-configure-the-options-provided-by-this-patch-diff-uNr-postfix-2-10-0-orig-src-global-mail-params-h-postfix-2-10-0-src-global-mail-params-h%E2%80%94-postfix-2-10-0-orig-src-global-mail-params-h2013-02-03-19-22-21-000000000-0100-postfix-2-10-0-src-global-mail-params-h2013-06-07-13-21-22-838143270-0200-2367-6-2367-54-define-DEF-VIRT-GID-MAPS%E2%80%9C%E2%80%9D-extern-char-var-virt-gid-maps-define-VAR-VIRT-MAILBOX-LIMIT-MAPS-%E2%80%9Cvirtual-mailbox-limit-maps%E2%80%9D-define-DEF-VIRT-MAILBOX-LIMIT-MAPS-%E2%80%9C%E2%80%9D-extern-char-var-virt-mailbox-limit-maps-define-VAR-VIRT-MAILBOX-LIMIT-INBOX-%E2%80%9Cvirtual-mailbox-limit-inbox%E2%80%9D-define-DEF-VIRT-MAILBOX-LIMIT-INBOX-0-extern-bool-var-virt-mailbox-limit-inbox-define-VAR-VIRT-MAILBOX-LIMIT-OVERRIDE-%E2%80%9Cvirtual-mailbox-limit-override%E2%80%9D-define-DEF-VIRT-MAILBOX-LIMIT-OVERRIDE-0-extern-bool-var-virt-mailbox-limit-override-define-VAR-VIRT-MAILDIR-EXTENDED-%E2%80%9Cvirtual-maildir-extended%E2%80%9D-define-DEF-VIRT-MAILDIR-EXTENDED-0-extern-bool-var-virt-maildir-extended-define-VAR-VIRT-OVERQUOTA-BOUNCE-%E2%80%9Cvirtual-overquota-bounce%E2%80%9D-define-DEF-VIRT-OVERQUOTA-BOUNCE-0-extern-bool-var-virt-overquota-bounce-define-VAR-VIRT-MAILDIR-LIMIT-MESSAGE-%E2%80%9Cvirtual-maildir-limit-message%E2%80%9D-define-DEF-VIRT-MAILDIR-LIMIT-MESSAGE-%E2%80%9CSorry-the-user%E2%80%99s-maildir-has-overdrawn-his-diskspace-quota-please-try-again-later-%E2%80%9D-extern-char-var-virt-maildir-limit-message-define-VAR-VIRT-MAILDIR-LIMIT-MESSAGE-MAPS-%E2%80%9Cvirtual-maildir-limit-message-maps%E2%80%9D-define-DEF-VIRT-MAILDIR-LIMIT-MESSAGE-MAPS-%E2%80%9C%E2%80%9D-extern-char-var-virt-maildir-limit-message-maps-define-VAR-VIRT-MAILDIR-SUFFIX-%E2%80%9Cvirtual-maildir-suffix%E2%80%9D-define-DEF-VIRT-MAILDIR-SUFFIX-%E2%80%9C%E2%80%9D-extern-char-var-virt-maildir-suffix-define-VAR-VIRT-TRASH-COUNT-%E2%80%9Cvirtual-trash-count%E2%80%9D-define-DEF-VIRT-TRASH-COUNT-0-extern-bool-var-virt-trash-count-define-VAR-VIRT-TRASH-NAME-%E2%80%9Cvirtual-trash-name%E2%80%9D-define-DEF-VIRT-TRASH-NAME-%E2%80%9C-Trash%E2%80%9D-extern-char-var-virt-trash-name-define-VAR-VIRT-MAILDIR-FILTER-%E2%80%9Cvirtual-maildir-filter%E2%80%9D-define-DEF-VIRT-MAILDIR-FILTER-0-extern-bool-var-virt-maildir-filter-define-VAR-VIRT-MAILDIR-FILTER-MAPS-%E2%80%9Cvirtual-maildir-filter-maps%E2%80%9D-define-DEF-VIRT-MAILDIR-FILTER-MAPS-%E2%80%9C%E2%80%9D-extern-char-var-virt-maildir-filter-maps-define-VAR-VIRT-MINUID%E2%80%9Cvirtual-minimum-uid%E2%80%9D-define-DEF-VIRT-MINUID100-extern-int-var-virt-minimum-uid-diff-uNr-postfix-2-10-0-orig-src-util-file-limit-c-postfix-2-10-0-src-util-file-limit-c%E2%80%94-postfix-2-10-0-orig-src-util-file-limit-c2003-10-22-20-48-36-000000000-0200-postfix-2-10-0-src-util-file-limit-c2013-06-07-13-21-22-839143270-0200-85-7-85-11-else-struct-rlimit-rlim-rlim-rlim-cur-rlim-rlim-max-limit-rlim-max-can-only-be-changed-by-root-if-getrlimit-RLIMIT-FSIZE-rlim-0-msg-fatal-%E2%80%9Cgetrlimit-m%E2%80%9D-rlim-rlim-cur-limit-if-setrlimit-RLIMIT-FSIZE-rlim-0-msg-fatal-%E2%80%9Csetrlimit-m%E2%80%9D-ifdef-SIGXFSZdiff-uNr-postfix-2-10-0-orig-src-virtual-mailbox-c-postfix-2-10-0-src-virtual-mailbox-c%E2%80%94-postfix-2-10-0-orig-src-virtual-mailbox-c2011-12-24-03-13-32-000000000-0100-postfix-2-10-0-src-virtual-mailbox-c2013-06-07-13-23-03-044139705-0200-52-6-52-7-include-include-include-include-Global-library-70-6-71-70-define-YES1-define-NO0-change-mailbox-limit-change-limit-for-mailbox-file-static-int-change-mailbox-limit-LOCAL-STATE-state-USER-ATTR-usr-attr-char-myname-%E2%80%9Cchange-mailbox-limit%E2%80%9D-const-char-limit-res-long-n-0-int-status-NO-Look-up-the-virtual-mailbox-limit-size-for-this-user-Fall-back-to-virtual-mailbox-limit-in-case-lookup-failed-If-virtual-mailbox-limit-size-is-negative-fall-back-to-virtual-mailbox-limit-If-it%E2%80%99s-0-set-the-mailbox-limit-to-0-which-means-unlimited-If-it%E2%80%99s-more-than-0-positive-int-check-if-the-value-is-smaller-than-the-maximum-message-size-if-it-is-and-the-virtual-mailbox-limit-can%E2%80%99t-be-overridden-fall-back-to-virtual-mailbox-limit-and-warn-the-user-else-use-the-value-directly-as-the-mailbox-limit-if-var-virt-mailbox-limit-maps-0-limit-res-mail-addr-find-virtual-mailbox-limit-maps-state-msg-attr-user-char-NULL-0-n-atol-limit-res-if-n-0-if-n-var-message-limit-var-virt-mailbox-limit-override-set-file-limit-var-virt-mailbox-limit-status-NO-msg-warn-%E2%80%9C-s-recipient-s-virtual-mailbox-limit-is-%E2%80%9C-%E2%80%9Csmaller-than-s-in-s-falling-back-to-s%E2%80%9D-myname-state-msg-attr-user-VAR-MESSAGE-LIMIT-virtual-mailbox-limit-maps-title-VAR-VIRT-MAILBOX-LIMIT-else-set-file-limit-off-t-n-status-YES-if-msg-verbose-msg-info-%E2%80%9C-s-set-virtual-mailbox-limit-size-for-s-to-ld%E2%80%9D-myname-usr-attr-mailbox-n-else-if-n-0-set-file-limit-OFF-T-MAX-status-YES-if-msg-verbose-msg-info-%E2%80%9C-s-set-virtual-mailbox-limit-size-for-s-to-ld%E2%80%9D-myname-usr-attr-mailbox-OFF-T-MAX-else-Invalid-limit-size-negative-Use-default-virtual-mailbox-limit-set-file-limit-var-virt-mailbox-limit-status-NO-else-There-is-no-limit-in-the-maps-Use-default-virtual-mailbox-limit-set-file-limit-var-virt-mailbox-limit-status-NO-return-status-deliver-mailbox-file-deliver-to-recipient-mailbox-static-int-deliver-mailbox-file-LOCAL-STATE-state-USER-ATTR-usr-attr-80-7-145-6-int-mail-copy-status-int-deliver-status-int-copy-flags-long-end-struct-stat-st-132-7-196-7-msg-warn-%E2%80%9Cspecify-s-no-to-ignore-mailbox-ownership-mismatch%E2%80%9D-VAR-STRICT-MBOX-OWNER-else-end-vstream-fseek-mp-fp-off-t-0-SEEK-END-vstream-fseek-mp-fp-off-t-0-SEEK-END-mail-copy-status-mail-copy-COPY-ATTR-state-msg-attr-mp-fp-copy-flags-%E2%80%9C-n%E2%80%9D-why-213-62-277-72-Look-up-the-mailbox-owner-rights-Defer-in-case-of-trouble-uid-res-mail-addr-find-virtual-uid-maps-state-msg-attr-user-IGNORE-EXTENSION-if-uid-res-0-msg-warn-%E2%80%9Crecipient-s-not-found-in-s%E2%80%9D-state-msg-attr-user-virtual-uid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-IGNORE-EXTENSION-if-uid-res-mail-addr-find-virtual-uid-maps-state-msg-attr-user-char-0-0-if-uid-res-maps-find-virtual-uid-maps-strchr-state-msg-attr-user-%E2%80%98-%E2%80%99-DICT-FLAG-FIXED-0-msg-warn-%E2%80%9Crecipient-s-not-found-in-s%E2%80%9D-state-msg-attr-user-virtual-uid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-if-n-atol-uid-res-var-virt-minimum-uid-msg-warn-%E2%80%9Crecipient-s-bad-uid-s-in-s%E2%80%9D-state-msg-attr-user-uid-res-virtual-uid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-msg-warn-%E2%80%9Crecipient-s-bad-uid-s-in-s%E2%80%9D-state-msg-attr-user-uid-res-virtual-uid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-usr-attr-uid-uid-t-n-Look-up-the-mailbox-group-rights-Defer-in-case-of-trouble-gid-res-mail-addr-find-virtual-gid-maps-state-msg-attr-user-IGNORE-EXTENSION-if-gid-res-0-msg-warn-%E2%80%9Crecipient-s-not-found-in-s%E2%80%9D-state-msg-attr-user-virtual-gid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-IGNORE-EXTENSION-if-gid-res-mail-addr-find-virtual-gid-maps-state-msg-attr-user-char-0-0-if-gid-res-maps-find-virtual-gid-maps-strchr-state-msg-attr-user-%E2%80%98-%E2%80%99-DICT-FLAG-FIXED-0-msg-warn-%E2%80%9Crecipient-s-not-found-in-s%E2%80%9D-state-msg-attr-user-virtual-gid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-if-n-atol-gid-res-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-msg-warn-%E2%80%9Crecipient-s-bad-gid-s-in-s%E2%80%9D-state-msg-attr-user-gid-res-virtual-gid-maps-title-dsb-simple-why-%E2%80%9C4-3-5%E2%80%9D-%E2%80%9Cmail-system-configuration-error%E2%80%9D-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-usr-attr-gid-gid-t-n-if-msg-verbose-msg-info-%E2%80%9C-s-d-set-user-attr-s-uid-u-gid-u%E2%80%9D-myname-state-level-usr-attr-mailbox-unsigned-usr-attr-uid-unsigned-usr-attr-gid-msg-info-%E2%80%9C-s-d-set-user-attr-s-uid-u-gid-u%E2%80%9D-myname-state-level-usr-attr-mailbox-unsigned-usr-attr-uid-unsigned-usr-attr-gid-Deliver-to-mailbox-or-to-maildir-define-LAST-CHAR-s-s-strlen-s-1-if-LAST-CHAR-usr-attr-mailbox-%E2%80%98-%E2%80%98-statusp-deliver-maildir-state-usr-attr-else-statusp-deliver-mailbox-file-state-usr-attr-if-LAST-CHAR-usr-attr-mailbox-%E2%80%98-%E2%80%98-statusp-deliver-maildir-state-usr-attr-else-int-changed-limit-changed-limit-change-mailbox-limit-state-usr-attr-statusp-deliver-mailbox-file-state-usr-attr-if-changed-limit-set-file-limit-var-virt-mailbox-limit-Cleanup-diff-uNr-postfix-2-10-0-orig-src-virtual-maildir-c-postfix-2-10-0-src-virtual-maildir-c%E2%80%94-postfix-2-10-0-orig-src-virtual-maildir-c2012-01-25-01-41-08-000000000-0100-postfix-2-10-0-src-virtual-maildir-c2013-06-07-13-21-22-840143270-0200-64-28-64-420-include-include-Patch-library-include-opendir-3-stat-2-include-stat-2-include-opendir-3-include-stat-2-include-atol-3-include-strrchr-3-include-include-include-include-include-include-include-Application-specific-include-%E2%80%9Cvirtual-h%E2%80%9D-deliver-maildir-delivery-to-maildir-style-mailbox-Maildirsize-maximal-size-define-SIZEFILE-MAX-5120-Chris-Stratford-x63-x68-114-x69-x73-115-64-112-x69-x70-x65-120-x2e-x6e-x65-116-Read-the-maildirsize-file-to-get-quota-info-Arguments-dirname-the-maildir-countptr-number-of-messages-Returns-the-size-of-all-mails-as-read-from-maildirsize-zero-if-it-couldn%E2%80%99t-read-the-file-static-long-read-maildirsize-char-filename-long-sumptr-long-countptr-char-myname-%E2%80%9Cread-maildirsize%E2%80%9D-struct-stat-statbuf-VSTREAM-sizefile-char-p-int-len-first-long-sum-0-count-0-ret-value-1-if-msg-verbose-msg-info-%E2%80%9C-s-we-will-use-sizefile-%E2%80%98-s%E2%80%99%E2%80%9D-myname-filename-sizefile-vstream-fopen-filename-O-RDONLY-0-if-sizefile-if-msg-verbose-msg-info-%E2%80%9C-s-cannot-open-s-m-maybe-file-does-not-exist-%E2%80%9D-myname-filename-return-1-else-if-stat-filename-statbuf-0-statbuf-st-size-SIZEFILE-MAX-if-sizefile-vstream-fclose-sizefile-unlink-filename-if-msg-verbose-msg-info-%E2%80%9C-s-stat-returned-0-or-filesize-SIZEFILE-MAX-filename-s-filesize-ld-%E2%80%9D-myname-filename-statbuf-st-size-return-1-VSTRING-sizebuf-vstring-alloc-SIZEFILE-MAX-len-vstream-fread-sizefile-STR-sizebuf-SIZEFILE-MAX-p-STR-sizebuf-p-len-%E2%80%98-0%E2%80%99-first-1-while-p-long-n-0-c-0-char-q-p-while-p-if-p-%E2%80%98-n%E2%80%99-p-1-0-break-if-first-first-0-continue-if-sscanf-q-%E2%80%9C-ld-ld%E2%80%9D-n-c-2-sum-n-count-c-if-msg-verbose-msg-info-%E2%80%9C-s-we-read-line-%E2%80%98-s%E2%80%99-totals-sum-ld-count-ld%E2%80%9D-myname-q-sum-count-else-vstream-fclose-sizefile-unlink-filename-msg-warn-%E2%80%9C-s-invalid-line-%E2%80%98-s%E2%80%99-found-in-s-removing-maildirsize-file%E2%80%9D-myname-q-filename-vstring-free-sizebuf-return-1-countptr-count-sumptr-sum-if-sum-0-count-0-sum-0-count-0-sum-0-count-0-if-msg-verbose-msg-info-%E2%80%9C-s-we-will-return-1-and-unlink-s-because-file-count-or-sum-is-n-%E2%80%93o-if-o-%E2%80%98-%E2%80%98-break-if-o-%E2%80%98-%E2%80%99-o-1-%E2%80%98S%E2%80%99-o-2-%E2%80%98-%E2%80%99-yes-1-o-3-break-if-yes-long-s-0-while-o-%E2%80%980%E2%80%99-o-d-name-long-tmpsum-0-VSTRING-buffer-do-not-count-dot-a-double-dot-dirs-if-strcmp-name-%E2%80%9C-%E2%80%9D-0-strcmp-name-%E2%80%9C-%E2%80%9D-0-continue-do-not-count-if-this-is-the-trash-subdir-and-if-we-should-NOT-count-it-else-if-var-virt-trash-count-0-strcmp-name-var-virt-trash-name-0-continue-Here-comes-the-real-logic-behind-this-function-Optimized-to-be-the-most-efficient-possible-depending-on-the-settings-given-See-above-for-a-more-detailed-description-if-var-virt-mailbox-limit-inbox-if-var-virt-maildir-extended-tmpsum-maildir-parsequota-name-sum-tmpsum-countptr-else-buffer-vstring-alloc-1024-vstring-sprintf-buffer-%E2%80%9C-s-s%E2%80%9D-dirname-name-if-stat-STR-buffer-statbuf-0-vstring-free-buffer-continue-if-statbuf-st-mode-S-IFREG-0-sum-long-statbuf-st-size-countptr-vstring-free-buffer-else-buffer-vstring-alloc-1024-vstring-sprintf-buffer-%E2%80%9C-s-s%E2%80%9D-dirname-name-if-stat-STR-buffer-statbuf-0-vstring-free-buffer-continue-if-statbuf-st-mode-S-IFREG-0-if-strcmp-dirname-strlen-dirname-3-%E2%80%9Cnew%E2%80%9D-0-strcmp-dirname-strlen-dirname-3-%E2%80%9Ccur%E2%80%9D-0-strcmp-dirname-strlen-dirname-3-%E2%80%9Ctmp%E2%80%9D-0-sum-long-statbuf-st-size-countptr-else-if-statbuf-st-mode-S-IFDIR-0-sum-check-dir-size-STR-buffer-countptr-vstring-free-buffer-closedir-dir-int-deliver-maildir-LOCAL-STATE-state-USER-ATTR-usr-attr-if-msg-verbose-msg-info-%E2%80%9C-s-full-scan-done-dir-s-sum-ld-count-ld%E2%80%9D-myname-dirname-sum-countptr-return-sum-Cut-all-occurrences-of-pattern-from-string-static-char-strcut-char-str-const-char-pat-char-ptr-loc-ret-ret-str-loc-str-No-match-return-original-string-if-strstr-loc-pat-return-str-while-loc-ptr-strstr-loc-pat-while-loc-ptr-str-loc-loc-strlen-pat-while-loc-str-loc-str-0-return-ret-Check-if-maildirfilter-file-is-up-to-date-compared-to-SQL-re-write-it-if-not-static-long-sql2file-char-filename-char-user-char-myname-%E2%80%9Csql2file%E2%80%9D-char-filter-sqlres-char-filter-fileres-128-long-sqlmtime-0-filemtime-0-retval-0-int-filterfile-size-sqlres-i-struct-stat-statbuf-if-var-virt-maildir-filter-maps-0-filter-sqlres-char-mymalloc-16000-filter-sqlres-char-mail-addr-find-virtual-maildir-filter-maps-user-char-0-if-filter-sqlres-strcut-filter-sqlres-%E2%80%9C-r%E2%80%9D-if-filter-sqlres-0-%E2%80%98-%E2%80%99-filter-sqlres-1-%E2%80%98-%E2%80%98-filter-sqlres-2-%E2%80%98M%E2%80%99-size-sqlres-strlen-filter-sqlres-for-i-4-i-flags-dsb-simple-why-%E2%80%9C2-0-0%E2%80%9D-%E2%80%9Cdelivers-to-maildir%E2%80%9D-return-sent-BOUNCE-FLAGS-state-request-SENT-ATTR-state-msg-attr-dsb-simple-why-%E2%80%9C2-0-0%E2%80%9D-%E2%80%9Cdelivers-to-maildir%E2%80%9D-return-sent-BOUNCE-FLAGS-state-request-SENT-ATTR-state-msg-attr-110-18-501-116-attribute-to-reflect-the-final-recipient-if-vstream-fseek-state-msg-attr-fp-state-msg-attr-offset-SEEK-SET-0-msg-fatal-%E2%80%9Cseek-message-file-s-m%E2%80%9D-VSTREAM-PATH-state-msg-attr-fp-msg-fatal-%E2%80%9Cseek-message-file-s-m%E2%80%9D-VSTREAM-PATH-state-msg-attr-fp-state-msg-attr-delivered-state-msg-attr-rcpt-address-mail-copy-status-MAIL-COPY-STAT-WRITE-buf-vstring-alloc-100-copy-flags-MAIL-COPY-TOFILE-MAIL-COPY-RETURN-PATH-MAIL-COPY-DELIVERED-MAIL-COPY-ORIG-RCPT-copy-flags-MAIL-COPY-TOFILE-MAIL-COPY-RETURN-PATH-MAIL-COPY-DELIVERED-MAIL-COPY-ORIG-RCPT-newdir-concatenate-usr-attr-mailbox-%E2%80%9Cnew-%E2%80%9C-char-0-tmpdir-concatenate-usr-attr-mailbox-%E2%80%9Ctmp-%E2%80%9C-char-0-curdir-concatenate-usr-attr-mailbox-%E2%80%9Ccur-%E2%80%9C-char-0-Concatenate-the-maildir-suffix-if-set-if-var-virt-maildir-suffix-0-newdir-concatenate-usr-attr-mailbox-%E2%80%9Cnew-%E2%80%9C-char-0-tmpdir-concatenate-usr-attr-mailbox-%E2%80%9Ctmp-%E2%80%9C-char-0-curdir-concatenate-usr-attr-mailbox-%E2%80%9Ccur-%E2%80%9C-char-0-else-newdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-tmpdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-curdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-newdir-concatenate-newdir-%E2%80%9Cnew-%E2%80%9C-char-0-tmpdir-concatenate-tmpdir-%E2%80%9Ctmp-%E2%80%9C-char-0-curdir-concatenate-curdir-%E2%80%9Ccur-%E2%80%9C-char-0-get-the-sizefilename-no-matter-if-we-use-var-virt-maildir-extended-if-var-virt-maildir-suffix-0-sizefilename-concatenate-usr-attr-mailbox-%E2%80%9Cmaildirsize%E2%80%9D-char-0-else-sizefilename-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-sizefilename-concatenate-sizefilename-%E2%80%9Cmaildirsize%E2%80%9D-char-0-Look-up-the-virtual-maildir-limit-size-for-this-user-Fall-back-to-virtual-mailbox-limit-in-case-lookup-failed-If-virtual-maildir-limit-size-is-negative-fall-back-to-virtual-mailbox-limit-If-it%E2%80%99s-0-set-the-mailbox-limit-to-0-which-means-unlimited-If-it%E2%80%99s-more-than-0-positive-int-check-if-the-value-is-smaller-than-the-maximum-message-size-if-it-is-and-the-virtual-maildir-limit-can%E2%80%99t-be-overridden-fall-back-to-virtual-mailbox-limit-and-warn-the-user-else-use-the-value-directly-as-the-maildir-limit-if-var-virt-mailbox-limit-maps-0-limit-res-mail-addr-find-virtual-mailbox-limit-maps-state-msg-attr-user-char-NULL-0-n-atol-limit-res-if-n-0-if-n-var-message-limit-var-virt-mailbox-limit-override-n-var-virt-mailbox-limit-msg-warn-%E2%80%9C-s-recipient-s-virtual-maildir-limit-is-smaller-than-s-in-s-falling-back-to-s%E2%80%9D-myname-state-msg-attr-user-VAR-MESSAGE-LIMIT-virtual-mailbox-limit-maps-title-VAR-VIRT-MAILBOX-LIMIT-else-if-msg-verbose-msg-info-%E2%80%9C-s-set-virtual-maildir-limit-size-for-s-to-ld%E2%80%9D-myname-usr-attr-mailbox-n-else-if-n-0-if-msg-verbose-msg-info-%E2%80%9C-s-set-virtual-maildir-limit-size-for-s-to-ld%E2%80%9D-myname-usr-attr-mailbox-n-else-if-msg-verbose-msg-info-%E2%80%9C-s-quota-is-negative-ld-using-default-virtual-mailbox-limit-ld-%E2%80%9D-myname-n-var-virt-mailbox-limit-Invalid-limit-size-negative-Use-default-virtual-mailbox-limit-n-var-virt-mailbox-limit-else-if-msg-verbose-msg-info-%E2%80%9C-s-no-limit-found-in-the-maps-using-default-virtual-mailbox-limit-ld-%E2%80%9D-myname-var-virt-mailbox-limit-There-is-no-limit-in-the-maps-Use-default-virtual-mailbox-limit-n-var-virt-mailbox-limit-If-there-should-is-a-quota-on-maildir-generaly-check-it-before-delivering-the-mail-if-n-0-set-eugid-usr-attr-uid-usr-attr-gid-try-to-read-the-quota-from-maildirsize-file-Returned-values-by-read-maildirsize-x-0-something-failed-x-0-reading-successfully-finished-sum-si-returned-so-sum-size-of-Maildir-was-0-or-more-if-var-virt-mailbox-limit-inbox-var-virt-maildir-extended-read-mds-read-maildirsize-sizefilename-saved-size-saved-count-0-if-msg-verbose-msg-info-%E2%80%9C-s-maildirsize-used-s-sum-ld-count-ld%E2%80%9D-myname-sizefilename-saved-size-saved-count-else-if-msg-verbose-msg-info-%E2%80%9C-s-We-will-recount-the-quota-var-virt-mailbox-limit-ld-var-virt-maildir-extended-d-read-maildirsize-d-%E2%80%9D-myname-var-virt-mailbox-limit-var-virt-maildir-extended-read-mds-sanity-saved-size-0-saved-count-0-if-var-virt-mailbox-limit-inbox-Check-Inbox-only-new-cur-and-tmp-dirs-saved-size-check-dir-size-newdir-saved-count-saved-size-check-dir-size-curdir-saved-count-saved-size-check-dir-size-tmpdir-saved-count-else-Check-all-boxes-saved-size-check-dir-size-usr-attr-mailbox-saved-count-set-eugid-var-owner-uid-var-owner-gid-Create-and-write-the-file-as-the-recipient-so-that-file-quota-work-Create-any-missing-directories-on-the-fly-The-file-name-is-chosen-175-46-664-288-%E2%80%A6-set-eugid-usr-attr-uid-usr-attr-gid-vstring-sprintf-buf-%E2%80%9C-lu-P-d-s%E2%80%9D-unsigned-long-starttime-tv-sec-var-pid-get-hostname-vstring-sprintf-buf-%E2%80%9C-lu-P-d-s%E2%80%9D-unsigned-long-starttime-tv-sec-var-pid-get-hostname-tmpfile-concatenate-tmpdir-STR-buf-char-0-newfile-0-bkpnewfile-0-if-dst-vstream-fopen-tmpfile-O-WRONLY-O-CREAT-O-EXCL-0600-0-errno-ENOENT-make-dirs-tmpdir-0700-0-dst-vstream-fopen-tmpfile-O-WRONLY-O-CREAT-O-EXCL-0600-0-dsb-simple-why-mbox-dsn-errno-%E2%80%9C4-2-0%E2%80%9D-%E2%80%9Ccreate-maildir-file-s-m%E2%80%9D-tmpfile-else-if-fstat-vstream-fileno-dst-st-0"><span class="toc-text">diff -uNr postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README— postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README	1970-01-01 01:00:00.000000000 +0100+++ postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README	2013-06-07 13:21:22.837143270 +0200@@ -0,0 +1,10 @@+Postfix VDA patch for maildir++ quota support by+    Anderson Nadal andernadal@gmail.com+    Tomas Macek maca02@atlas.cz+    Lucca Longinotti++See VDA patch official website http:&#x2F;&#x2F;vda.sf.net for instructions+howto patch the Postfix’s sourcetree and configure the options+provided by this patch.++diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;global&#x2F;mail_params.h postfix-2.10.0&#x2F;src&#x2F;global&#x2F;mail_params.h— postfix-2.10.0.orig&#x2F;src&#x2F;global&#x2F;mail_params.h	2013-02-03 19:22:21.000000000 +0100+++ postfix-2.10.0&#x2F;src&#x2F;global&#x2F;mail_params.h	2013-06-07 13:21:22.838143270 +0200@@ -2367,6 +2367,54 @@ #define DEF_VIRT_GID_MAPS		“” extern char *var_virt_gid_maps;+#define VAR_VIRT_MAILBOX_LIMIT_MAPS     “virtual_mailbox_limit_maps”+#define DEF_VIRT_MAILBOX_LIMIT_MAPS     “”+extern char *var_virt_mailbox_limit_maps;++#define VAR_VIRT_MAILBOX_LIMIT_INBOX    “virtual_mailbox_limit_inbox”+#define DEF_VIRT_MAILBOX_LIMIT_INBOX    0+extern bool var_virt_mailbox_limit_inbox;++#define VAR_VIRT_MAILBOX_LIMIT_OVERRIDE “virtual_mailbox_limit_override”+#define DEF_VIRT_MAILBOX_LIMIT_OVERRIDE 0+extern bool var_virt_mailbox_limit_override;++#define VAR_VIRT_MAILDIR_EXTENDED       “virtual_maildir_extended”+#define DEF_VIRT_MAILDIR_EXTENDED       0+extern bool var_virt_maildir_extended;++#define VAR_VIRT_OVERQUOTA_BOUNCE       “virtual_overquota_bounce”+#define DEF_VIRT_OVERQUOTA_BOUNCE       0+extern bool var_virt_overquota_bounce;++#define VAR_VIRT_MAILDIR_LIMIT_MESSAGE  “virtual_maildir_limit_message”+#define DEF_VIRT_MAILDIR_LIMIT_MESSAGE  “Sorry, the user’s maildir has overdrawn his diskspace quota, please try again later.”+extern char *var_virt_maildir_limit_message;++#define VAR_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS “virtual_maildir_limit_message_maps”+#define DEF_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS “”+extern char *var_virt_maildir_limit_message_maps;++#define VAR_VIRT_MAILDIR_SUFFIX         “virtual_maildir_suffix”+#define DEF_VIRT_MAILDIR_SUFFIX         “”+extern char *var_virt_maildir_suffix;++#define VAR_VIRT_TRASH_COUNT            “virtual_trash_count”+#define DEF_VIRT_TRASH_COUNT            0+extern bool var_virt_trash_count;++#define VAR_VIRT_TRASH_NAME             “virtual_trash_name”+#define DEF_VIRT_TRASH_NAME             “.Trash”+extern char *var_virt_trash_name;++#define VAR_VIRT_MAILDIR_FILTER         “virtual_maildir_filter”+#define DEF_VIRT_MAILDIR_FILTER         0+extern bool var_virt_maildir_filter;++#define VAR_VIRT_MAILDIR_FILTER_MAPS    “virtual_maildir_filter_maps”+#define DEF_VIRT_MAILDIR_FILTER_MAPS    “”+extern char var_virt_maildir_filter_maps;+ #define VAR_VIRT_MINUID			“virtual_minimum_uid” #define DEF_VIRT_MINUID			100 extern int var_virt_minimum_uid;diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;util&#x2F;file_limit.c postfix-2.10.0&#x2F;src&#x2F;util&#x2F;file_limit.c— postfix-2.10.0.orig&#x2F;src&#x2F;util&#x2F;file_limit.c	2003-10-22 20:48:36.000000000 +0200+++ postfix-2.10.0&#x2F;src&#x2F;util&#x2F;file_limit.c	2013-06-07 13:21:22.839143270 +0200@@ -85,7 +85,11 @@ #else     struct rlimit rlim;-    rlim.rlim_cur &#x3D; rlim.rlim_max &#x3D; limit;+    &#x2F; rlim_max can only be changed by root. &#x2F;+    if (getrlimit(RLIMIT_FSIZE, &amp;rlim) &lt; 0)+        msg_fatal(“getrlimit: %m”);+    rlim.rlim_cur &#x3D; limit;+     if (setrlimit(RLIMIT_FSIZE, &amp;rlim) &lt; 0)     msg_fatal(“setrlimit: %m”); #ifdef SIGXFSZdiff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;mailbox.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;mailbox.c— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;mailbox.c	2011-12-24 03:13:32.000000000 +0100+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;mailbox.c	2013-06-07 13:23:03.044139705 +0200@@ -52,6 +52,7 @@ #include &lt;mymalloc.h&gt; #include &lt;stringops.h&gt; #include &lt;set_eugid.h&gt;+#include &lt;iostuff.h&gt; &#x2F; Global library. &#x2F;@@ -70,6 +71,70 @@ #define YES	1 #define NO	0+&#x2F; change_mailbox_limit - change limit for mailbox file *&#x2F;+static int change_mailbox_limit(LOCAL_STATE state, USER_ATTR usr_attr)+{+    char *myname &#x3D; “change_mailbox_limit”;+    const char limit_res;+    long n &#x3D; 0;+    int status &#x3D; NO;++    &#x2F;+     * Look up the virtual mailbox limit size for this user.+     * Fall back to virtual_mailbox_limit in case lookup failed.+     * If virtual mailbox limit size is negative, fall back to virtual_mailbox_limit.+     * If it’s 0, set the mailbox limit to 0, which means unlimited.+     * If it’s more than 0 (positive int), check if the value is smaller than the maximum message size,+     * if it is and the virtual mailbox limit can’t be overridden, fall back to virtual_mailbox_limit and+     * warn the user, else use the value directly as the mailbox limit.+     *&#x2F;+    if (*var_virt_mailbox_limit_maps !&#x3D; 0 &amp;&amp; (limit_res &#x3D; mail_addr_find(virtual_mailbox_limit_maps, state.msg_attr.user, (char **) NULL)) !&#x3D; 0) {+        n &#x3D; atol(limit_res);+        if (n &gt; 0) {+            if ((n &lt; var_message_limit) &amp;&amp; (!var_virt_mailbox_limit_override)) {+                set_file_limit(var_virt_mailbox_limit);+                status &#x3D; NO;++                msg_warn(“%s: recipient %s - virtual mailbox limit is “+                        “smaller than %s in %s - falling back to %s”,+                        myname,+                        state.msg_attr.user,+                        VAR_MESSAGE_LIMIT,+                        virtual_mailbox_limit_maps-&gt;title,+                        VAR_VIRT_MAILBOX_LIMIT);+            }+            else {+                set_file_limit((off_t) n);+                status &#x3D; YES;++                if (msg_verbose)+                    msg_info(“%s: set virtual mailbox limit size for %s to %ld”,+                            myname, usr_attr.mailbox, n);+            }+        }+        else if (n &#x3D;&#x3D; 0) {+                set_file_limit(OFF_T_MAX);+                status &#x3D; YES;++                if (msg_verbose)+                    msg_info(“%s: set virtual mailbox limit size for %s to %ld”,+                            myname, usr_attr.mailbox, OFF_T_MAX);+        }+        else {+            &#x2F;* Invalid limit size (negative). Use default virtual_mailbox_limit. &#x2F;+            set_file_limit(var_virt_mailbox_limit);+            status &#x3D; NO;+        }+    }+    else {+        &#x2F; There is no limit in the maps. Use default virtual_mailbox_limit. &#x2F;+        set_file_limit(var_virt_mailbox_limit);+        status &#x3D; NO;+    }++    return(status);+}+ &#x2F; deliver_mailbox_file - deliver to recipient mailbox &#x2F; static int deliver_mailbox_file(LOCAL_STATE state, USER_ATTR usr_attr)@@ -80,7 +145,6 @@     int     mail_copy_status;     int     deliver_status;     int     copy_flags;-    long    end;     struct stat st;     &#x2F;@@ -132,7 +196,7 @@         msg_warn(“specify &quot;%s &#x3D; no&quot; to ignore mailbox ownership mismatch”,              VAR_STRICT_MBOX_OWNER);     } else {-	    end &#x3D; vstream_fseek(mp-&gt;fp, (off_t) 0, SEEK_END);+	    vstream_fseek(mp-&gt;fp, (off_t) 0, SEEK_END);         mail_copy_status &#x3D; mail_copy(COPY_ATTR(state.msg_attr), mp-&gt;fp,                      copy_flags, “\n”, why);     }@@ -213,62 +277,72 @@      * Look up the mailbox owner rights. Defer in case of trouble.      *&#x2F;     uid_res &#x3D; mail_addr_find(virtual_uid_maps, state.msg_attr.user,-			     IGNORE_EXTENSION);-    if (uid_res &#x3D;&#x3D; 0) {-	msg_warn(“recipient %s: not found in %s”,-		 state.msg_attr.user, virtual_uid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+                            IGNORE_EXTENSION);++    if ((uid_res &#x3D; mail_addr_find(virtual_uid_maps, state.msg_attr.user, (char **) 0)) &#x3D;&#x3D; 0) {+        if ((uid_res &#x3D; maps_find(virtual_uid_maps, strchr(state.msg_attr.user, ‘@’), DICT_FLAG_FIXED)) &#x3D;&#x3D; 0) {+			msg_warn(“recipient %s: not found in %s”, state.msg_attr.user, virtual_uid_maps-&gt;title);+			dsb_simple(why, “4.3.5”, “mail system configuration error”);+			*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+			RETURN(YES);+        }     }+     if ((n &#x3D; atol(uid_res)) &lt; var_virt_minimum_uid) {-	msg_warn(“recipient %s: bad uid %s in %s”,-		 state.msg_attr.user, uid_res, virtual_uid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+		msg_warn(“recipient %s: bad uid %s in %s”, state.msg_attr.user, uid_res, virtual_uid_maps-&gt;title);+		dsb_simple(why, “4.3.5”, “mail system configuration error”);+		statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+		RETURN(YES);     }+     usr_attr.uid &#x3D; (uid_t) n;     &#x2F;      * Look up the mailbox group rights. Defer in case of trouble.      *&#x2F;     gid_res &#x3D; mail_addr_find(virtual_gid_maps, state.msg_attr.user,-			     IGNORE_EXTENSION);-    if (gid_res &#x3D;&#x3D; 0) {-	msg_warn(“recipient %s: not found in %s”,-		 state.msg_attr.user, virtual_gid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+                            IGNORE_EXTENSION);++    if ((gid_res &#x3D; mail_addr_find(virtual_gid_maps, state.msg_attr.user, (char **) 0)) &#x3D;&#x3D; 0) {+        if ((gid_res &#x3D; maps_find(virtual_gid_maps, strchr(state.msg_attr.user, ‘@’), DICT_FLAG_FIXED)) &#x3D;&#x3D; 0) {+			msg_warn(“recipient %s: not found in %s”, state.msg_attr.user, virtual_gid_maps-&gt;title);+			dsb_simple(why, “4.3.5”, “mail system configuration error”);+			*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+			RETURN(YES);+        }     }+     if ((n &#x3D; atol(gid_res)) &lt;&#x3D; 0) {-	msg_warn(“recipient %s: bad gid %s in %s”,-		 state.msg_attr.user, gid_res, virtual_gid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+		msg_warn(“recipient %s: bad gid %s in %s”, state.msg_attr.user, gid_res, virtual_gid_maps-&gt;title);+		dsb_simple(why, “4.3.5”, “mail system configuration error”);+		statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+		RETURN(YES);     }+     usr_attr.gid &#x3D; (gid_t) n;     if (msg_verbose)-	msg_info(“%s[%d]: set user_attr: %s, uid &#x3D; %u, gid &#x3D; %u”,-		 myname, state.level, usr_attr.mailbox,-		 (unsigned) usr_attr.uid, (unsigned) usr_attr.gid);+        msg_info(“%s[%d]: set user_attr: %s, uid &#x3D; %u, gid &#x3D; %u”,+                myname, state.level, usr_attr.mailbox,+                (unsigned) usr_attr.uid, (unsigned) usr_attr.gid);     &#x2F;      * Deliver to mailbox or to maildir.      *&#x2F; #define LAST_CHAR(s) (s[strlen(s) - 1])-    if (LAST_CHAR(usr_attr.mailbox) &#x3D;&#x3D; ‘&#x2F;‘)-	*statusp &#x3D; deliver_maildir(state, usr_attr);-    else-	*statusp &#x3D; deliver_mailbox_file(state, usr_attr);+    if (LAST_CHAR(usr_attr.mailbox) &#x3D;&#x3D; ‘&#x2F;‘) {+        statusp &#x3D; deliver_maildir(state, usr_attr);+    }+    else {+        int changed_limit;++        changed_limit &#x3D; change_mailbox_limit(state, usr_attr);+        statusp &#x3D; deliver_mailbox_file(state, usr_attr);++        if (changed_limit)+            set_file_limit(var_virt_mailbox_limit);+    }     &#x2F;      * Cleanup.diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;maildir.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;maildir.c— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;maildir.c	2012-01-25 01:41:08.000000000 +0100+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;maildir.c	2013-06-07 13:21:22.840143270 +0200@@ -64,28 +64,420 @@ #include &lt;mbox_open.h&gt; #include &lt;dsn_util.h&gt;+&#x2F; Patch library. &#x2F;++#include &lt;sys&#x2F;types.h&gt; &#x2F; opendir(3), stat(2) &#x2F;+#include &lt;sys&#x2F;stat.h&gt;  &#x2F; stat(2) &#x2F;+#include &lt;dirent.h&gt;    &#x2F; opendir(3) &#x2F;+#include &lt;unistd.h&gt;    &#x2F; stat(2) &#x2F;+#include &lt;stdlib.h&gt;    &#x2F; atol(3) &#x2F;+#include &lt;string.h&gt;    &#x2F; strrchr(3) &#x2F;+#include &lt;vstring_vstream.h&gt;+#include &lt;dict.h&gt;+#include &lt;dict_regexp.h&gt;+#include &lt;ctype.h&gt;+#include &lt;stdio.h&gt;+#include &lt;sys_defs.h&gt;+#include &lt;mail_addr_find.h&gt;+ &#x2F; Application-specific. &#x2F; #include “virtual.h”-&#x2F; deliver_maildir - delivery to maildir-style mailbox &#x2F;+&#x2F; Maildirsize maximal size. &#x2F;++#define SIZEFILE_MAX 5120++&#x2F;+ * Chris Stratford chriss@pipex.net+ * Read the maildirsize file to get quota info.+ *+ * Arguments:+ *  dirname: the maildir+ *  countptr: number of messages+ *+ * Returns the size of all mails as read from maildirsize,+ * zero if it couldn’t read the file.+ *&#x2F;+static long read_maildirsize(char *filename, long *sumptr, long *countptr)+{+    char *myname &#x3D; “read_maildirsize”;+    struct stat statbuf;+    VSTREAM *sizefile;+    char *p;+    int len, first;+    long sum &#x3D; 0, count &#x3D; 0, ret_value &#x3D; -1;++    if (msg_verbose)+	msg_info(“%s: we will use sizefile &#x3D; ‘%s’”, myname, filename);+	+    sizefile &#x3D; vstream_fopen(filename, O_RDONLY, 0);+    if (!sizefile) {+	if (msg_verbose)+	    msg_info(“%s: cannot open %s: %m (maybe file does not exist)”, myname, filename);+	+	return -1;+    } else if (stat(filename, &amp;statbuf) &lt; 0 || statbuf.st_size &gt; SIZEFILE_MAX) {+        if (sizefile) {+            vstream_fclose(sizefile);+            unlink(filename);+        }++        if (msg_verbose)+	    msg_info(“%s: stat() returned &lt; 0 or filesize &gt; SIZEFILE_MAX (filename &#x3D; %s, filesize &#x3D; %ld)”, myname, filename, statbuf.st_size);++        return -1;+    }++    VSTRING *sizebuf &#x3D; vstring_alloc(SIZEFILE_MAX);+    len &#x3D; vstream_fread(sizefile, STR(sizebuf), SIZEFILE_MAX);++    p &#x3D; STR(sizebuf);+    *(p + len) &#x3D; ‘\0’;+    first &#x3D; 1;++    while (*p) {+        long n &#x3D; 0, c &#x3D; 0;+        char *q &#x3D; p;++        while (*p) {+            if (p++ &#x3D;&#x3D; ‘\n’) {+                p[-1] &#x3D; 0;+                break;+            }+        }++        if (first) {+            first &#x3D; 0;+            continue;+        }++        if (sscanf(q, “%ld %ld”, &amp;n, &amp;c) &#x3D;&#x3D; 2) {+            sum +&#x3D; n;+            count +&#x3D; c;+            &#x2F; if (msg_verbose)+    		msg_info(“%s: we read line ‘%s’, totals: sum &#x3D; %ld, count &#x3D; %ld”, myname, q, sum, count); *&#x2F;+        }+        else {+            vstream_fclose(sizefile);+            unlink(filename);+            msg_warn(“%s: invalid line ‘%s’ found in %s, removing maildirsize file”, myname, q, filename);+            vstring_free(sizebuf);++            return -1;+        }+    }++    *countptr &#x3D; count;+    *sumptr &#x3D; sum;++    if (sum &lt; 0 || count &lt; 0 || (sum &#x3D;&#x3D; 0 &amp;&amp; count !&#x3D; 0) || (sum !&#x3D; 0 &amp;&amp; count &#x3D;&#x3D; 0)) {+	if (msg_verbose) {+	    msg_info(“%s: we will return -1 and unlink %s, because file count or sum is &lt;&#x3D; 0 (sum &#x3D; %ld, count &#x3D; %ld)”, myname, filename, sum, count);+	}+	+	unlink(filename);+	ret_value &#x3D; -1;+    } else {+	if (msg_verbose)+	    msg_info(“%s: we will return Maildir size &#x3D; %ld, count &#x3D; %ld”, myname, *sumptr, *countptr);++	ret_value &#x3D; sum;	+    }++    vstream_fclose(sizefile);+    vstring_free(sizebuf);++    return ret_value;+}++&#x2F;*+ * Gives the size of the file according to the Maildir++ extension+ * present in the filename (code taken from courier-imap).+ *+ * Arguments:+ *  n: filename+ *+ * Returns the size given in “,S&#x3D;“ in the filename,+ * zero if it cannot find “,S&#x3D;“ in the filename.+ *&#x2F;+static long maildir_parsequota(const char *n)+{+    const char *o;+    int yes &#x3D; 0;++    if ((o &#x3D; strrchr(n, ‘&#x2F;‘)) &#x3D;&#x3D; 0)+        o &#x3D; n;++    for (; *o; o++) {+        if (*o &#x3D;&#x3D; ‘:’)+            break;+    }++    for (; o &gt;&#x3D; n; –o) {+        if (*o &#x3D;&#x3D; ‘&#x2F;‘)+            break;++        if (*o &#x3D;&#x3D; ‘,’ &amp;&amp; o[1] &#x3D;&#x3D; ‘S’ &amp;&amp; o[2] &#x3D;&#x3D; ‘&#x3D;’) {+            yes &#x3D; 1;+            o +&#x3D; 3;+            break;+        }+    }++    if (yes) {+        long s &#x3D; 0;++        while (*o &gt;&#x3D; ‘0’ &amp;&amp; *o &lt;&#x3D; ‘9’)+            s &#x3D; s*10 + (*o++ - ‘0’);++        return s;+    }++    return 0;+}++&#x2F;*+ * Computes quota usage for a directory (taken from exim).+ *+ * This function is called to determine the exact quota usage of a virtual+ * maildir box. To achieve maximum possible speed while doing this, it takes+ * advantage of the maildirsize file and the Maildir++ extensions to filenames,+ * when applicable and configured to be used. In all other cases it simply+ * stats all the files as needed to get the size information.+ *+ * Arguments:+ *  dirname: the name of the directory+ *  countptr: where to add the file count (because this function recurses)+ *+ * Returns the sum of the sizes of all measurable files,+ * zero if the directory could not be opened.+ *&#x2F;+static long check_dir_size(char *dirname, long *countptr)+{+    char *myname &#x3D; “check_dir_size”;+    DIR *dir;+    long sum &#x3D; 0;+    struct dirent *ent;+    struct stat statbuf;++    dir &#x3D; opendir(dirname);+    if (dir &#x3D;&#x3D; NULL) {+        if (make_dirs(dirname, 0700) &#x3D;&#x3D; 0) {    &#x2F;* Try to create the dirs. *&#x2F;+            dir &#x3D; opendir(dirname);             &#x2F;* Reopen the dir. *&#x2F;+            if (dir &#x3D;&#x3D; NULL) {+                msg_warn(“%s: cannot reopen directory: %s”, myname, dirname);+                return 0;+            }+        }+        else {+            msg_warn(“%s: cannot open directory: %s”, myname, dirname);+            return 0;+        }+    }++    while ((ent &#x3D; readdir(dir)) !&#x3D; NULL) {+        char *name &#x3D; ent-&gt;d_name;+        long tmpsum &#x3D; 0;+        VSTRING buffer;++	&#x2F; do not count dot a double-dot dirs &#x2F;+        if (strcmp(name, “.”) &#x3D;&#x3D; 0 || strcmp(name, “..”) &#x3D;&#x3D; 0)+            continue;+        &#x2F; do not count if this is the trash subdir and if we should NOT count it &#x2F;+	else if (var_virt_trash_count &#x3D;&#x3D; 0 &amp;&amp; strcmp(name, var_virt_trash_name) &#x3D;&#x3D; 0)+    	    continue;++        &#x2F;+         * Here comes the real logic behind this function.+         * Optimized to be the most efficient possible,+         * depending on the settings given.+         * See above for a more detailed description.+         *&#x2F;+        if (var_virt_mailbox_limit_inbox) {+            if (var_virt_maildir_extended &amp;&amp; (tmpsum &#x3D; maildir_parsequota(name))) {+                sum +&#x3D; tmpsum;+                (countptr)++;+            }+            else {+                buffer &#x3D; vstring_alloc(1024);+                vstring_sprintf(buffer, “%s&#x2F;%s”, dirname, name);++                if (stat(STR(buffer), &amp;statbuf) &lt; 0) {+                    vstring_free(buffer);+                    continue;+                }+                if ((statbuf.st_mode &amp; S_IFREG) !&#x3D; 0) {+                    sum +&#x3D; (long) statbuf.st_size;+                    (*countptr)++;+                }++                vstring_free(buffer);+            }+        }+        else {+            buffer &#x3D; vstring_alloc(1024);+            vstring_sprintf(buffer, “%s&#x2F;%s”, dirname, name);++            if (stat(STR(buffer), &amp;statbuf) &lt; 0) {+                vstring_free(buffer);+                continue;+            }+            if ((statbuf.st_mode &amp; S_IFREG) !&#x3D; 0) {+                if (strcmp(dirname + strlen(dirname) - 3, “new”) &#x3D;&#x3D; 0 || strcmp(dirname + strlen(dirname) - 3, “cur”) &#x3D;&#x3D; 0 || strcmp(dirname + strlen(dirname) - 3, “tmp”) &#x3D;&#x3D; 0) {+                    sum +&#x3D; (long) statbuf.st_size;+                    (*countptr)++;+                }+            }+            else if ((statbuf.st_mode &amp; S_IFDIR) !&#x3D; 0) {+                sum +&#x3D; check_dir_size(STR(buffer), countptr);+            }++            vstring_free(buffer);+        }+    }+    closedir(dir);-int     deliver_maildir(LOCAL_STATE state, USER_ATTR usr_attr)+    if (msg_verbose)+        msg_info(“%s: full scan done: dir&#x3D;%s sum&#x3D;%ld count&#x3D;%ld”, myname, dirname, sum, *countptr);++    return sum;+}++&#x2F;* Cut all occurrences of pattern from string. *&#x2F;+static char *strcut(char *str, const char *pat)+{+    char *ptr, *loc, *ret;+    ret &#x3D; str;+    loc &#x3D; str;++    &#x2F;* No match, return original string. *&#x2F;+    if (!strstr(loc, pat))+        return(str);++    while (*loc &amp;&amp; (ptr &#x3D; strstr(loc, pat))) {+        while (loc &lt; ptr)+            *str++ &#x3D; *loc++;+        loc +&#x3D; strlen(pat);+    }++    while (*loc)+        *str++ &#x3D; *loc++;++    *str &#x3D; 0;++    return(ret);+}++&#x2F;* Check if maildirfilter file is up-to-date compared to SQL, (re)write it if not. *&#x2F;+static long sql2file(char *filename, char *user)+{+    char *myname &#x3D; “sql2file”;+    char *filter_sqlres;+    char filter_fileres[128];+    long sqlmtime &#x3D; 0, filemtime &#x3D; 0, retval &#x3D; 0;+    int filterfile, size_sqlres, i;+    struct stat statbuf;++    if (*var_virt_maildir_filter_maps !&#x3D; 0) {+        filter_sqlres &#x3D; (char *) mymalloc(16000);+        filter_sqlres &#x3D; (char *) mail_addr_find(virtual_maildir_filter_maps, user, (char **) 0);++        if (filter_sqlres) {+            strcut(filter_sqlres, “\r”);+            if (filter_sqlres[0] &#x3D;&#x3D; ‘#’ &amp;&amp; filter_sqlres[1] &#x3D;&#x3D; ‘ ‘ &amp;&amp; filter_sqlres[2] &#x3D;&#x3D; ‘M’) {+                size_sqlres &#x3D; strlen(filter_sqlres);++                for (i &#x3D; 4; i &lt;&#x3D; size_sqlres; i++) {+                    if(filter_sqlres[i] &#x3D;&#x3D; ‘&#x2F;‘ &amp;&amp; filter_sqlres[i+1] &#x3D;&#x3D; ‘^’) {+                        filter_sqlres[i-1] &#x3D; ‘\n’;+                    }+                }++                filter_sqlres[(size_sqlres+1)] &#x3D; ‘\0’;++                sqlmtime &#x3D; atol(filter_sqlres+3);+                retval &#x3D; sqlmtime;++                filterfile &#x3D; open(filename, O_RDONLY, 0);+                if (filterfile) {+                    read(filterfile, (void *) filter_fileres, 127);+                    close(filterfile);++                    filemtime &#x3D; atol(filter_fileres+3);+                }++                if (msg_verbose)+                    msg_info(“%s: filter data: sql_size&#x3D;%li sql_mtime&#x3D;%ld file_mtime&#x3D;%ld”, myname, strlen(filter_sqlres), sqlmtime, filemtime);+            }+            if (sqlmtime !&#x3D; filemtime &amp;&amp; sqlmtime !&#x3D; 0) {+                if ((filterfile &#x3D; open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0640))) {+                    if (msg_verbose)+                        msg_info(“%s: updating filter file: %s”, myname, filename);+                    write(filterfile, filter_sqlres, strlen(filter_sqlres));+                    close(filterfile);+                }+                else {+                    msg_warn(“%s: can’t create filter file: %s”, myname, filename);+                    retval &#x3D; 0;+                }+            }+        }+    }+    else {+        if (stat(filename, &amp;statbuf) &#x3D;&#x3D; 0)+            retval &#x3D; (long) statbuf.st_mtime;+        if (msg_verbose)+            msg_info(“%s: processing filter file: file_mtime&#x3D;%ld”, myname, retval);+    }++    return retval;+}++&#x2F;* deliver_maildir - delivery to maildir-style mailbox *&#x2F;+int deliver_maildir(LOCAL_STATE state, USER_ATTR usr_attr) {     const char *myname &#x3D; “deliver_maildir”;-    char   *newdir;-    char   *tmpdir;-    char   *curdir;-    char   *tmpfile;-    char   *newfile;+    char    *newdir;+    char    *tmpdir;+    char    *curdir;+    char    *newfile;+    char    *tmpfile;     DSN_BUF *why &#x3D; state.msg_attr.why;     VSTRING *buf;     VSTREAM *dst;-    int     mail_copy_status;-    int     deliver_status;-    int     copy_flags;-    struct stat st;-    struct timeval starttime;+    int      mail_copy_status;+    int      deliver_status;+    int      copy_flags;+    struct   stat st;+    struct   timeval starttime;++    &#x2F;* Maildir Quota. *&#x2F;+    const char *limit_res;              &#x2F;* Limit from map. *&#x2F;+    char    *sizefilename &#x3D; (char *) 0; &#x2F;* Maildirsize file name. *&#x2F;+    VSTRING *filequota;                 &#x2F;* Quota setting from the maildirsize file. *&#x2F;+    VSTREAM *sizefile;                  &#x2F;* Maildirsize file handle. *&#x2F;+    long     n &#x3D; 0;                     &#x2F;* Limit in long integer format. *&#x2F;+    long     saved_count &#x3D; 0;           &#x2F;* The total number of files. *&#x2F;+    long     saved_size &#x3D; 0;            &#x2F;* The total quota of all files. *&#x2F;+    struct   stat mail_stat;            &#x2F;* To check the size of the mail to be written. *&#x2F;+    struct   stat sizefile_stat;        &#x2F;* To check the size of the maildirsize file. *&#x2F;+    time_t   tm;                        &#x2F;* To check the age of the maildirsize file. *&#x2F;++    &#x2F;* Maildir Filters. *&#x2F;+    const char *value, *cmd_text;       &#x2F;* Filter values. *&#x2F;+    char    *filtername;+    char    *header;+    char    *bkpnewfile;+    char    *mdffilename &#x3D; (char *) 0;  &#x2F;* Maildirfolder file name. *&#x2F;+    VSTRING *fltstr;+    VSTREAM *tmpfilter;+    VSTREAM *mdffile;                   &#x2F;* Maildirfolder file handle. *&#x2F;+    DICT    *FILTERS;+    long     sqlmtime;                  &#x2F;* Latest modification time from sql2file(). *&#x2F;+    int      cmd_len;+    int	    read_mds &#x3D; -1;		&#x2F;* read_maildirsize() returned value *&#x2F;+    struct   stat mdffile_stat;         &#x2F;* To check if the maildirfolder file exists. *&#x2F;     GETTIMEOFDAY(&amp;starttime);@@ -94,15 +486,14 @@      *&#x2F;     state.level++;     if (msg_verbose)-	MSG_LOG_STATE(myname, state);+	    MSG_LOG_STATE(myname, state);     &#x2F;*      * Don’t deliver trace-only requests.      *&#x2F;     if (DEL_REQ_TRACE_ONLY(state.request-&gt;flags)) {-	dsb_simple(why, “2.0.0”, “delivers to maildir”);-	return (sent(BOUNCE_FLAGS(state.request),-		     SENT_ATTR(state.msg_attr)));+        dsb_simple(why, “2.0.0”, “delivers to maildir”);+        return (sent(BOUNCE_FLAGS(state.request), SENT_ATTR(state.msg_attr)));     }     &#x2F;@@ -110,18 +501,116 @@      * attribute to reflect the final recipient.      &#x2F;     if (vstream_fseek(state.msg_attr.fp, state.msg_attr.offset, SEEK_SET) &lt; 0)-	msg_fatal(“seek message file %s: %m”, VSTREAM_PATH(state.msg_attr.fp));+        msg_fatal(“seek message file %s: %m”, VSTREAM_PATH(state.msg_attr.fp));     state.msg_attr.delivered &#x3D; state.msg_attr.rcpt.address;     mail_copy_status &#x3D; MAIL_COPY_STAT_WRITE;     buf &#x3D; vstring_alloc(100);-    copy_flags &#x3D; MAIL_COPY_TOFILE | MAIL_COPY_RETURN_PATH-	| MAIL_COPY_DELIVERED | MAIL_COPY_ORIG_RCPT;+    copy_flags &#x3D; MAIL_COPY_TOFILE | MAIL_COPY_RETURN_PATH | MAIL_COPY_DELIVERED | MAIL_COPY_ORIG_RCPT;-    newdir &#x3D; concatenate(usr_attr.mailbox, “new&#x2F;“, (char *) 0);-    tmpdir &#x3D; concatenate(usr_attr.mailbox, “tmp&#x2F;“, (char *) 0);-    curdir &#x3D; concatenate(usr_attr.mailbox, “cur&#x2F;“, (char *) 0);+    &#x2F;*+     * Concatenate the maildir suffix (if set).+     *&#x2F;+    if (*var_virt_maildir_suffix &#x3D;&#x3D; 0) {+        newdir &#x3D; concatenate(usr_attr.mailbox, “new&#x2F;“, (char *) 0);+        tmpdir &#x3D; concatenate(usr_attr.mailbox, “tmp&#x2F;“, (char *) 0);+        curdir &#x3D; concatenate(usr_attr.mailbox, “cur&#x2F;“, (char *) 0);+    }+    else {+        newdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        tmpdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        curdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        newdir &#x3D; concatenate(newdir, “new&#x2F;“, (char *) 0);+        tmpdir &#x3D; concatenate(tmpdir, “tmp&#x2F;“, (char *) 0);+        curdir &#x3D; concatenate(curdir, “cur&#x2F;“, (char *) 0);+    }+    &#x2F;* get the sizefilename, no matter if we use var_virt_maildir_extended *&#x2F;+    if (*var_virt_maildir_suffix &#x3D;&#x3D; 0) {+        sizefilename &#x3D; concatenate(usr_attr.mailbox, “maildirsize”, (char *) 0);+    } else {+        sizefilename &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        sizefilename &#x3D; concatenate(sizefilename, “maildirsize”, (char *) 0);+    }++    &#x2F;*+     * Look up the virtual maildir limit size for this user.+     * Fall back to virtual_mailbox_limit in case lookup failed.+     * If virtual maildir limit size is negative, fall back to virtual_mailbox_limit.+     * If it’s 0, set the mailbox limit to 0, which means unlimited.+     * If it’s more than 0 (positive int), check if the value is smaller than the maximum message size,+     * if it is and the virtual maildir limit can’t be overridden, fall back to virtual_mailbox_limit and+     * warn the user, else use the value directly as the maildir limit.+     *&#x2F;+    if (*var_virt_mailbox_limit_maps !&#x3D; 0 &amp;&amp; (limit_res &#x3D; mail_addr_find(virtual_mailbox_limit_maps, state.msg_attr.user, (char **) NULL)) !&#x3D; 0) {+        n &#x3D; atol(limit_res);+        if (n &gt; 0) {+            if ((n &lt; var_message_limit) &amp;&amp; (!var_virt_mailbox_limit_override)) {+                n &#x3D; var_virt_mailbox_limit;++                msg_warn(“%s: recipient %s - virtual maildir limit is smaller than %s in %s - falling back to %s”,+                        myname, state.msg_attr.user, VAR_MESSAGE_LIMIT, virtual_mailbox_limit_maps-&gt;title,+                        VAR_VIRT_MAILBOX_LIMIT);+            }+            else {+                if (msg_verbose)+                    msg_info(“%s: set virtual maildir limit size for %s to %ld”,+                            myname, usr_attr.mailbox, n);+            }+        }+        else if (n &#x3D;&#x3D; 0) {+                if (msg_verbose)+                    msg_info(“%s: set virtual maildir limit size for %s to %ld”,+                            myname, usr_attr.mailbox, n);+        }+        else {+	    if (msg_verbose)+		msg_info(“%s: quota is negative (%ld), using default virtual_mailbox_limit (%ld)”,+			    myname, n, var_virt_mailbox_limit);+            &#x2F; Invalid limit size (negative). Use default virtual_mailbox_limit. &#x2F;+            n &#x3D; var_virt_mailbox_limit;+        }+    }+    else {+	if (msg_verbose)+	    msg_info(“%s: no limit found in the maps, using default virtual_mailbox_limit (%ld)”,+			myname, var_virt_mailbox_limit);+        &#x2F; There is no limit in the maps. Use default virtual_mailbox_limit. &#x2F;+        n &#x3D; var_virt_mailbox_limit;+    }++    &#x2F; If there should is a quota on maildir generaly, check it before delivering the mail &#x2F;+    if (n !&#x3D; 0) {+        set_eugid(usr_attr.uid, usr_attr.gid);+	&#x2F; try to read the quota from maildirsize file. Returned values by read_maildirsize:+	x &lt; 0  &#x3D; something failed+	x &gt;&#x3D; 0 &#x3D; reading successfully finished - sum si returned, so sum size of Maildir was 0 or more &#x2F;+        if (!var_virt_mailbox_limit_inbox &amp;&amp; var_virt_maildir_extended &amp;&amp; (read_mds &#x3D; read_maildirsize(sizefilename, &amp;saved_size, &amp;saved_count)) &gt;&#x3D; 0) {+    	    if (msg_verbose)+        	msg_info(“%s: maildirsize used&#x3D;%s sum&#x3D;%ld count&#x3D;%ld”, myname, sizefilename, saved_size, saved_count);+	} else {+	    if (msg_verbose)+		msg_info(“%s: We will recount the quota (var_virt_mailbox_limit &#x3D; %ld, var_virt_maildir_extended &#x3D; %d, read_maildirsize &#x3D; %d)”,+			    myname, var_virt_mailbox_limit, var_virt_maildir_extended, read_mds);++	    &#x2F; sanity &#x2F;+	    saved_size &#x3D; 0;+	    saved_count &#x3D; 0;+	+    	    if (var_virt_mailbox_limit_inbox) {+        	&#x2F; Check Inbox only (new, cur and tmp dirs). &#x2F;+        	saved_size &#x3D; check_dir_size(newdir, &amp;saved_count);+        	saved_size +&#x3D; check_dir_size(curdir, &amp;saved_count);+        	saved_size +&#x3D; check_dir_size(tmpdir, &amp;saved_count);+    	    } else {+        	&#x2F; Check all boxes. &#x2F;+        	saved_size &#x3D; check_dir_size(usr_attr.mailbox, &amp;saved_count);+    	    }++    	    set_eugid(var_owner_uid, var_owner_gid);+    	}    	+    }+     &#x2F;      * Create and write the file as the recipient, so that file quota work.      * Create any missing directories on the fly. The file name is chosen@@ -175,46 +664,288 @@      * […]      *&#x2F;     set_eugid(usr_attr.uid, usr_attr.gid);-    vstring_sprintf(buf, “%lu.P%d.%s”,-		 (unsigned long) starttime.tv_sec, var_pid, get_hostname());+    vstring_sprintf(buf, “%lu.P%d.%s”, (unsigned long) starttime.tv_sec, var_pid, get_hostname());     tmpfile &#x3D; concatenate(tmpdir, STR(buf), (char *) 0);     newfile &#x3D; 0;+    bkpnewfile &#x3D; 0;     if ((dst &#x3D; vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) &#x3D;&#x3D; 0-	&amp;&amp; (errno !&#x3D; ENOENT-	    || make_dirs(tmpdir, 0700) &lt; 0-	    || (dst &#x3D; vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) &#x3D;&#x3D; 0)) {-	dsb_simple(why, mbox_dsn(errno, “4.2.0”),-		   “create maildir file %s: %m”, tmpfile);-    } else if (fstat(vstream_fileno(dst), &amp;st) &lt; 0) {</span></a></li></ol></div></div></widget>



<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" placeholder="站内搜索"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://pd.qq.com/s/77potx4h8" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cloud-1317067033.cos.ap-chengdu.myqcloud.com/images/QQ-2023-09-29.svg"/></a><a class="social" href="https://i.y.qq.com/n2/m/share/details/taoge.html?platform=11&appshare=android_qq&appversion=12070008&hosteuin=oinFoK4soe-lNn**&id=3144152480&ADTAG=wxfshare" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cloud-1317067033.cos.ap-chengdu.myqcloud.com/images/qq音乐-2023-09-29.svg"/></a><a class="social" href="https://www.cnblogs.com/mant" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cloud-1317067033.cos.ap-chengdu.myqcloud.com/images/linux-2023-09-29.svg"/></a><a class="social" href="https://alidocs.dingtalk.com/i/p/O5pXBPdVlgnMQG7Z" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cloud-1317067033.cos.ap-chengdu.myqcloud.com/images/钉钉-2023-09-29.svg"/></a></div></footer>

    </aside>
    <div class='l_main'>
      

      



<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a></div><div id="post-meta">发布于&nbsp;<time datetime="2023-09-28T05:27:17.771Z">2023-09-28</time></div></div>

<article class='md-text content post'>

<h2 id="diff-uNr-postfix-2-10-0-orig-README-FILES-VDA-README-postfix-2-10-0-README-FILES-VDA-README—-postfix-2-10-0-orig-README-FILES-VDA-README1970-01-01-01-00-00-000000000-0100-postfix-2-10-0-README-FILES-VDA-README2013-06-07-13-21-22-837143270-0200-0-0-1-10-Postfix-VDA-patch-for-maildir-quota-support-by-Anderson-Nadal-x61-x6e-x64-x65-x72-x6e-97-100-x61-x6c-x40-103-x6d-97-x69-108-x2e-99-x6f-x6d-Tomas-Macek-x6d-x61-x63-x61-x30-50-x40-97-116-x6c-x61-x73-46-x63-122-Lucca-Longinotti-See-VDA-patch-official-website-http-vda-sf-net-for-instructions-howto-patch-the-Postfix’s-sourcetree-and-configure-the-options-provided-by-this-patch-diff-uNr-postfix-2-10-0-orig-src-global-mail-params-h-postfix-2-10-0-src-global-mail-params-h—-postfix-2-10-0-orig-src-global-mail-params-h2013-02-03-19-22-21-000000000-0100-postfix-2-10-0-src-global-mail-params-h2013-06-07-13-21-22-838143270-0200-2367-6-2367-54-define-DEF-VIRT-GID-MAPS“”-extern-char-var-virt-gid-maps-define-VAR-VIRT-MAILBOX-LIMIT-MAPS-“virtual-mailbox-limit-maps”-define-DEF-VIRT-MAILBOX-LIMIT-MAPS-“”-extern-char-var-virt-mailbox-limit-maps-define-VAR-VIRT-MAILBOX-LIMIT-INBOX-“virtual-mailbox-limit-inbox”-define-DEF-VIRT-MAILBOX-LIMIT-INBOX-0-extern-bool-var-virt-mailbox-limit-inbox-define-VAR-VIRT-MAILBOX-LIMIT-OVERRIDE-“virtual-mailbox-limit-override”-define-DEF-VIRT-MAILBOX-LIMIT-OVERRIDE-0-extern-bool-var-virt-mailbox-limit-override-define-VAR-VIRT-MAILDIR-EXTENDED-“virtual-maildir-extended”-define-DEF-VIRT-MAILDIR-EXTENDED-0-extern-bool-var-virt-maildir-extended-define-VAR-VIRT-OVERQUOTA-BOUNCE-“virtual-overquota-bounce”-define-DEF-VIRT-OVERQUOTA-BOUNCE-0-extern-bool-var-virt-overquota-bounce-define-VAR-VIRT-MAILDIR-LIMIT-MESSAGE-“virtual-maildir-limit-message”-define-DEF-VIRT-MAILDIR-LIMIT-MESSAGE-“Sorry-the-user’s-maildir-has-overdrawn-his-diskspace-quota-please-try-again-later-”-extern-char-var-virt-maildir-limit-message-define-VAR-VIRT-MAILDIR-LIMIT-MESSAGE-MAPS-“virtual-maildir-limit-message-maps”-define-DEF-VIRT-MAILDIR-LIMIT-MESSAGE-MAPS-“”-extern-char-var-virt-maildir-limit-message-maps-define-VAR-VIRT-MAILDIR-SUFFIX-“virtual-maildir-suffix”-define-DEF-VIRT-MAILDIR-SUFFIX-“”-extern-char-var-virt-maildir-suffix-define-VAR-VIRT-TRASH-COUNT-“virtual-trash-count”-define-DEF-VIRT-TRASH-COUNT-0-extern-bool-var-virt-trash-count-define-VAR-VIRT-TRASH-NAME-“virtual-trash-name”-define-DEF-VIRT-TRASH-NAME-“-Trash”-extern-char-var-virt-trash-name-define-VAR-VIRT-MAILDIR-FILTER-“virtual-maildir-filter”-define-DEF-VIRT-MAILDIR-FILTER-0-extern-bool-var-virt-maildir-filter-define-VAR-VIRT-MAILDIR-FILTER-MAPS-“virtual-maildir-filter-maps”-define-DEF-VIRT-MAILDIR-FILTER-MAPS-“”-extern-char-var-virt-maildir-filter-maps-define-VAR-VIRT-MINUID“virtual-minimum-uid”-define-DEF-VIRT-MINUID100-extern-int-var-virt-minimum-uid-diff-uNr-postfix-2-10-0-orig-src-util-file-limit-c-postfix-2-10-0-src-util-file-limit-c—-postfix-2-10-0-orig-src-util-file-limit-c2003-10-22-20-48-36-000000000-0200-postfix-2-10-0-src-util-file-limit-c2013-06-07-13-21-22-839143270-0200-85-7-85-11-else-struct-rlimit-rlim-rlim-rlim-cur-rlim-rlim-max-limit-rlim-max-can-only-be-changed-by-root-if-getrlimit-RLIMIT-FSIZE-rlim-0-msg-fatal-“getrlimit-m”-rlim-rlim-cur-limit-if-setrlimit-RLIMIT-FSIZE-rlim-0-msg-fatal-“setrlimit-m”-ifdef-SIGXFSZdiff-uNr-postfix-2-10-0-orig-src-virtual-mailbox-c-postfix-2-10-0-src-virtual-mailbox-c—-postfix-2-10-0-orig-src-virtual-mailbox-c2011-12-24-03-13-32-000000000-0100-postfix-2-10-0-src-virtual-mailbox-c2013-06-07-13-23-03-044139705-0200-52-6-52-7-include-include-include-include-Global-library-70-6-71-70-define-YES1-define-NO0-change-mailbox-limit-change-limit-for-mailbox-file-static-int-change-mailbox-limit-LOCAL-STATE-state-USER-ATTR-usr-attr-char-myname-“change-mailbox-limit”-const-char-limit-res-long-n-0-int-status-NO-Look-up-the-virtual-mailbox-limit-size-for-this-user-Fall-back-to-virtual-mailbox-limit-in-case-lookup-failed-If-virtual-mailbox-limit-size-is-negative-fall-back-to-virtual-mailbox-limit-If-it’s-0-set-the-mailbox-limit-to-0-which-means-unlimited-If-it’s-more-than-0-positive-int-check-if-the-value-is-smaller-than-the-maximum-message-size-if-it-is-and-the-virtual-mailbox-limit-can’t-be-overridden-fall-back-to-virtual-mailbox-limit-and-warn-the-user-else-use-the-value-directly-as-the-mailbox-limit-if-var-virt-mailbox-limit-maps-0-limit-res-mail-addr-find-virtual-mailbox-limit-maps-state-msg-attr-user-char-NULL-0-n-atol-limit-res-if-n-0-if-n-var-message-limit-var-virt-mailbox-limit-override-set-file-limit-var-virt-mailbox-limit-status-NO-msg-warn-“-s-recipient-s-virtual-mailbox-limit-is-“-“smaller-than-s-in-s-falling-back-to-s”-myname-state-msg-attr-user-VAR-MESSAGE-LIMIT-virtual-mailbox-limit-maps-title-VAR-VIRT-MAILBOX-LIMIT-else-set-file-limit-off-t-n-status-YES-if-msg-verbose-msg-info-“-s-set-virtual-mailbox-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-n-else-if-n-0-set-file-limit-OFF-T-MAX-status-YES-if-msg-verbose-msg-info-“-s-set-virtual-mailbox-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-OFF-T-MAX-else-Invalid-limit-size-negative-Use-default-virtual-mailbox-limit-set-file-limit-var-virt-mailbox-limit-status-NO-else-There-is-no-limit-in-the-maps-Use-default-virtual-mailbox-limit-set-file-limit-var-virt-mailbox-limit-status-NO-return-status-deliver-mailbox-file-deliver-to-recipient-mailbox-static-int-deliver-mailbox-file-LOCAL-STATE-state-USER-ATTR-usr-attr-80-7-145-6-int-mail-copy-status-int-deliver-status-int-copy-flags-long-end-struct-stat-st-132-7-196-7-msg-warn-“specify-s-no-to-ignore-mailbox-ownership-mismatch”-VAR-STRICT-MBOX-OWNER-else-end-vstream-fseek-mp-fp-off-t-0-SEEK-END-vstream-fseek-mp-fp-off-t-0-SEEK-END-mail-copy-status-mail-copy-COPY-ATTR-state-msg-attr-mp-fp-copy-flags-“-n”-why-213-62-277-72-Look-up-the-mailbox-owner-rights-Defer-in-case-of-trouble-uid-res-mail-addr-find-virtual-uid-maps-state-msg-attr-user-IGNORE-EXTENSION-if-uid-res-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-IGNORE-EXTENSION-if-uid-res-mail-addr-find-virtual-uid-maps-state-msg-attr-user-char-0-0-if-uid-res-maps-find-virtual-uid-maps-strchr-state-msg-attr-user-‘-’-DICT-FLAG-FIXED-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-if-n-atol-uid-res-var-virt-minimum-uid-msg-warn-“recipient-s-bad-uid-s-in-s”-state-msg-attr-user-uid-res-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-msg-warn-“recipient-s-bad-uid-s-in-s”-state-msg-attr-user-uid-res-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-usr-attr-uid-uid-t-n-Look-up-the-mailbox-group-rights-Defer-in-case-of-trouble-gid-res-mail-addr-find-virtual-gid-maps-state-msg-attr-user-IGNORE-EXTENSION-if-gid-res-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-gid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-IGNORE-EXTENSION-if-gid-res-mail-addr-find-virtual-gid-maps-state-msg-attr-user-char-0-0-if-gid-res-maps-find-virtual-gid-maps-strchr-state-msg-attr-user-‘-’-DICT-FLAG-FIXED-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-gid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-if-n-atol-gid-res-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-msg-warn-“recipient-s-bad-gid-s-in-s”-state-msg-attr-user-gid-res-virtual-gid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-usr-attr-gid-gid-t-n-if-msg-verbose-msg-info-“-s-d-set-user-attr-s-uid-u-gid-u”-myname-state-level-usr-attr-mailbox-unsigned-usr-attr-uid-unsigned-usr-attr-gid-msg-info-“-s-d-set-user-attr-s-uid-u-gid-u”-myname-state-level-usr-attr-mailbox-unsigned-usr-attr-uid-unsigned-usr-attr-gid-Deliver-to-mailbox-or-to-maildir-define-LAST-CHAR-s-s-strlen-s-1-if-LAST-CHAR-usr-attr-mailbox-‘-‘-statusp-deliver-maildir-state-usr-attr-else-statusp-deliver-mailbox-file-state-usr-attr-if-LAST-CHAR-usr-attr-mailbox-‘-‘-statusp-deliver-maildir-state-usr-attr-else-int-changed-limit-changed-limit-change-mailbox-limit-state-usr-attr-statusp-deliver-mailbox-file-state-usr-attr-if-changed-limit-set-file-limit-var-virt-mailbox-limit-Cleanup-diff-uNr-postfix-2-10-0-orig-src-virtual-maildir-c-postfix-2-10-0-src-virtual-maildir-c—-postfix-2-10-0-orig-src-virtual-maildir-c2012-01-25-01-41-08-000000000-0100-postfix-2-10-0-src-virtual-maildir-c2013-06-07-13-21-22-840143270-0200-64-28-64-420-include-include-Patch-library-include-opendir-3-stat-2-include-stat-2-include-opendir-3-include-stat-2-include-atol-3-include-strrchr-3-include-include-include-include-include-include-include-Application-specific-include-“virtual-h”-deliver-maildir-delivery-to-maildir-style-mailbox-Maildirsize-maximal-size-define-SIZEFILE-MAX-5120-Chris-Stratford-x63-x68-114-x69-x73-115-64-112-x69-x70-x65-120-x2e-x6e-x65-116-Read-the-maildirsize-file-to-get-quota-info-Arguments-dirname-the-maildir-countptr-number-of-messages-Returns-the-size-of-all-mails-as-read-from-maildirsize-zero-if-it-couldn’t-read-the-file-static-long-read-maildirsize-char-filename-long-sumptr-long-countptr-char-myname-“read-maildirsize”-struct-stat-statbuf-VSTREAM-sizefile-char-p-int-len-first-long-sum-0-count-0-ret-value-1-if-msg-verbose-msg-info-“-s-we-will-use-sizefile-‘-s’”-myname-filename-sizefile-vstream-fopen-filename-O-RDONLY-0-if-sizefile-if-msg-verbose-msg-info-“-s-cannot-open-s-m-maybe-file-does-not-exist-”-myname-filename-return-1-else-if-stat-filename-statbuf-0-statbuf-st-size-SIZEFILE-MAX-if-sizefile-vstream-fclose-sizefile-unlink-filename-if-msg-verbose-msg-info-“-s-stat-returned-0-or-filesize-SIZEFILE-MAX-filename-s-filesize-ld-”-myname-filename-statbuf-st-size-return-1-VSTRING-sizebuf-vstring-alloc-SIZEFILE-MAX-len-vstream-fread-sizefile-STR-sizebuf-SIZEFILE-MAX-p-STR-sizebuf-p-len-‘-0’-first-1-while-p-long-n-0-c-0-char-q-p-while-p-if-p-‘-n’-p-1-0-break-if-first-first-0-continue-if-sscanf-q-“-ld-ld”-n-c-2-sum-n-count-c-if-msg-verbose-msg-info-“-s-we-read-line-‘-s’-totals-sum-ld-count-ld”-myname-q-sum-count-else-vstream-fclose-sizefile-unlink-filename-msg-warn-“-s-invalid-line-‘-s’-found-in-s-removing-maildirsize-file”-myname-q-filename-vstring-free-sizebuf-return-1-countptr-count-sumptr-sum-if-sum-0-count-0-sum-0-count-0-sum-0-count-0-if-msg-verbose-msg-info-“-s-we-will-return-1-and-unlink-s-because-file-count-or-sum-is-n-–o-if-o-‘-‘-break-if-o-‘-’-o-1-‘S’-o-2-‘-’-yes-1-o-3-break-if-yes-long-s-0-while-o-‘0’-o-d-name-long-tmpsum-0-VSTRING-buffer-do-not-count-dot-a-double-dot-dirs-if-strcmp-name-“-”-0-strcmp-name-“-”-0-continue-do-not-count-if-this-is-the-trash-subdir-and-if-we-should-NOT-count-it-else-if-var-virt-trash-count-0-strcmp-name-var-virt-trash-name-0-continue-Here-comes-the-real-logic-behind-this-function-Optimized-to-be-the-most-efficient-possible-depending-on-the-settings-given-See-above-for-a-more-detailed-description-if-var-virt-mailbox-limit-inbox-if-var-virt-maildir-extended-tmpsum-maildir-parsequota-name-sum-tmpsum-countptr-else-buffer-vstring-alloc-1024-vstring-sprintf-buffer-“-s-s”-dirname-name-if-stat-STR-buffer-statbuf-0-vstring-free-buffer-continue-if-statbuf-st-mode-S-IFREG-0-sum-long-statbuf-st-size-countptr-vstring-free-buffer-else-buffer-vstring-alloc-1024-vstring-sprintf-buffer-“-s-s”-dirname-name-if-stat-STR-buffer-statbuf-0-vstring-free-buffer-continue-if-statbuf-st-mode-S-IFREG-0-if-strcmp-dirname-strlen-dirname-3-“new”-0-strcmp-dirname-strlen-dirname-3-“cur”-0-strcmp-dirname-strlen-dirname-3-“tmp”-0-sum-long-statbuf-st-size-countptr-else-if-statbuf-st-mode-S-IFDIR-0-sum-check-dir-size-STR-buffer-countptr-vstring-free-buffer-closedir-dir-int-deliver-maildir-LOCAL-STATE-state-USER-ATTR-usr-attr-if-msg-verbose-msg-info-“-s-full-scan-done-dir-s-sum-ld-count-ld”-myname-dirname-sum-countptr-return-sum-Cut-all-occurrences-of-pattern-from-string-static-char-strcut-char-str-const-char-pat-char-ptr-loc-ret-ret-str-loc-str-No-match-return-original-string-if-strstr-loc-pat-return-str-while-loc-ptr-strstr-loc-pat-while-loc-ptr-str-loc-loc-strlen-pat-while-loc-str-loc-str-0-return-ret-Check-if-maildirfilter-file-is-up-to-date-compared-to-SQL-re-write-it-if-not-static-long-sql2file-char-filename-char-user-char-myname-“sql2file”-char-filter-sqlres-char-filter-fileres-128-long-sqlmtime-0-filemtime-0-retval-0-int-filterfile-size-sqlres-i-struct-stat-statbuf-if-var-virt-maildir-filter-maps-0-filter-sqlres-char-mymalloc-16000-filter-sqlres-char-mail-addr-find-virtual-maildir-filter-maps-user-char-0-if-filter-sqlres-strcut-filter-sqlres-“-r”-if-filter-sqlres-0-‘-’-filter-sqlres-1-‘-‘-filter-sqlres-2-‘M’-size-sqlres-strlen-filter-sqlres-for-i-4-i-flags-dsb-simple-why-“2-0-0”-“delivers-to-maildir”-return-sent-BOUNCE-FLAGS-state-request-SENT-ATTR-state-msg-attr-dsb-simple-why-“2-0-0”-“delivers-to-maildir”-return-sent-BOUNCE-FLAGS-state-request-SENT-ATTR-state-msg-attr-110-18-501-116-attribute-to-reflect-the-final-recipient-if-vstream-fseek-state-msg-attr-fp-state-msg-attr-offset-SEEK-SET-0-msg-fatal-“seek-message-file-s-m”-VSTREAM-PATH-state-msg-attr-fp-msg-fatal-“seek-message-file-s-m”-VSTREAM-PATH-state-msg-attr-fp-state-msg-attr-delivered-state-msg-attr-rcpt-address-mail-copy-status-MAIL-COPY-STAT-WRITE-buf-vstring-alloc-100-copy-flags-MAIL-COPY-TOFILE-MAIL-COPY-RETURN-PATH-MAIL-COPY-DELIVERED-MAIL-COPY-ORIG-RCPT-copy-flags-MAIL-COPY-TOFILE-MAIL-COPY-RETURN-PATH-MAIL-COPY-DELIVERED-MAIL-COPY-ORIG-RCPT-newdir-concatenate-usr-attr-mailbox-“new-“-char-0-tmpdir-concatenate-usr-attr-mailbox-“tmp-“-char-0-curdir-concatenate-usr-attr-mailbox-“cur-“-char-0-Concatenate-the-maildir-suffix-if-set-if-var-virt-maildir-suffix-0-newdir-concatenate-usr-attr-mailbox-“new-“-char-0-tmpdir-concatenate-usr-attr-mailbox-“tmp-“-char-0-curdir-concatenate-usr-attr-mailbox-“cur-“-char-0-else-newdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-tmpdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-curdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-newdir-concatenate-newdir-“new-“-char-0-tmpdir-concatenate-tmpdir-“tmp-“-char-0-curdir-concatenate-curdir-“cur-“-char-0-get-the-sizefilename-no-matter-if-we-use-var-virt-maildir-extended-if-var-virt-maildir-suffix-0-sizefilename-concatenate-usr-attr-mailbox-“maildirsize”-char-0-else-sizefilename-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-sizefilename-concatenate-sizefilename-“maildirsize”-char-0-Look-up-the-virtual-maildir-limit-size-for-this-user-Fall-back-to-virtual-mailbox-limit-in-case-lookup-failed-If-virtual-maildir-limit-size-is-negative-fall-back-to-virtual-mailbox-limit-If-it’s-0-set-the-mailbox-limit-to-0-which-means-unlimited-If-it’s-more-than-0-positive-int-check-if-the-value-is-smaller-than-the-maximum-message-size-if-it-is-and-the-virtual-maildir-limit-can’t-be-overridden-fall-back-to-virtual-mailbox-limit-and-warn-the-user-else-use-the-value-directly-as-the-maildir-limit-if-var-virt-mailbox-limit-maps-0-limit-res-mail-addr-find-virtual-mailbox-limit-maps-state-msg-attr-user-char-NULL-0-n-atol-limit-res-if-n-0-if-n-var-message-limit-var-virt-mailbox-limit-override-n-var-virt-mailbox-limit-msg-warn-“-s-recipient-s-virtual-maildir-limit-is-smaller-than-s-in-s-falling-back-to-s”-myname-state-msg-attr-user-VAR-MESSAGE-LIMIT-virtual-mailbox-limit-maps-title-VAR-VIRT-MAILBOX-LIMIT-else-if-msg-verbose-msg-info-“-s-set-virtual-maildir-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-n-else-if-n-0-if-msg-verbose-msg-info-“-s-set-virtual-maildir-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-n-else-if-msg-verbose-msg-info-“-s-quota-is-negative-ld-using-default-virtual-mailbox-limit-ld-”-myname-n-var-virt-mailbox-limit-Invalid-limit-size-negative-Use-default-virtual-mailbox-limit-n-var-virt-mailbox-limit-else-if-msg-verbose-msg-info-“-s-no-limit-found-in-the-maps-using-default-virtual-mailbox-limit-ld-”-myname-var-virt-mailbox-limit-There-is-no-limit-in-the-maps-Use-default-virtual-mailbox-limit-n-var-virt-mailbox-limit-If-there-should-is-a-quota-on-maildir-generaly-check-it-before-delivering-the-mail-if-n-0-set-eugid-usr-attr-uid-usr-attr-gid-try-to-read-the-quota-from-maildirsize-file-Returned-values-by-read-maildirsize-x-0-something-failed-x-0-reading-successfully-finished-sum-si-returned-so-sum-size-of-Maildir-was-0-or-more-if-var-virt-mailbox-limit-inbox-var-virt-maildir-extended-read-mds-read-maildirsize-sizefilename-saved-size-saved-count-0-if-msg-verbose-msg-info-“-s-maildirsize-used-s-sum-ld-count-ld”-myname-sizefilename-saved-size-saved-count-else-if-msg-verbose-msg-info-“-s-We-will-recount-the-quota-var-virt-mailbox-limit-ld-var-virt-maildir-extended-d-read-maildirsize-d-”-myname-var-virt-mailbox-limit-var-virt-maildir-extended-read-mds-sanity-saved-size-0-saved-count-0-if-var-virt-mailbox-limit-inbox-Check-Inbox-only-new-cur-and-tmp-dirs-saved-size-check-dir-size-newdir-saved-count-saved-size-check-dir-size-curdir-saved-count-saved-size-check-dir-size-tmpdir-saved-count-else-Check-all-boxes-saved-size-check-dir-size-usr-attr-mailbox-saved-count-set-eugid-var-owner-uid-var-owner-gid-Create-and-write-the-file-as-the-recipient-so-that-file-quota-work-Create-any-missing-directories-on-the-fly-The-file-name-is-chosen-175-46-664-288-…-set-eugid-usr-attr-uid-usr-attr-gid-vstring-sprintf-buf-“-lu-P-d-s”-unsigned-long-starttime-tv-sec-var-pid-get-hostname-vstring-sprintf-buf-“-lu-P-d-s”-unsigned-long-starttime-tv-sec-var-pid-get-hostname-tmpfile-concatenate-tmpdir-STR-buf-char-0-newfile-0-bkpnewfile-0-if-dst-vstream-fopen-tmpfile-O-WRONLY-O-CREAT-O-EXCL-0600-0-errno-ENOENT-make-dirs-tmpdir-0700-0-dst-vstream-fopen-tmpfile-O-WRONLY-O-CREAT-O-EXCL-0600-0-dsb-simple-why-mbox-dsn-errno-“4-2-0”-“create-maildir-file-s-m”-tmpfile-else-if-fstat-vstream-fileno-dst-st-0"><a href="#diff-uNr-postfix-2-10-0-orig-README-FILES-VDA-README-postfix-2-10-0-README-FILES-VDA-README—-postfix-2-10-0-orig-README-FILES-VDA-README1970-01-01-01-00-00-000000000-0100-postfix-2-10-0-README-FILES-VDA-README2013-06-07-13-21-22-837143270-0200-0-0-1-10-Postfix-VDA-patch-for-maildir-quota-support-by-Anderson-Nadal-x61-x6e-x64-x65-x72-x6e-97-100-x61-x6c-x40-103-x6d-97-x69-108-x2e-99-x6f-x6d-Tomas-Macek-x6d-x61-x63-x61-x30-50-x40-97-116-x6c-x61-x73-46-x63-122-Lucca-Longinotti-See-VDA-patch-official-website-http-vda-sf-net-for-instructions-howto-patch-the-Postfix’s-sourcetree-and-configure-the-options-provided-by-this-patch-diff-uNr-postfix-2-10-0-orig-src-global-mail-params-h-postfix-2-10-0-src-global-mail-params-h—-postfix-2-10-0-orig-src-global-mail-params-h2013-02-03-19-22-21-000000000-0100-postfix-2-10-0-src-global-mail-params-h2013-06-07-13-21-22-838143270-0200-2367-6-2367-54-define-DEF-VIRT-GID-MAPS“”-extern-char-var-virt-gid-maps-define-VAR-VIRT-MAILBOX-LIMIT-MAPS-“virtual-mailbox-limit-maps”-define-DEF-VIRT-MAILBOX-LIMIT-MAPS-“”-extern-char-var-virt-mailbox-limit-maps-define-VAR-VIRT-MAILBOX-LIMIT-INBOX-“virtual-mailbox-limit-inbox”-define-DEF-VIRT-MAILBOX-LIMIT-INBOX-0-extern-bool-var-virt-mailbox-limit-inbox-define-VAR-VIRT-MAILBOX-LIMIT-OVERRIDE-“virtual-mailbox-limit-override”-define-DEF-VIRT-MAILBOX-LIMIT-OVERRIDE-0-extern-bool-var-virt-mailbox-limit-override-define-VAR-VIRT-MAILDIR-EXTENDED-“virtual-maildir-extended”-define-DEF-VIRT-MAILDIR-EXTENDED-0-extern-bool-var-virt-maildir-extended-define-VAR-VIRT-OVERQUOTA-BOUNCE-“virtual-overquota-bounce”-define-DEF-VIRT-OVERQUOTA-BOUNCE-0-extern-bool-var-virt-overquota-bounce-define-VAR-VIRT-MAILDIR-LIMIT-MESSAGE-“virtual-maildir-limit-message”-define-DEF-VIRT-MAILDIR-LIMIT-MESSAGE-“Sorry-the-user’s-maildir-has-overdrawn-his-diskspace-quota-please-try-again-later-”-extern-char-var-virt-maildir-limit-message-define-VAR-VIRT-MAILDIR-LIMIT-MESSAGE-MAPS-“virtual-maildir-limit-message-maps”-define-DEF-VIRT-MAILDIR-LIMIT-MESSAGE-MAPS-“”-extern-char-var-virt-maildir-limit-message-maps-define-VAR-VIRT-MAILDIR-SUFFIX-“virtual-maildir-suffix”-define-DEF-VIRT-MAILDIR-SUFFIX-“”-extern-char-var-virt-maildir-suffix-define-VAR-VIRT-TRASH-COUNT-“virtual-trash-count”-define-DEF-VIRT-TRASH-COUNT-0-extern-bool-var-virt-trash-count-define-VAR-VIRT-TRASH-NAME-“virtual-trash-name”-define-DEF-VIRT-TRASH-NAME-“-Trash”-extern-char-var-virt-trash-name-define-VAR-VIRT-MAILDIR-FILTER-“virtual-maildir-filter”-define-DEF-VIRT-MAILDIR-FILTER-0-extern-bool-var-virt-maildir-filter-define-VAR-VIRT-MAILDIR-FILTER-MAPS-“virtual-maildir-filter-maps”-define-DEF-VIRT-MAILDIR-FILTER-MAPS-“”-extern-char-var-virt-maildir-filter-maps-define-VAR-VIRT-MINUID“virtual-minimum-uid”-define-DEF-VIRT-MINUID100-extern-int-var-virt-minimum-uid-diff-uNr-postfix-2-10-0-orig-src-util-file-limit-c-postfix-2-10-0-src-util-file-limit-c—-postfix-2-10-0-orig-src-util-file-limit-c2003-10-22-20-48-36-000000000-0200-postfix-2-10-0-src-util-file-limit-c2013-06-07-13-21-22-839143270-0200-85-7-85-11-else-struct-rlimit-rlim-rlim-rlim-cur-rlim-rlim-max-limit-rlim-max-can-only-be-changed-by-root-if-getrlimit-RLIMIT-FSIZE-rlim-0-msg-fatal-“getrlimit-m”-rlim-rlim-cur-limit-if-setrlimit-RLIMIT-FSIZE-rlim-0-msg-fatal-“setrlimit-m”-ifdef-SIGXFSZdiff-uNr-postfix-2-10-0-orig-src-virtual-mailbox-c-postfix-2-10-0-src-virtual-mailbox-c—-postfix-2-10-0-orig-src-virtual-mailbox-c2011-12-24-03-13-32-000000000-0100-postfix-2-10-0-src-virtual-mailbox-c2013-06-07-13-23-03-044139705-0200-52-6-52-7-include-include-include-include-Global-library-70-6-71-70-define-YES1-define-NO0-change-mailbox-limit-change-limit-for-mailbox-file-static-int-change-mailbox-limit-LOCAL-STATE-state-USER-ATTR-usr-attr-char-myname-“change-mailbox-limit”-const-char-limit-res-long-n-0-int-status-NO-Look-up-the-virtual-mailbox-limit-size-for-this-user-Fall-back-to-virtual-mailbox-limit-in-case-lookup-failed-If-virtual-mailbox-limit-size-is-negative-fall-back-to-virtual-mailbox-limit-If-it’s-0-set-the-mailbox-limit-to-0-which-means-unlimited-If-it’s-more-than-0-positive-int-check-if-the-value-is-smaller-than-the-maximum-message-size-if-it-is-and-the-virtual-mailbox-limit-can’t-be-overridden-fall-back-to-virtual-mailbox-limit-and-warn-the-user-else-use-the-value-directly-as-the-mailbox-limit-if-var-virt-mailbox-limit-maps-0-limit-res-mail-addr-find-virtual-mailbox-limit-maps-state-msg-attr-user-char-NULL-0-n-atol-limit-res-if-n-0-if-n-var-message-limit-var-virt-mailbox-limit-override-set-file-limit-var-virt-mailbox-limit-status-NO-msg-warn-“-s-recipient-s-virtual-mailbox-limit-is-“-“smaller-than-s-in-s-falling-back-to-s”-myname-state-msg-attr-user-VAR-MESSAGE-LIMIT-virtual-mailbox-limit-maps-title-VAR-VIRT-MAILBOX-LIMIT-else-set-file-limit-off-t-n-status-YES-if-msg-verbose-msg-info-“-s-set-virtual-mailbox-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-n-else-if-n-0-set-file-limit-OFF-T-MAX-status-YES-if-msg-verbose-msg-info-“-s-set-virtual-mailbox-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-OFF-T-MAX-else-Invalid-limit-size-negative-Use-default-virtual-mailbox-limit-set-file-limit-var-virt-mailbox-limit-status-NO-else-There-is-no-limit-in-the-maps-Use-default-virtual-mailbox-limit-set-file-limit-var-virt-mailbox-limit-status-NO-return-status-deliver-mailbox-file-deliver-to-recipient-mailbox-static-int-deliver-mailbox-file-LOCAL-STATE-state-USER-ATTR-usr-attr-80-7-145-6-int-mail-copy-status-int-deliver-status-int-copy-flags-long-end-struct-stat-st-132-7-196-7-msg-warn-“specify-s-no-to-ignore-mailbox-ownership-mismatch”-VAR-STRICT-MBOX-OWNER-else-end-vstream-fseek-mp-fp-off-t-0-SEEK-END-vstream-fseek-mp-fp-off-t-0-SEEK-END-mail-copy-status-mail-copy-COPY-ATTR-state-msg-attr-mp-fp-copy-flags-“-n”-why-213-62-277-72-Look-up-the-mailbox-owner-rights-Defer-in-case-of-trouble-uid-res-mail-addr-find-virtual-uid-maps-state-msg-attr-user-IGNORE-EXTENSION-if-uid-res-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-IGNORE-EXTENSION-if-uid-res-mail-addr-find-virtual-uid-maps-state-msg-attr-user-char-0-0-if-uid-res-maps-find-virtual-uid-maps-strchr-state-msg-attr-user-‘-’-DICT-FLAG-FIXED-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-if-n-atol-uid-res-var-virt-minimum-uid-msg-warn-“recipient-s-bad-uid-s-in-s”-state-msg-attr-user-uid-res-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-msg-warn-“recipient-s-bad-uid-s-in-s”-state-msg-attr-user-uid-res-virtual-uid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-usr-attr-uid-uid-t-n-Look-up-the-mailbox-group-rights-Defer-in-case-of-trouble-gid-res-mail-addr-find-virtual-gid-maps-state-msg-attr-user-IGNORE-EXTENSION-if-gid-res-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-gid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-IGNORE-EXTENSION-if-gid-res-mail-addr-find-virtual-gid-maps-state-msg-attr-user-char-0-0-if-gid-res-maps-find-virtual-gid-maps-strchr-state-msg-attr-user-‘-’-DICT-FLAG-FIXED-0-msg-warn-“recipient-s-not-found-in-s”-state-msg-attr-user-virtual-gid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-if-n-atol-gid-res-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-msg-warn-“recipient-s-bad-gid-s-in-s”-state-msg-attr-user-gid-res-virtual-gid-maps-title-dsb-simple-why-“4-3-5”-“mail-system-configuration-error”-statusp-defer-append-BOUNCE-FLAGS-state-request-BOUNCE-ATTR-state-msg-attr-RETURN-YES-usr-attr-gid-gid-t-n-if-msg-verbose-msg-info-“-s-d-set-user-attr-s-uid-u-gid-u”-myname-state-level-usr-attr-mailbox-unsigned-usr-attr-uid-unsigned-usr-attr-gid-msg-info-“-s-d-set-user-attr-s-uid-u-gid-u”-myname-state-level-usr-attr-mailbox-unsigned-usr-attr-uid-unsigned-usr-attr-gid-Deliver-to-mailbox-or-to-maildir-define-LAST-CHAR-s-s-strlen-s-1-if-LAST-CHAR-usr-attr-mailbox-‘-‘-statusp-deliver-maildir-state-usr-attr-else-statusp-deliver-mailbox-file-state-usr-attr-if-LAST-CHAR-usr-attr-mailbox-‘-‘-statusp-deliver-maildir-state-usr-attr-else-int-changed-limit-changed-limit-change-mailbox-limit-state-usr-attr-statusp-deliver-mailbox-file-state-usr-attr-if-changed-limit-set-file-limit-var-virt-mailbox-limit-Cleanup-diff-uNr-postfix-2-10-0-orig-src-virtual-maildir-c-postfix-2-10-0-src-virtual-maildir-c—-postfix-2-10-0-orig-src-virtual-maildir-c2012-01-25-01-41-08-000000000-0100-postfix-2-10-0-src-virtual-maildir-c2013-06-07-13-21-22-840143270-0200-64-28-64-420-include-include-Patch-library-include-opendir-3-stat-2-include-stat-2-include-opendir-3-include-stat-2-include-atol-3-include-strrchr-3-include-include-include-include-include-include-include-Application-specific-include-“virtual-h”-deliver-maildir-delivery-to-maildir-style-mailbox-Maildirsize-maximal-size-define-SIZEFILE-MAX-5120-Chris-Stratford-x63-x68-114-x69-x73-115-64-112-x69-x70-x65-120-x2e-x6e-x65-116-Read-the-maildirsize-file-to-get-quota-info-Arguments-dirname-the-maildir-countptr-number-of-messages-Returns-the-size-of-all-mails-as-read-from-maildirsize-zero-if-it-couldn’t-read-the-file-static-long-read-maildirsize-char-filename-long-sumptr-long-countptr-char-myname-“read-maildirsize”-struct-stat-statbuf-VSTREAM-sizefile-char-p-int-len-first-long-sum-0-count-0-ret-value-1-if-msg-verbose-msg-info-“-s-we-will-use-sizefile-‘-s’”-myname-filename-sizefile-vstream-fopen-filename-O-RDONLY-0-if-sizefile-if-msg-verbose-msg-info-“-s-cannot-open-s-m-maybe-file-does-not-exist-”-myname-filename-return-1-else-if-stat-filename-statbuf-0-statbuf-st-size-SIZEFILE-MAX-if-sizefile-vstream-fclose-sizefile-unlink-filename-if-msg-verbose-msg-info-“-s-stat-returned-0-or-filesize-SIZEFILE-MAX-filename-s-filesize-ld-”-myname-filename-statbuf-st-size-return-1-VSTRING-sizebuf-vstring-alloc-SIZEFILE-MAX-len-vstream-fread-sizefile-STR-sizebuf-SIZEFILE-MAX-p-STR-sizebuf-p-len-‘-0’-first-1-while-p-long-n-0-c-0-char-q-p-while-p-if-p-‘-n’-p-1-0-break-if-first-first-0-continue-if-sscanf-q-“-ld-ld”-n-c-2-sum-n-count-c-if-msg-verbose-msg-info-“-s-we-read-line-‘-s’-totals-sum-ld-count-ld”-myname-q-sum-count-else-vstream-fclose-sizefile-unlink-filename-msg-warn-“-s-invalid-line-‘-s’-found-in-s-removing-maildirsize-file”-myname-q-filename-vstring-free-sizebuf-return-1-countptr-count-sumptr-sum-if-sum-0-count-0-sum-0-count-0-sum-0-count-0-if-msg-verbose-msg-info-“-s-we-will-return-1-and-unlink-s-because-file-count-or-sum-is-n-–o-if-o-‘-‘-break-if-o-‘-’-o-1-‘S’-o-2-‘-’-yes-1-o-3-break-if-yes-long-s-0-while-o-‘0’-o-d-name-long-tmpsum-0-VSTRING-buffer-do-not-count-dot-a-double-dot-dirs-if-strcmp-name-“-”-0-strcmp-name-“-”-0-continue-do-not-count-if-this-is-the-trash-subdir-and-if-we-should-NOT-count-it-else-if-var-virt-trash-count-0-strcmp-name-var-virt-trash-name-0-continue-Here-comes-the-real-logic-behind-this-function-Optimized-to-be-the-most-efficient-possible-depending-on-the-settings-given-See-above-for-a-more-detailed-description-if-var-virt-mailbox-limit-inbox-if-var-virt-maildir-extended-tmpsum-maildir-parsequota-name-sum-tmpsum-countptr-else-buffer-vstring-alloc-1024-vstring-sprintf-buffer-“-s-s”-dirname-name-if-stat-STR-buffer-statbuf-0-vstring-free-buffer-continue-if-statbuf-st-mode-S-IFREG-0-sum-long-statbuf-st-size-countptr-vstring-free-buffer-else-buffer-vstring-alloc-1024-vstring-sprintf-buffer-“-s-s”-dirname-name-if-stat-STR-buffer-statbuf-0-vstring-free-buffer-continue-if-statbuf-st-mode-S-IFREG-0-if-strcmp-dirname-strlen-dirname-3-“new”-0-strcmp-dirname-strlen-dirname-3-“cur”-0-strcmp-dirname-strlen-dirname-3-“tmp”-0-sum-long-statbuf-st-size-countptr-else-if-statbuf-st-mode-S-IFDIR-0-sum-check-dir-size-STR-buffer-countptr-vstring-free-buffer-closedir-dir-int-deliver-maildir-LOCAL-STATE-state-USER-ATTR-usr-attr-if-msg-verbose-msg-info-“-s-full-scan-done-dir-s-sum-ld-count-ld”-myname-dirname-sum-countptr-return-sum-Cut-all-occurrences-of-pattern-from-string-static-char-strcut-char-str-const-char-pat-char-ptr-loc-ret-ret-str-loc-str-No-match-return-original-string-if-strstr-loc-pat-return-str-while-loc-ptr-strstr-loc-pat-while-loc-ptr-str-loc-loc-strlen-pat-while-loc-str-loc-str-0-return-ret-Check-if-maildirfilter-file-is-up-to-date-compared-to-SQL-re-write-it-if-not-static-long-sql2file-char-filename-char-user-char-myname-“sql2file”-char-filter-sqlres-char-filter-fileres-128-long-sqlmtime-0-filemtime-0-retval-0-int-filterfile-size-sqlres-i-struct-stat-statbuf-if-var-virt-maildir-filter-maps-0-filter-sqlres-char-mymalloc-16000-filter-sqlres-char-mail-addr-find-virtual-maildir-filter-maps-user-char-0-if-filter-sqlres-strcut-filter-sqlres-“-r”-if-filter-sqlres-0-‘-’-filter-sqlres-1-‘-‘-filter-sqlres-2-‘M’-size-sqlres-strlen-filter-sqlres-for-i-4-i-flags-dsb-simple-why-“2-0-0”-“delivers-to-maildir”-return-sent-BOUNCE-FLAGS-state-request-SENT-ATTR-state-msg-attr-dsb-simple-why-“2-0-0”-“delivers-to-maildir”-return-sent-BOUNCE-FLAGS-state-request-SENT-ATTR-state-msg-attr-110-18-501-116-attribute-to-reflect-the-final-recipient-if-vstream-fseek-state-msg-attr-fp-state-msg-attr-offset-SEEK-SET-0-msg-fatal-“seek-message-file-s-m”-VSTREAM-PATH-state-msg-attr-fp-msg-fatal-“seek-message-file-s-m”-VSTREAM-PATH-state-msg-attr-fp-state-msg-attr-delivered-state-msg-attr-rcpt-address-mail-copy-status-MAIL-COPY-STAT-WRITE-buf-vstring-alloc-100-copy-flags-MAIL-COPY-TOFILE-MAIL-COPY-RETURN-PATH-MAIL-COPY-DELIVERED-MAIL-COPY-ORIG-RCPT-copy-flags-MAIL-COPY-TOFILE-MAIL-COPY-RETURN-PATH-MAIL-COPY-DELIVERED-MAIL-COPY-ORIG-RCPT-newdir-concatenate-usr-attr-mailbox-“new-“-char-0-tmpdir-concatenate-usr-attr-mailbox-“tmp-“-char-0-curdir-concatenate-usr-attr-mailbox-“cur-“-char-0-Concatenate-the-maildir-suffix-if-set-if-var-virt-maildir-suffix-0-newdir-concatenate-usr-attr-mailbox-“new-“-char-0-tmpdir-concatenate-usr-attr-mailbox-“tmp-“-char-0-curdir-concatenate-usr-attr-mailbox-“cur-“-char-0-else-newdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-tmpdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-curdir-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-newdir-concatenate-newdir-“new-“-char-0-tmpdir-concatenate-tmpdir-“tmp-“-char-0-curdir-concatenate-curdir-“cur-“-char-0-get-the-sizefilename-no-matter-if-we-use-var-virt-maildir-extended-if-var-virt-maildir-suffix-0-sizefilename-concatenate-usr-attr-mailbox-“maildirsize”-char-0-else-sizefilename-concatenate-usr-attr-mailbox-var-virt-maildir-suffix-char-0-sizefilename-concatenate-sizefilename-“maildirsize”-char-0-Look-up-the-virtual-maildir-limit-size-for-this-user-Fall-back-to-virtual-mailbox-limit-in-case-lookup-failed-If-virtual-maildir-limit-size-is-negative-fall-back-to-virtual-mailbox-limit-If-it’s-0-set-the-mailbox-limit-to-0-which-means-unlimited-If-it’s-more-than-0-positive-int-check-if-the-value-is-smaller-than-the-maximum-message-size-if-it-is-and-the-virtual-maildir-limit-can’t-be-overridden-fall-back-to-virtual-mailbox-limit-and-warn-the-user-else-use-the-value-directly-as-the-maildir-limit-if-var-virt-mailbox-limit-maps-0-limit-res-mail-addr-find-virtual-mailbox-limit-maps-state-msg-attr-user-char-NULL-0-n-atol-limit-res-if-n-0-if-n-var-message-limit-var-virt-mailbox-limit-override-n-var-virt-mailbox-limit-msg-warn-“-s-recipient-s-virtual-maildir-limit-is-smaller-than-s-in-s-falling-back-to-s”-myname-state-msg-attr-user-VAR-MESSAGE-LIMIT-virtual-mailbox-limit-maps-title-VAR-VIRT-MAILBOX-LIMIT-else-if-msg-verbose-msg-info-“-s-set-virtual-maildir-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-n-else-if-n-0-if-msg-verbose-msg-info-“-s-set-virtual-maildir-limit-size-for-s-to-ld”-myname-usr-attr-mailbox-n-else-if-msg-verbose-msg-info-“-s-quota-is-negative-ld-using-default-virtual-mailbox-limit-ld-”-myname-n-var-virt-mailbox-limit-Invalid-limit-size-negative-Use-default-virtual-mailbox-limit-n-var-virt-mailbox-limit-else-if-msg-verbose-msg-info-“-s-no-limit-found-in-the-maps-using-default-virtual-mailbox-limit-ld-”-myname-var-virt-mailbox-limit-There-is-no-limit-in-the-maps-Use-default-virtual-mailbox-limit-n-var-virt-mailbox-limit-If-there-should-is-a-quota-on-maildir-generaly-check-it-before-delivering-the-mail-if-n-0-set-eugid-usr-attr-uid-usr-attr-gid-try-to-read-the-quota-from-maildirsize-file-Returned-values-by-read-maildirsize-x-0-something-failed-x-0-reading-successfully-finished-sum-si-returned-so-sum-size-of-Maildir-was-0-or-more-if-var-virt-mailbox-limit-inbox-var-virt-maildir-extended-read-mds-read-maildirsize-sizefilename-saved-size-saved-count-0-if-msg-verbose-msg-info-“-s-maildirsize-used-s-sum-ld-count-ld”-myname-sizefilename-saved-size-saved-count-else-if-msg-verbose-msg-info-“-s-We-will-recount-the-quota-var-virt-mailbox-limit-ld-var-virt-maildir-extended-d-read-maildirsize-d-”-myname-var-virt-mailbox-limit-var-virt-maildir-extended-read-mds-sanity-saved-size-0-saved-count-0-if-var-virt-mailbox-limit-inbox-Check-Inbox-only-new-cur-and-tmp-dirs-saved-size-check-dir-size-newdir-saved-count-saved-size-check-dir-size-curdir-saved-count-saved-size-check-dir-size-tmpdir-saved-count-else-Check-all-boxes-saved-size-check-dir-size-usr-attr-mailbox-saved-count-set-eugid-var-owner-uid-var-owner-gid-Create-and-write-the-file-as-the-recipient-so-that-file-quota-work-Create-any-missing-directories-on-the-fly-The-file-name-is-chosen-175-46-664-288-…-set-eugid-usr-attr-uid-usr-attr-gid-vstring-sprintf-buf-“-lu-P-d-s”-unsigned-long-starttime-tv-sec-var-pid-get-hostname-vstring-sprintf-buf-“-lu-P-d-s”-unsigned-long-starttime-tv-sec-var-pid-get-hostname-tmpfile-concatenate-tmpdir-STR-buf-char-0-newfile-0-bkpnewfile-0-if-dst-vstream-fopen-tmpfile-O-WRONLY-O-CREAT-O-EXCL-0600-0-errno-ENOENT-make-dirs-tmpdir-0700-0-dst-vstream-fopen-tmpfile-O-WRONLY-O-CREAT-O-EXCL-0600-0-dsb-simple-why-mbox-dsn-errno-“4-2-0”-“create-maildir-file-s-m”-tmpfile-else-if-fstat-vstream-fileno-dst-st-0" class="headerlink" title="diff -uNr postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README— postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README	1970-01-01 01:00:00.000000000 +0100+++ postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README	2013-06-07 13:21:22.837143270 +0200@@ -0,0 +1,10 @@+Postfix VDA patch for maildir++ quota support by+    Anderson Nadal &#x61;&#x6e;&#x64;&#x65;&#x72;&#x6e;&#97;&#100;&#x61;&#x6c;&#x40;&#103;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;+    Tomas Macek &#x6d;&#x61;&#x63;&#x61;&#x30;&#50;&#x40;&#97;&#116;&#x6c;&#x61;&#x73;&#46;&#x63;&#122;+    Lucca Longinotti++See VDA patch official website http://vda.sf.net for instructions+howto patch the Postfix’s sourcetree and configure the options+provided by this patch.++diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;global&#x2F;mail_params.h postfix-2.10.0&#x2F;src&#x2F;global&#x2F;mail_params.h— postfix-2.10.0.orig&#x2F;src&#x2F;global&#x2F;mail_params.h	2013-02-03 19:22:21.000000000 +0100+++ postfix-2.10.0&#x2F;src&#x2F;global&#x2F;mail_params.h	2013-06-07 13:21:22.838143270 +0200@@ -2367,6 +2367,54 @@ #define DEF_VIRT_GID_MAPS		“” extern char *var_virt_gid_maps;+#define VAR_VIRT_MAILBOX_LIMIT_MAPS     “virtual_mailbox_limit_maps”+#define DEF_VIRT_MAILBOX_LIMIT_MAPS     “”+extern char *var_virt_mailbox_limit_maps;++#define VAR_VIRT_MAILBOX_LIMIT_INBOX    “virtual_mailbox_limit_inbox”+#define DEF_VIRT_MAILBOX_LIMIT_INBOX    0+extern bool var_virt_mailbox_limit_inbox;++#define VAR_VIRT_MAILBOX_LIMIT_OVERRIDE “virtual_mailbox_limit_override”+#define DEF_VIRT_MAILBOX_LIMIT_OVERRIDE 0+extern bool var_virt_mailbox_limit_override;++#define VAR_VIRT_MAILDIR_EXTENDED       “virtual_maildir_extended”+#define DEF_VIRT_MAILDIR_EXTENDED       0+extern bool var_virt_maildir_extended;++#define VAR_VIRT_OVERQUOTA_BOUNCE       “virtual_overquota_bounce”+#define DEF_VIRT_OVERQUOTA_BOUNCE       0+extern bool var_virt_overquota_bounce;++#define VAR_VIRT_MAILDIR_LIMIT_MESSAGE  “virtual_maildir_limit_message”+#define DEF_VIRT_MAILDIR_LIMIT_MESSAGE  “Sorry, the user’s maildir has overdrawn his diskspace quota, please try again later.”+extern char *var_virt_maildir_limit_message;++#define VAR_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS “virtual_maildir_limit_message_maps”+#define DEF_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS “”+extern char *var_virt_maildir_limit_message_maps;++#define VAR_VIRT_MAILDIR_SUFFIX         “virtual_maildir_suffix”+#define DEF_VIRT_MAILDIR_SUFFIX         “”+extern char *var_virt_maildir_suffix;++#define VAR_VIRT_TRASH_COUNT            “virtual_trash_count”+#define DEF_VIRT_TRASH_COUNT            0+extern bool var_virt_trash_count;++#define VAR_VIRT_TRASH_NAME             “virtual_trash_name”+#define DEF_VIRT_TRASH_NAME             “.Trash”+extern char *var_virt_trash_name;++#define VAR_VIRT_MAILDIR_FILTER         “virtual_maildir_filter”+#define DEF_VIRT_MAILDIR_FILTER         0+extern bool var_virt_maildir_filter;++#define VAR_VIRT_MAILDIR_FILTER_MAPS    “virtual_maildir_filter_maps”+#define DEF_VIRT_MAILDIR_FILTER_MAPS    “”+extern char var_virt_maildir_filter_maps;+ #define VAR_VIRT_MINUID			“virtual_minimum_uid” #define DEF_VIRT_MINUID			100 extern int var_virt_minimum_uid;diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;util&#x2F;file_limit.c postfix-2.10.0&#x2F;src&#x2F;util&#x2F;file_limit.c— postfix-2.10.0.orig&#x2F;src&#x2F;util&#x2F;file_limit.c	2003-10-22 20:48:36.000000000 +0200+++ postfix-2.10.0&#x2F;src&#x2F;util&#x2F;file_limit.c	2013-06-07 13:21:22.839143270 +0200@@ -85,7 +85,11 @@ #else     struct rlimit rlim;-    rlim.rlim_cur &#x3D; rlim.rlim_max &#x3D; limit;+    &#x2F; rlim_max can only be changed by root. &#x2F;+    if (getrlimit(RLIMIT_FSIZE, &amp;rlim) &lt; 0)+        msg_fatal(“getrlimit: %m”);+    rlim.rlim_cur &#x3D; limit;+     if (setrlimit(RLIMIT_FSIZE, &amp;rlim) &lt; 0)     msg_fatal(“setrlimit: %m”); #ifdef SIGXFSZdiff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;mailbox.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;mailbox.c— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;mailbox.c	2011-12-24 03:13:32.000000000 +0100+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;mailbox.c	2013-06-07 13:23:03.044139705 +0200@@ -52,6 +52,7 @@ #include &lt;mymalloc.h&gt; #include &lt;stringops.h&gt; #include &lt;set_eugid.h&gt;+#include &lt;iostuff.h&gt; &#x2F; Global library. &#x2F;@@ -70,6 +71,70 @@ #define YES	1 #define NO	0+&#x2F; change_mailbox_limit - change limit for mailbox file *&#x2F;+static int change_mailbox_limit(LOCAL_STATE state, USER_ATTR usr_attr)+{+    char *myname &#x3D; “change_mailbox_limit”;+    const char limit_res;+    long n &#x3D; 0;+    int status &#x3D; NO;++    &#x2F;+     * Look up the virtual mailbox limit size for this user.+     * Fall back to virtual_mailbox_limit in case lookup failed.+     * If virtual mailbox limit size is negative, fall back to virtual_mailbox_limit.+     * If it’s 0, set the mailbox limit to 0, which means unlimited.+     * If it’s more than 0 (positive int), check if the value is smaller than the maximum message size,+     * if it is and the virtual mailbox limit can’t be overridden, fall back to virtual_mailbox_limit and+     * warn the user, else use the value directly as the mailbox limit.+     *&#x2F;+    if (*var_virt_mailbox_limit_maps !&#x3D; 0 &amp;&amp; (limit_res &#x3D; mail_addr_find(virtual_mailbox_limit_maps, state.msg_attr.user, (char **) NULL)) !&#x3D; 0) {+        n &#x3D; atol(limit_res);+        if (n &gt; 0) {+            if ((n &lt; var_message_limit) &amp;&amp; (!var_virt_mailbox_limit_override)) {+                set_file_limit(var_virt_mailbox_limit);+                status &#x3D; NO;++                msg_warn(“%s: recipient %s - virtual mailbox limit is “+                        “smaller than %s in %s - falling back to %s”,+                        myname,+                        state.msg_attr.user,+                        VAR_MESSAGE_LIMIT,+                        virtual_mailbox_limit_maps-&gt;title,+                        VAR_VIRT_MAILBOX_LIMIT);+            }+            else {+                set_file_limit((off_t) n);+                status &#x3D; YES;++                if (msg_verbose)+                    msg_info(“%s: set virtual mailbox limit size for %s to %ld”,+                            myname, usr_attr.mailbox, n);+            }+        }+        else if (n &#x3D;&#x3D; 0) {+                set_file_limit(OFF_T_MAX);+                status &#x3D; YES;++                if (msg_verbose)+                    msg_info(“%s: set virtual mailbox limit size for %s to %ld”,+                            myname, usr_attr.mailbox, OFF_T_MAX);+        }+        else {+            &#x2F;* Invalid limit size (negative). Use default virtual_mailbox_limit. &#x2F;+            set_file_limit(var_virt_mailbox_limit);+            status &#x3D; NO;+        }+    }+    else {+        &#x2F; There is no limit in the maps. Use default virtual_mailbox_limit. &#x2F;+        set_file_limit(var_virt_mailbox_limit);+        status &#x3D; NO;+    }++    return(status);+}+ &#x2F; deliver_mailbox_file - deliver to recipient mailbox &#x2F; static int deliver_mailbox_file(LOCAL_STATE state, USER_ATTR usr_attr)@@ -80,7 +145,6 @@     int     mail_copy_status;     int     deliver_status;     int     copy_flags;-    long    end;     struct stat st;     &#x2F;@@ -132,7 +196,7 @@         msg_warn(“specify &quot;%s &#x3D; no&quot; to ignore mailbox ownership mismatch”,              VAR_STRICT_MBOX_OWNER);     } else {-	    end &#x3D; vstream_fseek(mp-&gt;fp, (off_t) 0, SEEK_END);+	    vstream_fseek(mp-&gt;fp, (off_t) 0, SEEK_END);         mail_copy_status &#x3D; mail_copy(COPY_ATTR(state.msg_attr), mp-&gt;fp,                      copy_flags, “\n”, why);     }@@ -213,62 +277,72 @@      * Look up the mailbox owner rights. Defer in case of trouble.      *&#x2F;     uid_res &#x3D; mail_addr_find(virtual_uid_maps, state.msg_attr.user,-			     IGNORE_EXTENSION);-    if (uid_res &#x3D;&#x3D; 0) {-	msg_warn(“recipient %s: not found in %s”,-		 state.msg_attr.user, virtual_uid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+                            IGNORE_EXTENSION);++    if ((uid_res &#x3D; mail_addr_find(virtual_uid_maps, state.msg_attr.user, (char **) 0)) &#x3D;&#x3D; 0) {+        if ((uid_res &#x3D; maps_find(virtual_uid_maps, strchr(state.msg_attr.user, ‘@’), DICT_FLAG_FIXED)) &#x3D;&#x3D; 0) {+			msg_warn(“recipient %s: not found in %s”, state.msg_attr.user, virtual_uid_maps-&gt;title);+			dsb_simple(why, “4.3.5”, “mail system configuration error”);+			*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+			RETURN(YES);+        }     }+     if ((n &#x3D; atol(uid_res)) &lt; var_virt_minimum_uid) {-	msg_warn(“recipient %s: bad uid %s in %s”,-		 state.msg_attr.user, uid_res, virtual_uid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+		msg_warn(“recipient %s: bad uid %s in %s”, state.msg_attr.user, uid_res, virtual_uid_maps-&gt;title);+		dsb_simple(why, “4.3.5”, “mail system configuration error”);+		statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+		RETURN(YES);     }+     usr_attr.uid &#x3D; (uid_t) n;     &#x2F;      * Look up the mailbox group rights. Defer in case of trouble.      *&#x2F;     gid_res &#x3D; mail_addr_find(virtual_gid_maps, state.msg_attr.user,-			     IGNORE_EXTENSION);-    if (gid_res &#x3D;&#x3D; 0) {-	msg_warn(“recipient %s: not found in %s”,-		 state.msg_attr.user, virtual_gid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+                            IGNORE_EXTENSION);++    if ((gid_res &#x3D; mail_addr_find(virtual_gid_maps, state.msg_attr.user, (char **) 0)) &#x3D;&#x3D; 0) {+        if ((gid_res &#x3D; maps_find(virtual_gid_maps, strchr(state.msg_attr.user, ‘@’), DICT_FLAG_FIXED)) &#x3D;&#x3D; 0) {+			msg_warn(“recipient %s: not found in %s”, state.msg_attr.user, virtual_gid_maps-&gt;title);+			dsb_simple(why, “4.3.5”, “mail system configuration error”);+			*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+			RETURN(YES);+        }     }+     if ((n &#x3D; atol(gid_res)) &lt;&#x3D; 0) {-	msg_warn(“recipient %s: bad gid %s in %s”,-		 state.msg_attr.user, gid_res, virtual_gid_maps-&gt;title);-	dsb_simple(why, “4.3.5”, “mail system configuration error”);-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),-				BOUNCE_ATTR(state.msg_attr));-	RETURN(YES);+		msg_warn(“recipient %s: bad gid %s in %s”, state.msg_attr.user, gid_res, virtual_gid_maps-&gt;title);+		dsb_simple(why, “4.3.5”, “mail system configuration error”);+		statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));+		RETURN(YES);     }+     usr_attr.gid &#x3D; (gid_t) n;     if (msg_verbose)-	msg_info(“%s[%d]: set user_attr: %s, uid &#x3D; %u, gid &#x3D; %u”,-		 myname, state.level, usr_attr.mailbox,-		 (unsigned) usr_attr.uid, (unsigned) usr_attr.gid);+        msg_info(“%s[%d]: set user_attr: %s, uid &#x3D; %u, gid &#x3D; %u”,+                myname, state.level, usr_attr.mailbox,+                (unsigned) usr_attr.uid, (unsigned) usr_attr.gid);     &#x2F;      * Deliver to mailbox or to maildir.      *&#x2F; #define LAST_CHAR(s) (s[strlen(s) - 1])-    if (LAST_CHAR(usr_attr.mailbox) &#x3D;&#x3D; ‘&#x2F;‘)-	*statusp &#x3D; deliver_maildir(state, usr_attr);-    else-	*statusp &#x3D; deliver_mailbox_file(state, usr_attr);+    if (LAST_CHAR(usr_attr.mailbox) &#x3D;&#x3D; ‘&#x2F;‘) {+        statusp &#x3D; deliver_maildir(state, usr_attr);+    }+    else {+        int changed_limit;++        changed_limit &#x3D; change_mailbox_limit(state, usr_attr);+        statusp &#x3D; deliver_mailbox_file(state, usr_attr);++        if (changed_limit)+            set_file_limit(var_virt_mailbox_limit);+    }     &#x2F;      * Cleanup.diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;maildir.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;maildir.c— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;maildir.c	2012-01-25 01:41:08.000000000 +0100+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;maildir.c	2013-06-07 13:21:22.840143270 +0200@@ -64,28 +64,420 @@ #include &lt;mbox_open.h&gt; #include &lt;dsn_util.h&gt;+&#x2F; Patch library. &#x2F;++#include &lt;sys&#x2F;types.h&gt; &#x2F; opendir(3), stat(2) &#x2F;+#include &lt;sys&#x2F;stat.h&gt;  &#x2F; stat(2) &#x2F;+#include &lt;dirent.h&gt;    &#x2F; opendir(3) &#x2F;+#include &lt;unistd.h&gt;    &#x2F; stat(2) &#x2F;+#include &lt;stdlib.h&gt;    &#x2F; atol(3) &#x2F;+#include &lt;string.h&gt;    &#x2F; strrchr(3) &#x2F;+#include &lt;vstring_vstream.h&gt;+#include &lt;dict.h&gt;+#include &lt;dict_regexp.h&gt;+#include &lt;ctype.h&gt;+#include &lt;stdio.h&gt;+#include &lt;sys_defs.h&gt;+#include &lt;mail_addr_find.h&gt;+ &#x2F; Application-specific. &#x2F; #include “virtual.h”-&#x2F; deliver_maildir - delivery to maildir-style mailbox &#x2F;+&#x2F; Maildirsize maximal size. &#x2F;++#define SIZEFILE_MAX 5120++&#x2F;+ * Chris Stratford &#x63;&#x68;&#114;&#x69;&#x73;&#115;&#64;&#112;&#x69;&#x70;&#x65;&#120;&#x2e;&#x6e;&#x65;&#116;+ * Read the maildirsize file to get quota info.+ *+ * Arguments:+ *  dirname: the maildir+ *  countptr: number of messages+ *+ * Returns the size of all mails as read from maildirsize,+ * zero if it couldn’t read the file.+ *&#x2F;+static long read_maildirsize(char *filename, long *sumptr, long *countptr)+{+    char *myname &#x3D; “read_maildirsize”;+    struct stat statbuf;+    VSTREAM *sizefile;+    char *p;+    int len, first;+    long sum &#x3D; 0, count &#x3D; 0, ret_value &#x3D; -1;++    if (msg_verbose)+	msg_info(“%s: we will use sizefile &#x3D; ‘%s’”, myname, filename);+	+    sizefile &#x3D; vstream_fopen(filename, O_RDONLY, 0);+    if (!sizefile) {+	if (msg_verbose)+	    msg_info(“%s: cannot open %s: %m (maybe file does not exist)”, myname, filename);+	+	return -1;+    } else if (stat(filename, &amp;statbuf) &lt; 0 || statbuf.st_size &gt; SIZEFILE_MAX) {+        if (sizefile) {+            vstream_fclose(sizefile);+            unlink(filename);+        }++        if (msg_verbose)+	    msg_info(“%s: stat() returned &lt; 0 or filesize &gt; SIZEFILE_MAX (filename &#x3D; %s, filesize &#x3D; %ld)”, myname, filename, statbuf.st_size);++        return -1;+    }++    VSTRING *sizebuf &#x3D; vstring_alloc(SIZEFILE_MAX);+    len &#x3D; vstream_fread(sizefile, STR(sizebuf), SIZEFILE_MAX);++    p &#x3D; STR(sizebuf);+    *(p + len) &#x3D; ‘\0’;+    first &#x3D; 1;++    while (*p) {+        long n &#x3D; 0, c &#x3D; 0;+        char *q &#x3D; p;++        while (*p) {+            if (p++ &#x3D;&#x3D; ‘\n’) {+                p[-1] &#x3D; 0;+                break;+            }+        }++        if (first) {+            first &#x3D; 0;+            continue;+        }++        if (sscanf(q, “%ld %ld”, &amp;n, &amp;c) &#x3D;&#x3D; 2) {+            sum +&#x3D; n;+            count +&#x3D; c;+            &#x2F; if (msg_verbose)+    		msg_info(“%s: we read line ‘%s’, totals: sum &#x3D; %ld, count &#x3D; %ld”, myname, q, sum, count); *&#x2F;+        }+        else {+            vstream_fclose(sizefile);+            unlink(filename);+            msg_warn(“%s: invalid line ‘%s’ found in %s, removing maildirsize file”, myname, q, filename);+            vstring_free(sizebuf);++            return -1;+        }+    }++    *countptr &#x3D; count;+    *sumptr &#x3D; sum;++    if (sum &lt; 0 || count &lt; 0 || (sum &#x3D;&#x3D; 0 &amp;&amp; count !&#x3D; 0) || (sum !&#x3D; 0 &amp;&amp; count &#x3D;&#x3D; 0)) {+	if (msg_verbose) {+	    msg_info(“%s: we will return -1 and unlink %s, because file count or sum is &lt;&#x3D; 0 (sum &#x3D; %ld, count &#x3D; %ld)”, myname, filename, sum, count);+	}+	+	unlink(filename);+	ret_value &#x3D; -1;+    } else {+	if (msg_verbose)+	    msg_info(“%s: we will return Maildir size &#x3D; %ld, count &#x3D; %ld”, myname, *sumptr, *countptr);++	ret_value &#x3D; sum;	+    }++    vstream_fclose(sizefile);+    vstring_free(sizebuf);++    return ret_value;+}++&#x2F;*+ * Gives the size of the file according to the Maildir++ extension+ * present in the filename (code taken from courier-imap).+ *+ * Arguments:+ *  n: filename+ *+ * Returns the size given in “,S&#x3D;“ in the filename,+ * zero if it cannot find “,S&#x3D;“ in the filename.+ *&#x2F;+static long maildir_parsequota(const char *n)+{+    const char *o;+    int yes &#x3D; 0;++    if ((o &#x3D; strrchr(n, ‘&#x2F;‘)) &#x3D;&#x3D; 0)+        o &#x3D; n;++    for (; *o; o++) {+        if (*o &#x3D;&#x3D; ‘:’)+            break;+    }++    for (; o &gt;&#x3D; n; –o) {+        if (*o &#x3D;&#x3D; ‘&#x2F;‘)+            break;++        if (*o &#x3D;&#x3D; ‘,’ &amp;&amp; o[1] &#x3D;&#x3D; ‘S’ &amp;&amp; o[2] &#x3D;&#x3D; ‘&#x3D;’) {+            yes &#x3D; 1;+            o +&#x3D; 3;+            break;+        }+    }++    if (yes) {+        long s &#x3D; 0;++        while (*o &gt;&#x3D; ‘0’ &amp;&amp; *o &lt;&#x3D; ‘9’)+            s &#x3D; s*10 + (*o++ - ‘0’);++        return s;+    }++    return 0;+}++&#x2F;*+ * Computes quota usage for a directory (taken from exim).+ *+ * This function is called to determine the exact quota usage of a virtual+ * maildir box. To achieve maximum possible speed while doing this, it takes+ * advantage of the maildirsize file and the Maildir++ extensions to filenames,+ * when applicable and configured to be used. In all other cases it simply+ * stats all the files as needed to get the size information.+ *+ * Arguments:+ *  dirname: the name of the directory+ *  countptr: where to add the file count (because this function recurses)+ *+ * Returns the sum of the sizes of all measurable files,+ * zero if the directory could not be opened.+ *&#x2F;+static long check_dir_size(char *dirname, long *countptr)+{+    char *myname &#x3D; “check_dir_size”;+    DIR *dir;+    long sum &#x3D; 0;+    struct dirent *ent;+    struct stat statbuf;++    dir &#x3D; opendir(dirname);+    if (dir &#x3D;&#x3D; NULL) {+        if (make_dirs(dirname, 0700) &#x3D;&#x3D; 0) {    &#x2F;* Try to create the dirs. *&#x2F;+            dir &#x3D; opendir(dirname);             &#x2F;* Reopen the dir. *&#x2F;+            if (dir &#x3D;&#x3D; NULL) {+                msg_warn(“%s: cannot reopen directory: %s”, myname, dirname);+                return 0;+            }+        }+        else {+            msg_warn(“%s: cannot open directory: %s”, myname, dirname);+            return 0;+        }+    }++    while ((ent &#x3D; readdir(dir)) !&#x3D; NULL) {+        char *name &#x3D; ent-&gt;d_name;+        long tmpsum &#x3D; 0;+        VSTRING buffer;++	&#x2F; do not count dot a double-dot dirs &#x2F;+        if (strcmp(name, “.”) &#x3D;&#x3D; 0 || strcmp(name, “..”) &#x3D;&#x3D; 0)+            continue;+        &#x2F; do not count if this is the trash subdir and if we should NOT count it &#x2F;+	else if (var_virt_trash_count &#x3D;&#x3D; 0 &amp;&amp; strcmp(name, var_virt_trash_name) &#x3D;&#x3D; 0)+    	    continue;++        &#x2F;+         * Here comes the real logic behind this function.+         * Optimized to be the most efficient possible,+         * depending on the settings given.+         * See above for a more detailed description.+         *&#x2F;+        if (var_virt_mailbox_limit_inbox) {+            if (var_virt_maildir_extended &amp;&amp; (tmpsum &#x3D; maildir_parsequota(name))) {+                sum +&#x3D; tmpsum;+                (countptr)++;+            }+            else {+                buffer &#x3D; vstring_alloc(1024);+                vstring_sprintf(buffer, “%s&#x2F;%s”, dirname, name);++                if (stat(STR(buffer), &amp;statbuf) &lt; 0) {+                    vstring_free(buffer);+                    continue;+                }+                if ((statbuf.st_mode &amp; S_IFREG) !&#x3D; 0) {+                    sum +&#x3D; (long) statbuf.st_size;+                    (*countptr)++;+                }++                vstring_free(buffer);+            }+        }+        else {+            buffer &#x3D; vstring_alloc(1024);+            vstring_sprintf(buffer, “%s&#x2F;%s”, dirname, name);++            if (stat(STR(buffer), &amp;statbuf) &lt; 0) {+                vstring_free(buffer);+                continue;+            }+            if ((statbuf.st_mode &amp; S_IFREG) !&#x3D; 0) {+                if (strcmp(dirname + strlen(dirname) - 3, “new”) &#x3D;&#x3D; 0 || strcmp(dirname + strlen(dirname) - 3, “cur”) &#x3D;&#x3D; 0 || strcmp(dirname + strlen(dirname) - 3, “tmp”) &#x3D;&#x3D; 0) {+                    sum +&#x3D; (long) statbuf.st_size;+                    (*countptr)++;+                }+            }+            else if ((statbuf.st_mode &amp; S_IFDIR) !&#x3D; 0) {+                sum +&#x3D; check_dir_size(STR(buffer), countptr);+            }++            vstring_free(buffer);+        }+    }+    closedir(dir);-int     deliver_maildir(LOCAL_STATE state, USER_ATTR usr_attr)+    if (msg_verbose)+        msg_info(“%s: full scan done: dir&#x3D;%s sum&#x3D;%ld count&#x3D;%ld”, myname, dirname, sum, *countptr);++    return sum;+}++&#x2F;* Cut all occurrences of pattern from string. *&#x2F;+static char *strcut(char *str, const char *pat)+{+    char *ptr, *loc, *ret;+    ret &#x3D; str;+    loc &#x3D; str;++    &#x2F;* No match, return original string. *&#x2F;+    if (!strstr(loc, pat))+        return(str);++    while (*loc &amp;&amp; (ptr &#x3D; strstr(loc, pat))) {+        while (loc &lt; ptr)+            *str++ &#x3D; *loc++;+        loc +&#x3D; strlen(pat);+    }++    while (*loc)+        *str++ &#x3D; *loc++;++    *str &#x3D; 0;++    return(ret);+}++&#x2F;* Check if maildirfilter file is up-to-date compared to SQL, (re)write it if not. *&#x2F;+static long sql2file(char *filename, char *user)+{+    char *myname &#x3D; “sql2file”;+    char *filter_sqlres;+    char filter_fileres[128];+    long sqlmtime &#x3D; 0, filemtime &#x3D; 0, retval &#x3D; 0;+    int filterfile, size_sqlres, i;+    struct stat statbuf;++    if (*var_virt_maildir_filter_maps !&#x3D; 0) {+        filter_sqlres &#x3D; (char *) mymalloc(16000);+        filter_sqlres &#x3D; (char *) mail_addr_find(virtual_maildir_filter_maps, user, (char **) 0);++        if (filter_sqlres) {+            strcut(filter_sqlres, “\r”);+            if (filter_sqlres[0] &#x3D;&#x3D; ‘#’ &amp;&amp; filter_sqlres[1] &#x3D;&#x3D; ‘ ‘ &amp;&amp; filter_sqlres[2] &#x3D;&#x3D; ‘M’) {+                size_sqlres &#x3D; strlen(filter_sqlres);++                for (i &#x3D; 4; i &lt;&#x3D; size_sqlres; i++) {+                    if(filter_sqlres[i] &#x3D;&#x3D; ‘&#x2F;‘ &amp;&amp; filter_sqlres[i+1] &#x3D;&#x3D; ‘^’) {+                        filter_sqlres[i-1] &#x3D; ‘\n’;+                    }+                }++                filter_sqlres[(size_sqlres+1)] &#x3D; ‘\0’;++                sqlmtime &#x3D; atol(filter_sqlres+3);+                retval &#x3D; sqlmtime;++                filterfile &#x3D; open(filename, O_RDONLY, 0);+                if (filterfile) {+                    read(filterfile, (void *) filter_fileres, 127);+                    close(filterfile);++                    filemtime &#x3D; atol(filter_fileres+3);+                }++                if (msg_verbose)+                    msg_info(“%s: filter data: sql_size&#x3D;%li sql_mtime&#x3D;%ld file_mtime&#x3D;%ld”, myname, strlen(filter_sqlres), sqlmtime, filemtime);+            }+            if (sqlmtime !&#x3D; filemtime &amp;&amp; sqlmtime !&#x3D; 0) {+                if ((filterfile &#x3D; open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0640))) {+                    if (msg_verbose)+                        msg_info(“%s: updating filter file: %s”, myname, filename);+                    write(filterfile, filter_sqlres, strlen(filter_sqlres));+                    close(filterfile);+                }+                else {+                    msg_warn(“%s: can’t create filter file: %s”, myname, filename);+                    retval &#x3D; 0;+                }+            }+        }+    }+    else {+        if (stat(filename, &amp;statbuf) &#x3D;&#x3D; 0)+            retval &#x3D; (long) statbuf.st_mtime;+        if (msg_verbose)+            msg_info(“%s: processing filter file: file_mtime&#x3D;%ld”, myname, retval);+    }++    return retval;+}++&#x2F;* deliver_maildir - delivery to maildir-style mailbox *&#x2F;+int deliver_maildir(LOCAL_STATE state, USER_ATTR usr_attr) {     const char *myname &#x3D; “deliver_maildir”;-    char   *newdir;-    char   *tmpdir;-    char   *curdir;-    char   *tmpfile;-    char   *newfile;+    char    *newdir;+    char    *tmpdir;+    char    *curdir;+    char    *newfile;+    char    *tmpfile;     DSN_BUF *why &#x3D; state.msg_attr.why;     VSTRING *buf;     VSTREAM *dst;-    int     mail_copy_status;-    int     deliver_status;-    int     copy_flags;-    struct stat st;-    struct timeval starttime;+    int      mail_copy_status;+    int      deliver_status;+    int      copy_flags;+    struct   stat st;+    struct   timeval starttime;++    &#x2F;* Maildir Quota. *&#x2F;+    const char *limit_res;              &#x2F;* Limit from map. *&#x2F;+    char    *sizefilename &#x3D; (char *) 0; &#x2F;* Maildirsize file name. *&#x2F;+    VSTRING *filequota;                 &#x2F;* Quota setting from the maildirsize file. *&#x2F;+    VSTREAM *sizefile;                  &#x2F;* Maildirsize file handle. *&#x2F;+    long     n &#x3D; 0;                     &#x2F;* Limit in long integer format. *&#x2F;+    long     saved_count &#x3D; 0;           &#x2F;* The total number of files. *&#x2F;+    long     saved_size &#x3D; 0;            &#x2F;* The total quota of all files. *&#x2F;+    struct   stat mail_stat;            &#x2F;* To check the size of the mail to be written. *&#x2F;+    struct   stat sizefile_stat;        &#x2F;* To check the size of the maildirsize file. *&#x2F;+    time_t   tm;                        &#x2F;* To check the age of the maildirsize file. *&#x2F;++    &#x2F;* Maildir Filters. *&#x2F;+    const char *value, *cmd_text;       &#x2F;* Filter values. *&#x2F;+    char    *filtername;+    char    *header;+    char    *bkpnewfile;+    char    *mdffilename &#x3D; (char *) 0;  &#x2F;* Maildirfolder file name. *&#x2F;+    VSTRING *fltstr;+    VSTREAM *tmpfilter;+    VSTREAM *mdffile;                   &#x2F;* Maildirfolder file handle. *&#x2F;+    DICT    *FILTERS;+    long     sqlmtime;                  &#x2F;* Latest modification time from sql2file(). *&#x2F;+    int      cmd_len;+    int	    read_mds &#x3D; -1;		&#x2F;* read_maildirsize() returned value *&#x2F;+    struct   stat mdffile_stat;         &#x2F;* To check if the maildirfolder file exists. *&#x2F;     GETTIMEOFDAY(&amp;starttime);@@ -94,15 +486,14 @@      *&#x2F;     state.level++;     if (msg_verbose)-	MSG_LOG_STATE(myname, state);+	    MSG_LOG_STATE(myname, state);     &#x2F;*      * Don’t deliver trace-only requests.      *&#x2F;     if (DEL_REQ_TRACE_ONLY(state.request-&gt;flags)) {-	dsb_simple(why, “2.0.0”, “delivers to maildir”);-	return (sent(BOUNCE_FLAGS(state.request),-		     SENT_ATTR(state.msg_attr)));+        dsb_simple(why, “2.0.0”, “delivers to maildir”);+        return (sent(BOUNCE_FLAGS(state.request), SENT_ATTR(state.msg_attr)));     }     &#x2F;@@ -110,18 +501,116 @@      * attribute to reflect the final recipient.      &#x2F;     if (vstream_fseek(state.msg_attr.fp, state.msg_attr.offset, SEEK_SET) &lt; 0)-	msg_fatal(“seek message file %s: %m”, VSTREAM_PATH(state.msg_attr.fp));+        msg_fatal(“seek message file %s: %m”, VSTREAM_PATH(state.msg_attr.fp));     state.msg_attr.delivered &#x3D; state.msg_attr.rcpt.address;     mail_copy_status &#x3D; MAIL_COPY_STAT_WRITE;     buf &#x3D; vstring_alloc(100);-    copy_flags &#x3D; MAIL_COPY_TOFILE | MAIL_COPY_RETURN_PATH-	| MAIL_COPY_DELIVERED | MAIL_COPY_ORIG_RCPT;+    copy_flags &#x3D; MAIL_COPY_TOFILE | MAIL_COPY_RETURN_PATH | MAIL_COPY_DELIVERED | MAIL_COPY_ORIG_RCPT;-    newdir &#x3D; concatenate(usr_attr.mailbox, “new&#x2F;“, (char *) 0);-    tmpdir &#x3D; concatenate(usr_attr.mailbox, “tmp&#x2F;“, (char *) 0);-    curdir &#x3D; concatenate(usr_attr.mailbox, “cur&#x2F;“, (char *) 0);+    &#x2F;*+     * Concatenate the maildir suffix (if set).+     *&#x2F;+    if (*var_virt_maildir_suffix &#x3D;&#x3D; 0) {+        newdir &#x3D; concatenate(usr_attr.mailbox, “new&#x2F;“, (char *) 0);+        tmpdir &#x3D; concatenate(usr_attr.mailbox, “tmp&#x2F;“, (char *) 0);+        curdir &#x3D; concatenate(usr_attr.mailbox, “cur&#x2F;“, (char *) 0);+    }+    else {+        newdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        tmpdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        curdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        newdir &#x3D; concatenate(newdir, “new&#x2F;“, (char *) 0);+        tmpdir &#x3D; concatenate(tmpdir, “tmp&#x2F;“, (char *) 0);+        curdir &#x3D; concatenate(curdir, “cur&#x2F;“, (char *) 0);+    }+    &#x2F;* get the sizefilename, no matter if we use var_virt_maildir_extended *&#x2F;+    if (*var_virt_maildir_suffix &#x3D;&#x3D; 0) {+        sizefilename &#x3D; concatenate(usr_attr.mailbox, “maildirsize”, (char *) 0);+    } else {+        sizefilename &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);+        sizefilename &#x3D; concatenate(sizefilename, “maildirsize”, (char *) 0);+    }++    &#x2F;*+     * Look up the virtual maildir limit size for this user.+     * Fall back to virtual_mailbox_limit in case lookup failed.+     * If virtual maildir limit size is negative, fall back to virtual_mailbox_limit.+     * If it’s 0, set the mailbox limit to 0, which means unlimited.+     * If it’s more than 0 (positive int), check if the value is smaller than the maximum message size,+     * if it is and the virtual maildir limit can’t be overridden, fall back to virtual_mailbox_limit and+     * warn the user, else use the value directly as the maildir limit.+     *&#x2F;+    if (*var_virt_mailbox_limit_maps !&#x3D; 0 &amp;&amp; (limit_res &#x3D; mail_addr_find(virtual_mailbox_limit_maps, state.msg_attr.user, (char **) NULL)) !&#x3D; 0) {+        n &#x3D; atol(limit_res);+        if (n &gt; 0) {+            if ((n &lt; var_message_limit) &amp;&amp; (!var_virt_mailbox_limit_override)) {+                n &#x3D; var_virt_mailbox_limit;++                msg_warn(“%s: recipient %s - virtual maildir limit is smaller than %s in %s - falling back to %s”,+                        myname, state.msg_attr.user, VAR_MESSAGE_LIMIT, virtual_mailbox_limit_maps-&gt;title,+                        VAR_VIRT_MAILBOX_LIMIT);+            }+            else {+                if (msg_verbose)+                    msg_info(“%s: set virtual maildir limit size for %s to %ld”,+                            myname, usr_attr.mailbox, n);+            }+        }+        else if (n &#x3D;&#x3D; 0) {+                if (msg_verbose)+                    msg_info(“%s: set virtual maildir limit size for %s to %ld”,+                            myname, usr_attr.mailbox, n);+        }+        else {+	    if (msg_verbose)+		msg_info(“%s: quota is negative (%ld), using default virtual_mailbox_limit (%ld)”,+			    myname, n, var_virt_mailbox_limit);+            &#x2F; Invalid limit size (negative). Use default virtual_mailbox_limit. &#x2F;+            n &#x3D; var_virt_mailbox_limit;+        }+    }+    else {+	if (msg_verbose)+	    msg_info(“%s: no limit found in the maps, using default virtual_mailbox_limit (%ld)”,+			myname, var_virt_mailbox_limit);+        &#x2F; There is no limit in the maps. Use default virtual_mailbox_limit. &#x2F;+        n &#x3D; var_virt_mailbox_limit;+    }++    &#x2F; If there should is a quota on maildir generaly, check it before delivering the mail &#x2F;+    if (n !&#x3D; 0) {+        set_eugid(usr_attr.uid, usr_attr.gid);+	&#x2F; try to read the quota from maildirsize file. Returned values by read_maildirsize:+	x &lt; 0  &#x3D; something failed+	x &gt;&#x3D; 0 &#x3D; reading successfully finished - sum si returned, so sum size of Maildir was 0 or more &#x2F;+        if (!var_virt_mailbox_limit_inbox &amp;&amp; var_virt_maildir_extended &amp;&amp; (read_mds &#x3D; read_maildirsize(sizefilename, &amp;saved_size, &amp;saved_count)) &gt;&#x3D; 0) {+    	    if (msg_verbose)+        	msg_info(“%s: maildirsize used&#x3D;%s sum&#x3D;%ld count&#x3D;%ld”, myname, sizefilename, saved_size, saved_count);+	} else {+	    if (msg_verbose)+		msg_info(“%s: We will recount the quota (var_virt_mailbox_limit &#x3D; %ld, var_virt_maildir_extended &#x3D; %d, read_maildirsize &#x3D; %d)”,+			    myname, var_virt_mailbox_limit, var_virt_maildir_extended, read_mds);++	    &#x2F; sanity &#x2F;+	    saved_size &#x3D; 0;+	    saved_count &#x3D; 0;+	+    	    if (var_virt_mailbox_limit_inbox) {+        	&#x2F; Check Inbox only (new, cur and tmp dirs). &#x2F;+        	saved_size &#x3D; check_dir_size(newdir, &amp;saved_count);+        	saved_size +&#x3D; check_dir_size(curdir, &amp;saved_count);+        	saved_size +&#x3D; check_dir_size(tmpdir, &amp;saved_count);+    	    } else {+        	&#x2F; Check all boxes. &#x2F;+        	saved_size &#x3D; check_dir_size(usr_attr.mailbox, &amp;saved_count);+    	    }++    	    set_eugid(var_owner_uid, var_owner_gid);+    	}    	+    }+     &#x2F;      * Create and write the file as the recipient, so that file quota work.      * Create any missing directories on the fly. The file name is chosen@@ -175,46 +664,288 @@      * […]      *&#x2F;     set_eugid(usr_attr.uid, usr_attr.gid);-    vstring_sprintf(buf, “%lu.P%d.%s”,-		 (unsigned long) starttime.tv_sec, var_pid, get_hostname());+    vstring_sprintf(buf, “%lu.P%d.%s”, (unsigned long) starttime.tv_sec, var_pid, get_hostname());     tmpfile &#x3D; concatenate(tmpdir, STR(buf), (char *) 0);     newfile &#x3D; 0;+    bkpnewfile &#x3D; 0;     if ((dst &#x3D; vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) &#x3D;&#x3D; 0-	&amp;&amp; (errno !&#x3D; ENOENT-	    || make_dirs(tmpdir, 0700) &lt; 0-	    || (dst &#x3D; vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) &#x3D;&#x3D; 0)) {-	dsb_simple(why, mbox_dsn(errno, “4.2.0”),-		   “create maildir file %s: %m”, tmpfile);-    } else if (fstat(vstream_fileno(dst), &amp;st) &lt; 0) {"></a>diff -uNr postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README<br>— postfix-2.10.0.orig&#x2F;README_FILES&#x2F;VDA_README	1970-01-01 01:00:00.000000000 +0100<br>+++ postfix-2.10.0&#x2F;README_FILES&#x2F;VDA_README	2013-06-07 13:21:22.837143270 +0200<br>@@ -0,0 +1,10 @@<br>+Postfix VDA patch for maildir++ quota support by<br>+    Anderson Nadal <a href="mailto:&#x61;&#x6e;&#x64;&#x65;&#x72;&#x6e;&#97;&#100;&#x61;&#x6c;&#x40;&#103;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;">&#x61;&#x6e;&#x64;&#x65;&#x72;&#x6e;&#97;&#100;&#x61;&#x6c;&#x40;&#103;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;</a><br>+    Tomas Macek <a href="mailto:&#x6d;&#x61;&#x63;&#x61;&#x30;&#50;&#x40;&#97;&#116;&#x6c;&#x61;&#x73;&#46;&#x63;&#122;">&#x6d;&#x61;&#x63;&#x61;&#x30;&#50;&#x40;&#97;&#116;&#x6c;&#x61;&#x73;&#46;&#x63;&#122;</a><br>+    Lucca Longinotti<br>+<br>+See VDA patch official website <a target="_blank" rel="noopener" href="http://vda.sf.net/">http://vda.sf.net</a> for instructions<br>+howto patch the Postfix’s sourcetree and configure the options<br>+provided by this patch.<br>+<br>+<br>diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;global&#x2F;mail_params.h postfix-2.10.0&#x2F;src&#x2F;global&#x2F;mail_params.h<br>— postfix-2.10.0.orig&#x2F;src&#x2F;global&#x2F;mail_params.h	2013-02-03 19:22:21.000000000 +0100<br>+++ postfix-2.10.0&#x2F;src&#x2F;global&#x2F;mail_params.h	2013-06-07 13:21:22.838143270 +0200<br>@@ -2367,6 +2367,54 @@<br> #define DEF_VIRT_GID_MAPS		“”<br> extern char *var_virt_gid_maps;<br><br>+#define VAR_VIRT_MAILBOX_LIMIT_MAPS     “virtual_mailbox_limit_maps”<br>+#define DEF_VIRT_MAILBOX_LIMIT_MAPS     “”<br>+extern char *var_virt_mailbox_limit_maps;<br>+<br>+#define VAR_VIRT_MAILBOX_LIMIT_INBOX    “virtual_mailbox_limit_inbox”<br>+#define DEF_VIRT_MAILBOX_LIMIT_INBOX    0<br>+extern bool var_virt_mailbox_limit_inbox;<br>+<br>+#define VAR_VIRT_MAILBOX_LIMIT_OVERRIDE “virtual_mailbox_limit_override”<br>+#define DEF_VIRT_MAILBOX_LIMIT_OVERRIDE 0<br>+extern bool var_virt_mailbox_limit_override;<br>+<br>+#define VAR_VIRT_MAILDIR_EXTENDED       “virtual_maildir_extended”<br>+#define DEF_VIRT_MAILDIR_EXTENDED       0<br>+extern bool var_virt_maildir_extended;<br>+<br>+#define VAR_VIRT_OVERQUOTA_BOUNCE       “virtual_overquota_bounce”<br>+#define DEF_VIRT_OVERQUOTA_BOUNCE       0<br>+extern bool var_virt_overquota_bounce;<br>+<br>+#define VAR_VIRT_MAILDIR_LIMIT_MESSAGE  “virtual_maildir_limit_message”<br>+#define DEF_VIRT_MAILDIR_LIMIT_MESSAGE  “Sorry, the user’s maildir has overdrawn his diskspace quota, please try again later.”<br>+extern char *var_virt_maildir_limit_message;<br>+<br>+#define VAR_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS “virtual_maildir_limit_message_maps”<br>+#define DEF_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS “”<br>+extern char *var_virt_maildir_limit_message_maps;<br>+<br>+#define VAR_VIRT_MAILDIR_SUFFIX         “virtual_maildir_suffix”<br>+#define DEF_VIRT_MAILDIR_SUFFIX         “”<br>+extern char *var_virt_maildir_suffix;<br>+<br>+#define VAR_VIRT_TRASH_COUNT            “virtual_trash_count”<br>+#define DEF_VIRT_TRASH_COUNT            0<br>+extern bool var_virt_trash_count;<br>+<br>+#define VAR_VIRT_TRASH_NAME             “virtual_trash_name”<br>+#define DEF_VIRT_TRASH_NAME             “.Trash”<br>+extern char *var_virt_trash_name;<br>+<br>+#define VAR_VIRT_MAILDIR_FILTER         “virtual_maildir_filter”<br>+#define DEF_VIRT_MAILDIR_FILTER         0<br>+extern bool var_virt_maildir_filter;<br>+<br>+#define VAR_VIRT_MAILDIR_FILTER_MAPS    “virtual_maildir_filter_maps”<br>+#define DEF_VIRT_MAILDIR_FILTER_MAPS    “”<br>+extern char <em>var_virt_maildir_filter_maps;<br>+<br> #define VAR_VIRT_MINUID			“virtual_minimum_uid”<br> #define DEF_VIRT_MINUID			100<br> extern int var_virt_minimum_uid;<br>diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;util&#x2F;file_limit.c postfix-2.10.0&#x2F;src&#x2F;util&#x2F;file_limit.c<br>— postfix-2.10.0.orig&#x2F;src&#x2F;util&#x2F;file_limit.c	2003-10-22 20:48:36.000000000 +0200<br>+++ postfix-2.10.0&#x2F;src&#x2F;util&#x2F;file_limit.c	2013-06-07 13:21:22.839143270 +0200<br>@@ -85,7 +85,11 @@<br> #else<br>     struct rlimit rlim;<br><br>-    rlim.rlim_cur &#x3D; rlim.rlim_max &#x3D; limit;<br>+    &#x2F;</em> rlim_max can only be changed by root. <em>&#x2F;<br>+    if (getrlimit(RLIMIT_FSIZE, &amp;rlim) &lt; 0)<br>+        msg_fatal(“getrlimit: %m”);<br>+    rlim.rlim_cur &#x3D; limit;<br>+<br>     if (setrlimit(RLIMIT_FSIZE, &amp;rlim) &lt; 0)<br>     msg_fatal(“setrlimit: %m”);<br> #ifdef SIGXFSZ<br>diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;mailbox.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;mailbox.c<br>— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;mailbox.c	2011-12-24 03:13:32.000000000 +0100<br>+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;mailbox.c	2013-06-07 13:23:03.044139705 +0200<br>@@ -52,6 +52,7 @@<br> #include &lt;mymalloc.h&gt;<br> #include &lt;stringops.h&gt;<br> #include &lt;set_eugid.h&gt;<br>+#include &lt;iostuff.h&gt;<br><br> &#x2F;</em> Global library. <em>&#x2F;<br><br>@@ -70,6 +71,70 @@<br> #define YES	1<br> #define NO	0<br><br>+&#x2F;</em> change_mailbox_limit - change limit for mailbox file *&#x2F;<br>+static int change_mailbox_limit(LOCAL_STATE state, USER_ATTR usr_attr)<br>+{<br>+    char *myname &#x3D; “change_mailbox_limit”;<br>+    const char <em>limit_res;<br>+    long n &#x3D; 0;<br>+    int status &#x3D; NO;<br>+<br>+    &#x2F;</em><br>+     * Look up the virtual mailbox limit size for this user.<br>+     * Fall back to virtual_mailbox_limit in case lookup failed.<br>+     * If virtual mailbox limit size is negative, fall back to virtual_mailbox_limit.<br>+     * If it’s 0, set the mailbox limit to 0, which means unlimited.<br>+     * If it’s more than 0 (positive int), check if the value is smaller than the maximum message size,<br>+     * if it is and the virtual mailbox limit can’t be overridden, fall back to virtual_mailbox_limit and<br>+     * warn the user, else use the value directly as the mailbox limit.<br>+     *&#x2F;<br>+    if (*var_virt_mailbox_limit_maps !&#x3D; 0 &amp;&amp; (limit_res &#x3D; mail_addr_find(virtual_mailbox_limit_maps, state.msg_attr.user, (char **) NULL)) !&#x3D; 0) {<br>+        n &#x3D; atol(limit_res);<br>+        if (n &gt; 0) {<br>+            if ((n &lt; var_message_limit) &amp;&amp; (!var_virt_mailbox_limit_override)) {<br>+                set_file_limit(var_virt_mailbox_limit);<br>+                status &#x3D; NO;<br>+<br>+                msg_warn(“%s: recipient %s - virtual mailbox limit is “<br>+                        “smaller than %s in %s - falling back to %s”,<br>+                        myname,<br>+                        state.msg_attr.user,<br>+                        VAR_MESSAGE_LIMIT,<br>+                        virtual_mailbox_limit_maps-&gt;title,<br>+                        VAR_VIRT_MAILBOX_LIMIT);<br>+            }<br>+            else {<br>+                set_file_limit((off_t) n);<br>+                status &#x3D; YES;<br>+<br>+                if (msg_verbose)<br>+                    msg_info(“%s: set virtual mailbox limit size for %s to %ld”,<br>+                            myname, usr_attr.mailbox, n);<br>+            }<br>+        }<br>+        else if (n &#x3D;&#x3D; 0) {<br>+                set_file_limit(OFF_T_MAX);<br>+                status &#x3D; YES;<br>+<br>+                if (msg_verbose)<br>+                    msg_info(“%s: set virtual mailbox limit size for %s to %ld”,<br>+                            myname, usr_attr.mailbox, OFF_T_MAX);<br>+        }<br>+        else {<br>+            &#x2F;* Invalid limit size (negative). Use default virtual_mailbox_limit. <em>&#x2F;<br>+            set_file_limit(var_virt_mailbox_limit);<br>+            status &#x3D; NO;<br>+        }<br>+    }<br>+    else {<br>+        &#x2F;</em> There is no limit in the maps. Use default virtual_mailbox_limit. <em>&#x2F;<br>+        set_file_limit(var_virt_mailbox_limit);<br>+        status &#x3D; NO;<br>+    }<br>+<br>+    return(status);<br>+}<br>+<br> &#x2F;</em> deliver_mailbox_file - deliver to recipient mailbox <em>&#x2F;<br><br> static int deliver_mailbox_file(LOCAL_STATE state, USER_ATTR usr_attr)<br>@@ -80,7 +145,6 @@<br>     int     mail_copy_status;<br>     int     deliver_status;<br>     int     copy_flags;<br>-    long    end;<br>     struct stat st;<br><br>     &#x2F;</em><br>@@ -132,7 +196,7 @@<br>         msg_warn(“specify &quot;%s &#x3D; no&quot; to ignore mailbox ownership mismatch”,<br>              VAR_STRICT_MBOX_OWNER);<br>     } else {<br>-	    end &#x3D; vstream_fseek(mp-&gt;fp, (off_t) 0, SEEK_END);<br>+	    vstream_fseek(mp-&gt;fp, (off_t) 0, SEEK_END);<br>         mail_copy_status &#x3D; mail_copy(COPY_ATTR(state.msg_attr), mp-&gt;fp,<br>                      copy_flags, “\n”, why);<br>     }<br>@@ -213,62 +277,72 @@<br>      * Look up the mailbox owner rights. Defer in case of trouble.<br>      *&#x2F;<br>     uid_res &#x3D; mail_addr_find(virtual_uid_maps, state.msg_attr.user,<br>-			     IGNORE_EXTENSION);<br>-    if (uid_res &#x3D;&#x3D; 0) {<br>-	msg_warn(“recipient %s: not found in %s”,<br>-		 state.msg_attr.user, virtual_uid_maps-&gt;title);<br>-	dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),<br>-				BOUNCE_ATTR(state.msg_attr));<br>-	RETURN(YES);<br>+                            IGNORE_EXTENSION);<br>+<br>+    if ((uid_res &#x3D; mail_addr_find(virtual_uid_maps, state.msg_attr.user, (char **) 0)) &#x3D;&#x3D; 0) {<br>+        if ((uid_res &#x3D; maps_find(virtual_uid_maps, strchr(state.msg_attr.user, ‘@’), DICT_FLAG_FIXED)) &#x3D;&#x3D; 0) {<br>+			msg_warn(“recipient %s: not found in %s”, state.msg_attr.user, virtual_uid_maps-&gt;title);<br>+			dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>+			*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));<br>+			RETURN(YES);<br>+        }<br>     }<br>+<br>     if ((n &#x3D; atol(uid_res)) &lt; var_virt_minimum_uid) {<br>-	msg_warn(“recipient %s: bad uid %s in %s”,<br>-		 state.msg_attr.user, uid_res, virtual_uid_maps-&gt;title);<br>-	dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),<br>-				BOUNCE_ATTR(state.msg_attr));<br>-	RETURN(YES);<br>+		msg_warn(“recipient %s: bad uid %s in %s”, state.msg_attr.user, uid_res, virtual_uid_maps-&gt;title);<br>+		dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>+		<em>statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));<br>+		RETURN(YES);<br>     }<br>+<br>     usr_attr.uid &#x3D; (uid_t) n;<br><br>     &#x2F;</em><br>      * Look up the mailbox group rights. Defer in case of trouble.<br>      *&#x2F;<br>     gid_res &#x3D; mail_addr_find(virtual_gid_maps, state.msg_attr.user,<br>-			     IGNORE_EXTENSION);<br>-    if (gid_res &#x3D;&#x3D; 0) {<br>-	msg_warn(“recipient %s: not found in %s”,<br>-		 state.msg_attr.user, virtual_gid_maps-&gt;title);<br>-	dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),<br>-				BOUNCE_ATTR(state.msg_attr));<br>-	RETURN(YES);<br>+                            IGNORE_EXTENSION);<br>+<br>+    if ((gid_res &#x3D; mail_addr_find(virtual_gid_maps, state.msg_attr.user, (char **) 0)) &#x3D;&#x3D; 0) {<br>+        if ((gid_res &#x3D; maps_find(virtual_gid_maps, strchr(state.msg_attr.user, ‘@’), DICT_FLAG_FIXED)) &#x3D;&#x3D; 0) {<br>+			msg_warn(“recipient %s: not found in %s”, state.msg_attr.user, virtual_gid_maps-&gt;title);<br>+			dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>+			*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));<br>+			RETURN(YES);<br>+        }<br>     }<br>+<br>     if ((n &#x3D; atol(gid_res)) &lt;&#x3D; 0) {<br>-	msg_warn(“recipient %s: bad gid %s in %s”,<br>-		 state.msg_attr.user, gid_res, virtual_gid_maps-&gt;title);<br>-	dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>-	*statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request),<br>-				BOUNCE_ATTR(state.msg_attr));<br>-	RETURN(YES);<br>+		msg_warn(“recipient %s: bad gid %s in %s”, state.msg_attr.user, gid_res, virtual_gid_maps-&gt;title);<br>+		dsb_simple(why, “4.3.5”, “mail system configuration error”);<br>+		<em>statusp &#x3D; defer_append(BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));<br>+		RETURN(YES);<br>     }<br>+<br>     usr_attr.gid &#x3D; (gid_t) n;<br><br>     if (msg_verbose)<br>-	msg_info(“%s[%d]: set user_attr: %s, uid &#x3D; %u, gid &#x3D; %u”,<br>-		 myname, state.level, usr_attr.mailbox,<br>-		 (unsigned) usr_attr.uid, (unsigned) usr_attr.gid);<br>+        msg_info(“%s[%d]: set user_attr: %s, uid &#x3D; %u, gid &#x3D; %u”,<br>+                myname, state.level, usr_attr.mailbox,<br>+                (unsigned) usr_attr.uid, (unsigned) usr_attr.gid);<br><br>     &#x2F;</em><br>      * Deliver to mailbox or to maildir.<br>      *&#x2F;<br> #define LAST_CHAR(s) (s[strlen(s) - 1])<br><br>-    if (LAST_CHAR(usr_attr.mailbox) &#x3D;&#x3D; ‘&#x2F;‘)<br>-	*statusp &#x3D; deliver_maildir(state, usr_attr);<br>-    else<br>-	*statusp &#x3D; deliver_mailbox_file(state, usr_attr);<br>+    if (LAST_CHAR(usr_attr.mailbox) &#x3D;&#x3D; ‘&#x2F;‘) {<br>+        <em>statusp &#x3D; deliver_maildir(state, usr_attr);<br>+    }<br>+    else {<br>+        int changed_limit;<br>+<br>+        changed_limit &#x3D; change_mailbox_limit(state, usr_attr);<br>+        <em>statusp &#x3D; deliver_mailbox_file(state, usr_attr);<br>+<br>+        if (changed_limit)<br>+            set_file_limit(var_virt_mailbox_limit);<br>+    }<br><br>     &#x2F;</em><br>      * Cleanup.<br>diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;maildir.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;maildir.c<br>— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;maildir.c	2012-01-25 01:41:08.000000000 +0100<br>+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;maildir.c	2013-06-07 13:21:22.840143270 +0200<br>@@ -64,28 +64,420 @@<br> #include &lt;mbox_open.h&gt;<br> #include &lt;dsn_util.h&gt;<br><br>+&#x2F;</em> Patch library. <em>&#x2F;<br>+<br>+#include &lt;sys&#x2F;types.h&gt; &#x2F;</em> opendir(3), stat(2) <em>&#x2F;<br>+#include &lt;sys&#x2F;stat.h&gt;  &#x2F;</em> stat(2) <em>&#x2F;<br>+#include &lt;dirent.h&gt;    &#x2F;</em> opendir(3) <em>&#x2F;<br>+#include &lt;unistd.h&gt;    &#x2F;</em> stat(2) <em>&#x2F;<br>+#include &lt;stdlib.h&gt;    &#x2F;</em> atol(3) <em>&#x2F;<br>+#include &lt;string.h&gt;    &#x2F;</em> strrchr(3) <em>&#x2F;<br>+#include &lt;vstring_vstream.h&gt;<br>+#include &lt;dict.h&gt;<br>+#include &lt;dict_regexp.h&gt;<br>+#include &lt;ctype.h&gt;<br>+#include &lt;stdio.h&gt;<br>+#include &lt;sys_defs.h&gt;<br>+#include &lt;mail_addr_find.h&gt;<br>+<br> &#x2F;</em> Application-specific. <em>&#x2F;<br><br> #include “virtual.h”<br><br>-&#x2F;</em> deliver_maildir - delivery to maildir-style mailbox <em>&#x2F;<br>+&#x2F;</em> Maildirsize maximal size. <em>&#x2F;<br>+<br>+#define SIZEFILE_MAX 5120<br>+<br>+&#x2F;</em><br>+ * Chris Stratford <a href="mailto:&#x63;&#x68;&#114;&#x69;&#x73;&#115;&#64;&#112;&#x69;&#x70;&#x65;&#120;&#x2e;&#x6e;&#x65;&#116;">&#x63;&#x68;&#114;&#x69;&#x73;&#115;&#64;&#112;&#x69;&#x70;&#x65;&#120;&#x2e;&#x6e;&#x65;&#116;</a><br>+ * Read the maildirsize file to get quota info.<br>+ *<br>+ * Arguments:<br>+ *  dirname: the maildir<br>+ *  countptr: number of messages<br>+ *<br>+ * Returns the size of all mails as read from maildirsize,<br>+ * zero if it couldn’t read the file.<br>+ *&#x2F;<br>+static long read_maildirsize(char *filename, long *sumptr, long *countptr)<br>+{<br>+    char *myname &#x3D; “read_maildirsize”;<br>+    struct stat statbuf;<br>+    VSTREAM *sizefile;<br>+    char *p;<br>+    int len, first;<br>+    long sum &#x3D; 0, count &#x3D; 0, ret_value &#x3D; -1;<br>+<br>+    if (msg_verbose)<br>+	msg_info(“%s: we will use sizefile &#x3D; ‘%s’”, myname, filename);<br>+	<br>+    sizefile &#x3D; vstream_fopen(filename, O_RDONLY, 0);<br>+    if (!sizefile) {<br>+	if (msg_verbose)<br>+	    msg_info(“%s: cannot open %s: %m (maybe file does not exist)”, myname, filename);<br>+	<br>+	return -1;<br>+    } else if (stat(filename, &amp;statbuf) &lt; 0 || statbuf.st_size &gt; SIZEFILE_MAX) {<br>+        if (sizefile) {<br>+            vstream_fclose(sizefile);<br>+            unlink(filename);<br>+        }<br>+<br>+        if (msg_verbose)<br>+	    msg_info(“%s: stat() returned &lt; 0 or filesize &gt; SIZEFILE_MAX (filename &#x3D; %s, filesize &#x3D; %ld)”, myname, filename, statbuf.st_size);<br>+<br>+        return -1;<br>+    }<br>+<br>+    VSTRING *sizebuf &#x3D; vstring_alloc(SIZEFILE_MAX);<br>+    len &#x3D; vstream_fread(sizefile, STR(sizebuf), SIZEFILE_MAX);<br>+<br>+    p &#x3D; STR(sizebuf);<br>+    *(p + len) &#x3D; ‘\0’;<br>+    first &#x3D; 1;<br>+<br>+    while (*p) {<br>+        long n &#x3D; 0, c &#x3D; 0;<br>+        char *q &#x3D; p;<br>+<br>+        while (*p) {<br>+            if (<em>p++ &#x3D;&#x3D; ‘\n’) {<br>+                p[-1] &#x3D; 0;<br>+                break;<br>+            }<br>+        }<br>+<br>+        if (first) {<br>+            first &#x3D; 0;<br>+            continue;<br>+        }<br>+<br>+        if (sscanf(q, “%ld %ld”, &amp;n, &amp;c) &#x3D;&#x3D; 2) {<br>+            sum +&#x3D; n;<br>+            count +&#x3D; c;<br>+            &#x2F;</em> if (msg_verbose)<br>+    		msg_info(“%s: we read line ‘%s’, totals: sum &#x3D; %ld, count &#x3D; %ld”, myname, q, sum, count); *&#x2F;<br>+        }<br>+        else {<br>+            vstream_fclose(sizefile);<br>+            unlink(filename);<br>+            msg_warn(“%s: invalid line ‘%s’ found in %s, removing maildirsize file”, myname, q, filename);<br>+            vstring_free(sizebuf);<br>+<br>+            return -1;<br>+        }<br>+    }<br>+<br>+    *countptr &#x3D; count;<br>+    *sumptr &#x3D; sum;<br>+<br>+    if (sum &lt; 0 || count &lt; 0 || (sum &#x3D;&#x3D; 0 &amp;&amp; count !&#x3D; 0) || (sum !&#x3D; 0 &amp;&amp; count &#x3D;&#x3D; 0)) {<br>+	if (msg_verbose) {<br>+	    msg_info(“%s: we will return -1 and unlink %s, because file count or sum is &lt;&#x3D; 0 (sum &#x3D; %ld, count &#x3D; %ld)”, myname, filename, sum, count);<br>+	}<br>+	<br>+	unlink(filename);<br>+	ret_value &#x3D; -1;<br>+    } else {<br>+	if (msg_verbose)<br>+	    msg_info(“%s: we will return Maildir size &#x3D; %ld, count &#x3D; %ld”, myname, *sumptr, *countptr);<br>+<br>+	ret_value &#x3D; sum;	<br>+    }<br>+<br>+    vstream_fclose(sizefile);<br>+    vstring_free(sizebuf);<br>+<br>+    return ret_value;<br>+}<br>+<br>+&#x2F;*<br>+ * Gives the size of the file according to the Maildir++ extension<br>+ * present in the filename (code taken from courier-imap).<br>+ *<br>+ * Arguments:<br>+ *  n: filename<br>+ *<br>+ * Returns the size given in “,S&#x3D;<size>“ in the filename,<br>+ * zero if it cannot find “,S&#x3D;<size>“ in the filename.<br>+ *&#x2F;<br>+static long maildir_parsequota(const char *n)<br>+{<br>+    const char *o;<br>+    int yes &#x3D; 0;<br>+<br>+    if ((o &#x3D; strrchr(n, ‘&#x2F;‘)) &#x3D;&#x3D; 0)<br>+        o &#x3D; n;<br>+<br>+    for (; *o; o++) {<br>+        if (*o &#x3D;&#x3D; ‘:’)<br>+            break;<br>+    }<br>+<br>+    for (; o &gt;&#x3D; n; –o) {<br>+        if (*o &#x3D;&#x3D; ‘&#x2F;‘)<br>+            break;<br>+<br>+        if (*o &#x3D;&#x3D; ‘,’ &amp;&amp; o[1] &#x3D;&#x3D; ‘S’ &amp;&amp; o[2] &#x3D;&#x3D; ‘&#x3D;’) {<br>+            yes &#x3D; 1;<br>+            o +&#x3D; 3;<br>+            break;<br>+        }<br>+    }<br>+<br>+    if (yes) {<br>+        long s &#x3D; 0;<br>+<br>+        while (*o &gt;&#x3D; ‘0’ &amp;&amp; *o &lt;&#x3D; ‘9’)<br>+            s &#x3D; s*10 + (*o++ - ‘0’);<br>+<br>+        return s;<br>+    }<br>+<br>+    return 0;<br>+}<br>+<br>+&#x2F;*<br>+ * Computes quota usage for a directory (taken from exim).<br>+ *<br>+ * This function is called to determine the exact quota usage of a virtual<br>+ * maildir box. To achieve maximum possible speed while doing this, it takes<br>+ * advantage of the maildirsize file and the Maildir++ extensions to filenames,<br>+ * when applicable and configured to be used. In all other cases it simply<br>+ * stats all the files as needed to get the size information.<br>+ *<br>+ * Arguments:<br>+ *  dirname: the name of the directory<br>+ *  countptr: where to add the file count (because this function recurses)<br>+ *<br>+ * Returns the sum of the sizes of all measurable files,<br>+ * zero if the directory could not be opened.<br>+ *&#x2F;<br>+static long check_dir_size(char *dirname, long *countptr)<br>+{<br>+    char *myname &#x3D; “check_dir_size”;<br>+    DIR *dir;<br>+    long sum &#x3D; 0;<br>+    struct dirent *ent;<br>+    struct stat statbuf;<br>+<br>+    dir &#x3D; opendir(dirname);<br>+    if (dir &#x3D;&#x3D; NULL) {<br>+        if (make_dirs(dirname, 0700) &#x3D;&#x3D; 0) {    &#x2F;* Try to create the dirs. *&#x2F;<br>+            dir &#x3D; opendir(dirname);             &#x2F;* Reopen the dir. *&#x2F;<br>+            if (dir &#x3D;&#x3D; NULL) {<br>+                msg_warn(“%s: cannot reopen directory: %s”, myname, dirname);<br>+                return 0;<br>+            }<br>+        }<br>+        else {<br>+            msg_warn(“%s: cannot open directory: %s”, myname, dirname);<br>+            return 0;<br>+        }<br>+    }<br>+<br>+    while ((ent &#x3D; readdir(dir)) !&#x3D; NULL) {<br>+        char *name &#x3D; ent-&gt;d_name;<br>+        long tmpsum &#x3D; 0;<br>+        VSTRING <em>buffer;<br>+<br>+	&#x2F;</em> do not count dot a double-dot dirs <em>&#x2F;<br>+        if (strcmp(name, “.”) &#x3D;&#x3D; 0 || strcmp(name, “..”) &#x3D;&#x3D; 0)<br>+            continue;<br>+        &#x2F;</em> do not count if this is the trash subdir and if we should NOT count it <em>&#x2F;<br>+	else if (var_virt_trash_count &#x3D;&#x3D; 0 &amp;&amp; strcmp(name, var_virt_trash_name) &#x3D;&#x3D; 0)<br>+    	    continue;<br>+<br>+        &#x2F;</em><br>+         * Here comes the real logic behind this function.<br>+         * Optimized to be the most efficient possible,<br>+         * depending on the settings given.<br>+         * See above for a more detailed description.<br>+         *&#x2F;<br>+        if (var_virt_mailbox_limit_inbox) {<br>+            if (var_virt_maildir_extended &amp;&amp; (tmpsum &#x3D; maildir_parsequota(name))) {<br>+                sum +&#x3D; tmpsum;<br>+                (<em>countptr)++;<br>+            }<br>+            else {<br>+                buffer &#x3D; vstring_alloc(1024);<br>+                vstring_sprintf(buffer, “%s&#x2F;%s”, dirname, name);<br>+<br>+                if (stat(STR(buffer), &amp;statbuf) &lt; 0) {<br>+                    vstring_free(buffer);<br>+                    continue;<br>+                }<br>+                if ((statbuf.st_mode &amp; S_IFREG) !&#x3D; 0) {<br>+                    sum +&#x3D; (long) statbuf.st_size;<br>+                    (*countptr)++;<br>+                }<br>+<br>+                vstring_free(buffer);<br>+            }<br>+        }<br>+        else {<br>+            buffer &#x3D; vstring_alloc(1024);<br>+            vstring_sprintf(buffer, “%s&#x2F;%s”, dirname, name);<br>+<br>+            if (stat(STR(buffer), &amp;statbuf) &lt; 0) {<br>+                vstring_free(buffer);<br>+                continue;<br>+            }<br>+            if ((statbuf.st_mode &amp; S_IFREG) !&#x3D; 0) {<br>+                if (strcmp(dirname + strlen(dirname) - 3, “new”) &#x3D;&#x3D; 0 || strcmp(dirname + strlen(dirname) - 3, “cur”) &#x3D;&#x3D; 0 || strcmp(dirname + strlen(dirname) - 3, “tmp”) &#x3D;&#x3D; 0) {<br>+                    sum +&#x3D; (long) statbuf.st_size;<br>+                    (*countptr)++;<br>+                }<br>+            }<br>+            else if ((statbuf.st_mode &amp; S_IFDIR) !&#x3D; 0) {<br>+                sum +&#x3D; check_dir_size(STR(buffer), countptr);<br>+            }<br>+<br>+            vstring_free(buffer);<br>+        }<br>+    }<br>+    closedir(dir);<br><br>-int     deliver_maildir(LOCAL_STATE state, USER_ATTR usr_attr)<br>+    if (msg_verbose)<br>+        msg_info(“%s: full scan done: dir&#x3D;%s sum&#x3D;%ld count&#x3D;%ld”, myname, dirname, sum, *countptr);<br>+<br>+    return sum;<br>+}<br>+<br>+&#x2F;* Cut all occurrences of pattern from string. *&#x2F;<br>+static char *strcut(char *str, const char *pat)<br>+{<br>+    char *ptr, *loc, *ret;<br>+    ret &#x3D; str;<br>+    loc &#x3D; str;<br>+<br>+    &#x2F;* No match, return original string. *&#x2F;<br>+    if (!strstr(loc, pat))<br>+        return(str);<br>+<br>+    while (*loc &amp;&amp; (ptr &#x3D; strstr(loc, pat))) {<br>+        while (loc &lt; ptr)<br>+            *str++ &#x3D; *loc++;<br>+        loc +&#x3D; strlen(pat);<br>+    }<br>+<br>+    while (*loc)<br>+        *str++ &#x3D; *loc++;<br>+<br>+    *str &#x3D; 0;<br>+<br>+    return(ret);<br>+}<br>+<br>+&#x2F;* Check if maildirfilter file is up-to-date compared to SQL, (re)write it if not. *&#x2F;<br>+static long sql2file(char *filename, char *user)<br>+{<br>+    char *myname &#x3D; “sql2file”;<br>+    char *filter_sqlres;<br>+    char filter_fileres[128];<br>+    long sqlmtime &#x3D; 0, filemtime &#x3D; 0, retval &#x3D; 0;<br>+    int filterfile, size_sqlres, i;<br>+    struct stat statbuf;<br>+<br>+    if (*var_virt_maildir_filter_maps !&#x3D; 0) {<br>+        filter_sqlres &#x3D; (char *) mymalloc(16000);<br>+        filter_sqlres &#x3D; (char *) mail_addr_find(virtual_maildir_filter_maps, user, (char **) 0);<br>+<br>+        if (filter_sqlres) {<br>+            strcut(filter_sqlres, “\r”);<br>+            if (filter_sqlres[0] &#x3D;&#x3D; ‘#’ &amp;&amp; filter_sqlres[1] &#x3D;&#x3D; ‘ ‘ &amp;&amp; filter_sqlres[2] &#x3D;&#x3D; ‘M’) {<br>+                size_sqlres &#x3D; strlen(filter_sqlres);<br>+<br>+                for (i &#x3D; 4; i &lt;&#x3D; size_sqlres; i++) {<br>+                    if(filter_sqlres[i] &#x3D;&#x3D; ‘&#x2F;‘ &amp;&amp; filter_sqlres[i+1] &#x3D;&#x3D; ‘^’) {<br>+                        filter_sqlres[i-1] &#x3D; ‘\n’;<br>+                    }<br>+                }<br>+<br>+                filter_sqlres[(size_sqlres+1)] &#x3D; ‘\0’;<br>+<br>+                sqlmtime &#x3D; atol(filter_sqlres+3);<br>+                retval &#x3D; sqlmtime;<br>+<br>+                filterfile &#x3D; open(filename, O_RDONLY, 0);<br>+                if (filterfile) {<br>+                    read(filterfile, (void *) filter_fileres, 127);<br>+                    close(filterfile);<br>+<br>+                    filemtime &#x3D; atol(filter_fileres+3);<br>+                }<br>+<br>+                if (msg_verbose)<br>+                    msg_info(“%s: filter data: sql_size&#x3D;%li sql_mtime&#x3D;%ld file_mtime&#x3D;%ld”, myname, strlen(filter_sqlres), sqlmtime, filemtime);<br>+            }<br>+            if (sqlmtime !&#x3D; filemtime &amp;&amp; sqlmtime !&#x3D; 0) {<br>+                if ((filterfile &#x3D; open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0640))) {<br>+                    if (msg_verbose)<br>+                        msg_info(“%s: updating filter file: %s”, myname, filename);<br>+                    write(filterfile, filter_sqlres, strlen(filter_sqlres));<br>+                    close(filterfile);<br>+                }<br>+                else {<br>+                    msg_warn(“%s: can’t create filter file: %s”, myname, filename);<br>+                    retval &#x3D; 0;<br>+                }<br>+            }<br>+        }<br>+    }<br>+    else {<br>+        if (stat(filename, &amp;statbuf) &#x3D;&#x3D; 0)<br>+            retval &#x3D; (long) statbuf.st_mtime;<br>+        if (msg_verbose)<br>+            msg_info(“%s: processing filter file: file_mtime&#x3D;%ld”, myname, retval);<br>+    }<br>+<br>+    return retval;<br>+}<br>+<br>+&#x2F;* deliver_maildir - delivery to maildir-style mailbox *&#x2F;<br>+int deliver_maildir(LOCAL_STATE state, USER_ATTR usr_attr)<br> {<br>     const char *myname &#x3D; “deliver_maildir”;<br>-    char   *newdir;<br>-    char   *tmpdir;<br>-    char   *curdir;<br>-    char   *tmpfile;<br>-    char   *newfile;<br>+    char    *newdir;<br>+    char    *tmpdir;<br>+    char    *curdir;<br>+    char    *newfile;<br>+    char    *tmpfile;<br>     DSN_BUF *why &#x3D; state.msg_attr.why;<br>     VSTRING *buf;<br>     VSTREAM *dst;<br>-    int     mail_copy_status;<br>-    int     deliver_status;<br>-    int     copy_flags;<br>-    struct stat st;<br>-    struct timeval starttime;<br>+    int      mail_copy_status;<br>+    int      deliver_status;<br>+    int      copy_flags;<br>+    struct   stat st;<br>+    struct   timeval starttime;<br>+<br>+    &#x2F;* Maildir Quota. *&#x2F;<br>+    const char *limit_res;              &#x2F;* Limit from map. *&#x2F;<br>+    char    *sizefilename &#x3D; (char *) 0; &#x2F;* Maildirsize file name. *&#x2F;<br>+    VSTRING *filequota;                 &#x2F;* Quota setting from the maildirsize file. *&#x2F;<br>+    VSTREAM *sizefile;                  &#x2F;* Maildirsize file handle. *&#x2F;<br>+    long     n &#x3D; 0;                     &#x2F;* Limit in long integer format. *&#x2F;<br>+    long     saved_count &#x3D; 0;           &#x2F;* The total number of files. *&#x2F;<br>+    long     saved_size &#x3D; 0;            &#x2F;* The total quota of all files. *&#x2F;<br>+    struct   stat mail_stat;            &#x2F;* To check the size of the mail to be written. *&#x2F;<br>+    struct   stat sizefile_stat;        &#x2F;* To check the size of the maildirsize file. *&#x2F;<br>+    time_t   tm;                        &#x2F;* To check the age of the maildirsize file. *&#x2F;<br>+<br>+    &#x2F;* Maildir Filters. *&#x2F;<br>+    const char *value, *cmd_text;       &#x2F;* Filter values. *&#x2F;<br>+    char    *filtername;<br>+    char    *header;<br>+    char    *bkpnewfile;<br>+    char    *mdffilename &#x3D; (char *) 0;  &#x2F;* Maildirfolder file name. *&#x2F;<br>+    VSTRING *fltstr;<br>+    VSTREAM *tmpfilter;<br>+    VSTREAM *mdffile;                   &#x2F;* Maildirfolder file handle. *&#x2F;<br>+    DICT    *FILTERS;<br>+    long     sqlmtime;                  &#x2F;* Latest modification time from sql2file(). *&#x2F;<br>+    int      cmd_len;<br>+    int	    read_mds &#x3D; -1;		&#x2F;* read_maildirsize() returned value *&#x2F;<br>+    struct   stat mdffile_stat;         &#x2F;* To check if the maildirfolder file exists. *&#x2F;<br><br>     GETTIMEOFDAY(&amp;starttime);<br><br>@@ -94,15 +486,14 @@<br>      *&#x2F;<br>     state.level++;<br>     if (msg_verbose)<br>-	MSG_LOG_STATE(myname, state);<br>+	    MSG_LOG_STATE(myname, state);<br><br>     &#x2F;*<br>      * Don’t deliver trace-only requests.<br>      *&#x2F;<br>     if (DEL_REQ_TRACE_ONLY(state.request-&gt;flags)) {<br>-	dsb_simple(why, “2.0.0”, “delivers to maildir”);<br>-	return (sent(BOUNCE_FLAGS(state.request),<br>-		     SENT_ATTR(state.msg_attr)));<br>+        dsb_simple(why, “2.0.0”, “delivers to maildir”);<br>+        return (sent(BOUNCE_FLAGS(state.request), SENT_ATTR(state.msg_attr)));<br>     }<br><br>     &#x2F;</em><br>@@ -110,18 +501,116 @@<br>      * attribute to reflect the final recipient.<br>      <em>&#x2F;<br>     if (vstream_fseek(state.msg_attr.fp, state.msg_attr.offset, SEEK_SET) &lt; 0)<br>-	msg_fatal(“seek message file %s: %m”, VSTREAM_PATH(state.msg_attr.fp));<br>+        msg_fatal(“seek message file %s: %m”, VSTREAM_PATH(state.msg_attr.fp));<br>     state.msg_attr.delivered &#x3D; state.msg_attr.rcpt.address;<br>     mail_copy_status &#x3D; MAIL_COPY_STAT_WRITE;<br>     buf &#x3D; vstring_alloc(100);<br><br>-    copy_flags &#x3D; MAIL_COPY_TOFILE | MAIL_COPY_RETURN_PATH<br>-	| MAIL_COPY_DELIVERED | MAIL_COPY_ORIG_RCPT;<br>+    copy_flags &#x3D; MAIL_COPY_TOFILE | MAIL_COPY_RETURN_PATH | MAIL_COPY_DELIVERED | MAIL_COPY_ORIG_RCPT;<br><br>-    newdir &#x3D; concatenate(usr_attr.mailbox, “new&#x2F;“, (char *) 0);<br>-    tmpdir &#x3D; concatenate(usr_attr.mailbox, “tmp&#x2F;“, (char *) 0);<br>-    curdir &#x3D; concatenate(usr_attr.mailbox, “cur&#x2F;“, (char *) 0);<br>+    &#x2F;*<br>+     * Concatenate the maildir suffix (if set).<br>+     *&#x2F;<br>+    if (*var_virt_maildir_suffix &#x3D;&#x3D; 0) {<br>+        newdir &#x3D; concatenate(usr_attr.mailbox, “new&#x2F;“, (char *) 0);<br>+        tmpdir &#x3D; concatenate(usr_attr.mailbox, “tmp&#x2F;“, (char *) 0);<br>+        curdir &#x3D; concatenate(usr_attr.mailbox, “cur&#x2F;“, (char *) 0);<br>+    }<br>+    else {<br>+        newdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);<br>+        tmpdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);<br>+        curdir &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);<br>+        newdir &#x3D; concatenate(newdir, “new&#x2F;“, (char *) 0);<br>+        tmpdir &#x3D; concatenate(tmpdir, “tmp&#x2F;“, (char *) 0);<br>+        curdir &#x3D; concatenate(curdir, “cur&#x2F;“, (char *) 0);<br>+    }<br><br>+    &#x2F;* get the sizefilename, no matter if we use var_virt_maildir_extended *&#x2F;<br>+    if (*var_virt_maildir_suffix &#x3D;&#x3D; 0) {<br>+        sizefilename &#x3D; concatenate(usr_attr.mailbox, “maildirsize”, (char *) 0);<br>+    } else {<br>+        sizefilename &#x3D; concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);<br>+        sizefilename &#x3D; concatenate(sizefilename, “maildirsize”, (char *) 0);<br>+    }<br>+<br>+    &#x2F;*<br>+     * Look up the virtual maildir limit size for this user.<br>+     * Fall back to virtual_mailbox_limit in case lookup failed.<br>+     * If virtual maildir limit size is negative, fall back to virtual_mailbox_limit.<br>+     * If it’s 0, set the mailbox limit to 0, which means unlimited.<br>+     * If it’s more than 0 (positive int), check if the value is smaller than the maximum message size,<br>+     * if it is and the virtual maildir limit can’t be overridden, fall back to virtual_mailbox_limit and<br>+     * warn the user, else use the value directly as the maildir limit.<br>+     *&#x2F;<br>+    if (*var_virt_mailbox_limit_maps !&#x3D; 0 &amp;&amp; (limit_res &#x3D; mail_addr_find(virtual_mailbox_limit_maps, state.msg_attr.user, (char **) NULL)) !&#x3D; 0) {<br>+        n &#x3D; atol(limit_res);<br>+        if (n &gt; 0) {<br>+            if ((n &lt; var_message_limit) &amp;&amp; (!var_virt_mailbox_limit_override)) {<br>+                n &#x3D; var_virt_mailbox_limit;<br>+<br>+                msg_warn(“%s: recipient %s - virtual maildir limit is smaller than %s in %s - falling back to %s”,<br>+                        myname, state.msg_attr.user, VAR_MESSAGE_LIMIT, virtual_mailbox_limit_maps-&gt;title,<br>+                        VAR_VIRT_MAILBOX_LIMIT);<br>+            }<br>+            else {<br>+                if (msg_verbose)<br>+                    msg_info(“%s: set virtual maildir limit size for %s to %ld”,<br>+                            myname, usr_attr.mailbox, n);<br>+            }<br>+        }<br>+        else if (n &#x3D;&#x3D; 0) {<br>+                if (msg_verbose)<br>+                    msg_info(“%s: set virtual maildir limit size for %s to %ld”,<br>+                            myname, usr_attr.mailbox, n);<br>+        }<br>+        else {<br>+	    if (msg_verbose)<br>+		msg_info(“%s: quota is negative (%ld), using default virtual_mailbox_limit (%ld)”,<br>+			    myname, n, var_virt_mailbox_limit);<br>+            &#x2F;</em> Invalid limit size (negative). Use default virtual_mailbox_limit. <em>&#x2F;<br>+            n &#x3D; var_virt_mailbox_limit;<br>+        }<br>+    }<br>+    else {<br>+	if (msg_verbose)<br>+	    msg_info(“%s: no limit found in the maps, using default virtual_mailbox_limit (%ld)”,<br>+			myname, var_virt_mailbox_limit);<br>+        &#x2F;</em> There is no limit in the maps. Use default virtual_mailbox_limit. <em>&#x2F;<br>+        n &#x3D; var_virt_mailbox_limit;<br>+    }<br>+<br>+    &#x2F;</em> If there should is a quota on maildir generaly, check it before delivering the mail <em>&#x2F;<br>+    if (n !&#x3D; 0) {<br>+        set_eugid(usr_attr.uid, usr_attr.gid);<br>+	&#x2F;</em> try to read the quota from maildirsize file. Returned values by read_maildirsize:<br>+	x &lt; 0  &#x3D; something failed<br>+	x &gt;&#x3D; 0 &#x3D; reading successfully finished - sum si returned, so sum size of Maildir was 0 or more <em>&#x2F;<br>+        if (!var_virt_mailbox_limit_inbox &amp;&amp; var_virt_maildir_extended &amp;&amp; (read_mds &#x3D; read_maildirsize(sizefilename, &amp;saved_size, &amp;saved_count)) &gt;&#x3D; 0) {<br>+    	    if (msg_verbose)<br>+        	msg_info(“%s: maildirsize used&#x3D;%s sum&#x3D;%ld count&#x3D;%ld”, myname, sizefilename, saved_size, saved_count);<br>+	} else {<br>+	    if (msg_verbose)<br>+		msg_info(“%s: We will recount the quota (var_virt_mailbox_limit &#x3D; %ld, var_virt_maildir_extended &#x3D; %d, read_maildirsize &#x3D; %d)”,<br>+			    myname, var_virt_mailbox_limit, var_virt_maildir_extended, read_mds);<br>+<br>+	    &#x2F;</em> sanity <em>&#x2F;<br>+	    saved_size &#x3D; 0;<br>+	    saved_count &#x3D; 0;<br>+	<br>+    	    if (var_virt_mailbox_limit_inbox) {<br>+        	&#x2F;</em> Check Inbox only (new, cur and tmp dirs). <em>&#x2F;<br>+        	saved_size &#x3D; check_dir_size(newdir, &amp;saved_count);<br>+        	saved_size +&#x3D; check_dir_size(curdir, &amp;saved_count);<br>+        	saved_size +&#x3D; check_dir_size(tmpdir, &amp;saved_count);<br>+    	    } else {<br>+        	&#x2F;</em> Check all boxes. <em>&#x2F;<br>+        	saved_size &#x3D; check_dir_size(usr_attr.mailbox, &amp;saved_count);<br>+    	    }<br>+<br>+    	    set_eugid(var_owner_uid, var_owner_gid);<br>+    	}    	<br>+    }<br>+<br>     &#x2F;</em><br>      * Create and write the file as the recipient, so that file quota work.<br>      * Create any missing directories on the fly. The file name is chosen<br>@@ -175,46 +664,288 @@<br>      * […]<br>      *&#x2F;<br>     set_eugid(usr_attr.uid, usr_attr.gid);<br>-    vstring_sprintf(buf, “%lu.P%d.%s”,<br>-		 (unsigned long) starttime.tv_sec, var_pid, get_hostname());<br>+    vstring_sprintf(buf, “%lu.P%d.%s”, (unsigned long) starttime.tv_sec, var_pid, get_hostname());<br>     tmpfile &#x3D; concatenate(tmpdir, STR(buf), (char *) 0);<br>     newfile &#x3D; 0;<br>+    bkpnewfile &#x3D; 0;<br>     if ((dst &#x3D; vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) &#x3D;&#x3D; 0<br>-	&amp;&amp; (errno !&#x3D; ENOENT<br>-	    || make_dirs(tmpdir, 0700) &lt; 0<br>-	    || (dst &#x3D; vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) &#x3D;&#x3D; 0)) {<br>-	dsb_simple(why, mbox_dsn(errno, “4.2.0”),<br>-		   “create maildir file %s: %m”, tmpfile);<br>-    } else if (fstat(vstream_fileno(dst), &amp;st) &lt; 0) {</h2><ul>
<li>   &#x2F;*</li>
<li><pre><code>* Coverity 200604: file descriptor leak in code that never executes.
</code></pre>
</li>
<li><pre><code>* Code replaced by msg_fatal(), as it is not worthwhile to continue
</code></pre>
</li>
<li><pre><code>* after an impossible error condition.
</code></pre>
</li>
<li><pre><code>*/
</code></pre>
</li>
<li>   msg_fatal(“fstat %s: %m”, tmpfile);</li>
<li>} else {</li>
<li>   vstring_sprintf(buf, “%lu.V%lxI%lxM%lu.%s”,</li>
<li><pre><code>     (unsigned long) starttime.tv_sec,
</code></pre>
</li>
<li><pre><code>     (unsigned long) st.st_dev,
</code></pre>
</li>
<li><pre><code>     (unsigned long) st.st_ino,
</code></pre>
</li>
<li><pre><code>     (unsigned long) starttime.tv_usec,
</code></pre>
</li>
<li><pre><code>     get_hostname());
</code></pre>
</li>
<li>   newfile &#x3D; concatenate(newdir, STR(buf), (char *) 0);</li>
<li>   if ((mail_copy_status &#x3D; mail_copy(COPY_ATTR(state.msg_attr),</li>
<li><pre><code>             dst, copy_flags, &quot;\n&quot;,
</code></pre>
</li>
<li><pre><code>             why)) == 0) &#123;
</code></pre>
</li>
<li><pre><code>   if (sane_link(tmpfile, newfile) &lt; 0
</code></pre>
</li>
<li><pre><code>  &amp;&amp; (errno != ENOENT
</code></pre>
</li>
<li><pre><code>      || (make_dirs(curdir, 0700), make_dirs(newdir, 0700)) &lt; 0
</code></pre>
</li>
<li><pre><code>      || sane_link(tmpfile, newfile) &lt; 0)) &#123;
</code></pre>
</li>
<li><pre><code>  dsb_simple(why, mbox_dsn(errno, &quot;4.2.0&quot;),
</code></pre>
</li>
<li><pre><code>        &quot;create maildir file %s: %m&quot;, newfile);
</code></pre>
</li>
<li><pre><code>  mail_copy_status = MAIL_COPY_STAT_WRITE;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li>   }</li>
<li>   if (unlink(tmpfile) &lt; 0)</li>
<li><pre><code>   msg_warn(&quot;remove %s: %m&quot;, tmpfile);
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>   &amp;&amp; (errno != ENOENT
</code></pre>
</li>
<li><pre><code>       || make_dirs(tmpdir, 0700) &lt; 0
</code></pre>
</li>
<li><pre><code>       || (dst = vstream_fopen(tmpfile, O_WRONLY | O_CREAT | O_EXCL, 0600)) == 0)) &#123;
</code></pre>
</li>
<li><pre><code>   dsb_simple(why, mbox_dsn(errno, &quot;4.2.0&quot;), &quot;create maildir file %s: %m&quot;, tmpfile);
</code></pre>
</li>
<li>}</li>
<li>else if (fstat(vstream_fileno(dst), &amp;st) &lt; 0) {</li>
<li><pre><code>   /*
</code></pre>
</li>
<li><pre><code>    * Coverity 200604: file descriptor leak in code that never executes.
</code></pre>
</li>
<li><pre><code>    * Code replaced by msg_fatal(), as it is not worthwhile to continue
</code></pre>
</li>
<li><pre><code>    * after an impossible error condition.
</code></pre>
</li>
<li><pre><code>    */
</code></pre>
</li>
<li><pre><code>   msg_fatal(&quot;fstat %s: %m&quot;, tmpfile);
</code></pre>
</li>
<li>}</li>
<li>else {</li>
<li><pre><code>   vstring_sprintf(buf, &quot;%lu.V%lxI%lxM%lu.%s&quot;,
</code></pre>
</li>
<li><pre><code>           (unsigned long) starttime.tv_sec,
</code></pre>
</li>
<li><pre><code>           (unsigned long) st.st_dev,
</code></pre>
</li>
<li><pre><code>           (unsigned long) st.st_ino,
</code></pre>
</li>
<li><pre><code>           (unsigned long) starttime.tv_usec,
</code></pre>
</li>
<li><pre><code>           get_hostname());
</code></pre>
</li>
<li><pre><code>   newfile = concatenate(newdir, STR(buf), (char *) 0);
</code></pre>
</li>
<li><pre><code>   bkpnewfile = concatenate(STR(buf), (char *) 0); /* Will need it later, if we MOVE to other folders. */
</code></pre>
</li>
<li></li>
<li><pre><code>   if ((mail_copy_status = mail_copy(COPY_ATTR(state.msg_attr), dst, copy_flags, &quot;\n&quot;, why)) == 0) &#123;
</code></pre>
</li>
<li><pre><code>       /*
</code></pre>
</li>
<li><pre><code>        * Add a &quot;,S=&lt;sizeoffile&gt;&quot; to the newly written file according to the
</code></pre>
</li>
<li><pre><code>        * Maildir++ specifications: http://www.inter7.com/courierimap/README.maildirquota.html
</code></pre>
</li>
<li><pre><code>        * This needs a stat(2) of the tempfile and modification of the
</code></pre>
</li>
<li><pre><code>        * name of the file.
</code></pre>
</li>
<li><pre><code>        */
</code></pre>
</li>
<li><pre><code>       if (stat(tmpfile, &amp;mail_stat) == 0) &#123;
</code></pre>
</li>
<li><pre><code>           if (n != 0) &#123;
</code></pre>
</li>
<li><pre><code>               saved_size += (long) mail_stat.st_size;
</code></pre>
</li>
<li><pre><code>               saved_count++;
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>           if (var_virt_maildir_extended) &#123;
</code></pre>
</li>
<li><pre><code>               /* Append the size of the file to newfile. */
</code></pre>
</li>
<li><pre><code>               vstring_sprintf(buf, &quot;,S=%ld&quot;, (long) mail_stat.st_size);
</code></pre>
</li>
<li><pre><code>               newfile = concatenate(newfile, STR(buf), (char *) 0);
</code></pre>
</li>
<li><pre><code>               bkpnewfile = concatenate(bkpnewfile, STR(buf), (char *) 0);
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>       /*
</code></pre>
</li>
<li><pre><code>        * Now we have the maildir size in saved_size, compare it to the max
</code></pre>
</li>
<li><pre><code>        * quota value and eventually issue a message that we&#39;ve overdrawn it.
</code></pre>
</li>
<li><pre><code>        */
</code></pre>
</li>
<li><pre><code>       if (saved_size &gt; n) &#123;
</code></pre>
</li>
<li><pre><code>           mail_copy_status = MAIL_COPY_STAT_WRITE;
</code></pre>
</li>
<li><pre><code>           if (((long) mail_stat.st_size &gt; n) || (var_virt_overquota_bounce))
</code></pre>
</li>
<li><pre><code>               errno = EFBIG;
</code></pre>
</li>
<li><pre><code>           else
</code></pre>
</li>
<li><pre><code>               errno = EDQUOT;
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       else &#123;
</code></pre>
</li>
<li><pre><code>           /* Maildirfilter code by rk@demiurg.net. */
</code></pre>
</li>
<li><pre><code>           if (var_virt_maildir_filter) &#123;
</code></pre>
</li>
<li><pre><code>               if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                   msg_info(&quot;%s: loading DICT filters&quot;, myname);
</code></pre>
</li>
<li>+#define STREQUAL(x,y,l) (strncasecmp((x), (y), (l)) &#x3D;&#x3D; 0 &amp;&amp; (y)[l] &#x3D;&#x3D; 0)</li>
</ul>
<p>+#define MAIL_COPY_STAT_REJECT  (1&lt;&lt;3)<br>+#define MAIL_COPY_STAT_DISCARD (1&lt;&lt;4)<br>+</p>
<ul>
<li><pre><code>               /* Read filters. */
</code></pre>
</li>
<li><pre><code>               filtername = concatenate(&quot;regexp:&quot;, usr_attr.mailbox, &quot;maildirfilter&quot;, (char *) 0);
</code></pre>
</li>
<li><pre><code>               sqlmtime = sql2file(strchr(filtername, &#39;/&#39;), state.msg_attr.user);
</code></pre>
</li>
<li></li>
<li><pre><code>               /* Check if this filter is already registered as dictionary. */
</code></pre>
</li>
<li><pre><code>               if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                   msg_info(&quot;%s: checking DICT filters for %s&quot;, myname, filtername);
</code></pre>
</li>
<li></li>
<li><pre><code>               if ((FILTERS = dict_handle(filtername))) &#123;
</code></pre>
</li>
<li><pre><code>                   if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                       msg_info(&quot;%s: DICT filter found&quot;, myname);
</code></pre>
</li>
<li></li>
<li><pre><code>                   /*
</code></pre>
</li>
<li><pre><code>                    * If we have mtime in our DICT structure, check it against sqlmtime
</code></pre>
</li>
<li><pre><code>                    * and reload the filters if they differ.
</code></pre>
</li>
<li><pre><code>                    */
</code></pre>
</li>
<li><pre><code>                   if (FILTERS-&gt;mtime &gt; 0 &amp;&amp; sqlmtime &gt; 0 &amp;&amp; FILTERS-&gt;mtime != sqlmtime) &#123;
</code></pre>
</li>
<li><pre><code>                       if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: reloading DICT filters (dict_mtime=%ld != sql_mtime=%ld)&quot;,
</code></pre>
</li>
<li><pre><code>                                   myname, FILTERS-&gt;mtime, sqlmtime);
</code></pre>
</li>
<li></li>
<li><pre><code>                       dict_unregister(filtername);
</code></pre>
</li>
<li><pre><code>                       FILTERS = dict_open(filtername, O_RDONLY, DICT_FLAG_LOCK);
</code></pre>
</li>
<li><pre><code>                       dict_register(filtername, FILTERS);
</code></pre>
</li>
<li><pre><code>                       FILTERS-&gt;mtime = sqlmtime;
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li><pre><code>               else &#123;
</code></pre>
</li>
<li><pre><code>                   if (sqlmtime &gt; 0) &#123;
</code></pre>
</li>
<li><pre><code>                       /* Registering filter as new dictionary. */
</code></pre>
</li>
<li><pre><code>                       if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: loading DICT filters from %s (mtime=%ld)&quot;,
</code></pre>
</li>
<li><pre><code>                                   myname, filtername, sqlmtime);
</code></pre>
</li>
<li></li>
<li><pre><code>                       FILTERS = dict_open(filtername, O_RDONLY, DICT_FLAG_LOCK);
</code></pre>
</li>
<li><pre><code>                       dict_register(filtername, FILTERS);
</code></pre>
</li>
<li><pre><code>                       FILTERS-&gt;mtime = sqlmtime;
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>               if (FILTERS &amp;&amp; (tmpfilter = vstream_fopen(tmpfile, O_RDONLY, 0))) &#123;
</code></pre>
</li>
<li><pre><code>                   fltstr = vstring_alloc(1024);
</code></pre>
</li>
<li><pre><code>                   header = (char *) malloc(8192); /* !!!INSECURE!!! See 7168-hack below. */
</code></pre>
</li>
<li><pre><code>                   header[0] = 0;
</code></pre>
</li>
<li><pre><code>                   vstring_get_nonl_bound(fltstr, tmpfilter, 1023);
</code></pre>
</li>
<li><pre><code>                   header = concatenate(header, STR(fltstr), (char *) 0);
</code></pre>
</li>
<li></li>
<li><pre><code>                   while(!vstream_feof(tmpfilter) &amp;&amp; fltstr-&gt;vbuf.data[0] &amp;&amp; strlen(header) &lt; 7168 ) &#123;
</code></pre>
</li>
<li><pre><code>                       vstring_get_nonl_bound(fltstr, tmpfilter, 1023);
</code></pre>
</li>
<li><pre><code>                       /* Glue multiline headers, replacing leading TAB with space. */
</code></pre>
</li>
<li><pre><code>                       if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: fltstr value: %s&quot;, myname, STR(fltstr));
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (fltstr-&gt;vbuf.data[0] == &#39; &#39; || fltstr-&gt;vbuf.data[0] == &#39;\t&#39; ) &#123;
</code></pre>
</li>
<li><pre><code>                           if (fltstr-&gt;vbuf.data[0] == &#39;\t&#39;)
</code></pre>
</li>
<li><pre><code>                               fltstr-&gt;vbuf.data[0] = &#39; &#39;;
</code></pre>
</li>
<li><pre><code>                           header = concatenate(header, STR(fltstr), (char *) 0);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li><pre><code>                       else &#123;
</code></pre>
</li>
<li><pre><code>                           header = concatenate(header, &quot;\n&quot;, STR(fltstr), (char *) 0);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                   if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                       msg_info(&quot;%s: checking filter CMD for %s&quot;, myname, filtername);
</code></pre>
</li>
<li></li>
<li><pre><code>                   /* Check whole header part with regexp maps. */
</code></pre>
</li>
<li><pre><code>                   if ((value = dict_get(FILTERS, lowercase(header))) != 0) &#123;
</code></pre>
</li>
<li><pre><code>                       if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: preparing filter CMD&quot;, myname);
</code></pre>
</li>
<li></li>
<li><pre><code>                       cmd_text = value + strcspn(value, &quot; \t&quot;);
</code></pre>
</li>
<li><pre><code>                       cmd_len = cmd_text - value;
</code></pre>
</li>
<li><pre><code>                       while (*cmd_text &amp;&amp; ISSPACE(*cmd_text))
</code></pre>
</li>
<li><pre><code>                           cmd_text++;
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: executing filter CMD&quot;, myname);
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (STREQUAL(value, &quot;REJECT&quot;, cmd_len)) &#123;
</code></pre>
</li>
<li><pre><code>                           if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                               msg_info(&quot;%s: executing filter CMD REJECT&quot;, myname);
</code></pre>
</li>
<li></li>
<li><pre><code>                           mail_copy_status = MAIL_COPY_STAT_REJECT;
</code></pre>
</li>
<li><pre><code>                           vstring_sprintf(why-&gt;reason, &quot;%s&quot;, cmd_text);
</code></pre>
</li>
<li><pre><code>                           dsb_simple(why, &quot;5.0.0&quot;, &quot;User filter - REJECT&quot;);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (STREQUAL(value, &quot;DISCARD&quot;, cmd_len)) &#123;
</code></pre>
</li>
<li><pre><code>                           if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                               msg_info(&quot;%s: executing filter CMD DISCARD&quot;, myname);
</code></pre>
</li>
<li></li>
<li><pre><code>                           mail_copy_status = MAIL_COPY_STAT_DISCARD;
</code></pre>
</li>
<li><pre><code>                           vstring_sprintf(why-&gt;reason, &quot;%s&quot;, cmd_text);
</code></pre>
</li>
<li><pre><code>                           dsb_simple(why, &quot;5.0.0&quot;, &quot;User filter - DISCARD&quot;);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (var_virt_maildir_extended) &#123;
</code></pre>
</li>
<li><pre><code>                           if (STREQUAL(value, &quot;MOVE&quot;, cmd_len)) &#123;
</code></pre>
</li>
<li><pre><code>                               if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                                   msg_info(&quot;%s: executing filter CMD MOVE&quot;, myname);
</code></pre>
</li>
<li></li>
<li><pre><code>                               strcut((char *) cmd_text, &quot; &quot;);
</code></pre>
</li>
<li><pre><code>                               strcut((char *) cmd_text, &quot;\t&quot;);
</code></pre>
</li>
<li><pre><code>                               strcut((char *) cmd_text, &quot;/&quot;);
</code></pre>
</li>
<li><pre><code>                               strcut((char *) cmd_text, &quot;..&quot;);
</code></pre>
</li>
<li></li>
<li><pre><code>                               if (*var_virt_maildir_suffix == 0) &#123;
</code></pre>
</li>
<li><pre><code>                                   newfile = concatenate(usr_attr.mailbox, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               &#125;
</code></pre>
</li>
<li><pre><code>                               else &#123;
</code></pre>
</li>
<li><pre><code>                                   newfile = concatenate(usr_attr.mailbox, var_virt_maildir_suffix, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                               if (cmd_text[0] != &#39;.&#39;) &#123;
</code></pre>
</li>
<li><pre><code>                                   newfile = concatenate(newfile, &quot;.&quot;, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               &#125;
</code></pre>
</li>
<li><pre><code>                               newdir  = concatenate(newfile, cmd_text, &quot;/&quot;, &quot;new/&quot;, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               tmpdir  = concatenate(newfile, cmd_text, &quot;/&quot;, &quot;tmp/&quot;, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               curdir  = concatenate(newfile, cmd_text, &quot;/&quot;, &quot;cur/&quot;, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               mdffilename = concatenate(newfile, cmd_text, &quot;/&quot;, &quot;maildirfolder&quot;, (char *) 0);
</code></pre>
</li>
<li><pre><code>                               newfile = concatenate(newfile, cmd_text, &quot;/&quot;, &quot;new/&quot;, bkpnewfile, (char *) 0);
</code></pre>
</li>
<li><pre><code>                           &#125;
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (STREQUAL(value, &quot;LOG&quot;, cmd_len) || STREQUAL(value, &quot;WARN&quot;, cmd_len)) &#123;
</code></pre>
</li>
<li><pre><code>                           msg_warn(&quot;%s: header check warning: %s&quot;, myname, cmd_text);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (STREQUAL(value, &quot;INFO&quot;, cmd_len)) &#123;
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: header check info: %s&quot;, myname, cmd_text);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                       if (msg_verbose)
</code></pre>
</li>
<li><pre><code>                           msg_info(&quot;%s: exiting filter CMD&quot;, myname);
</code></pre>
</li>
<li><pre><code>                   &#125; /* End-Of-Check */
</code></pre>
</li>
<li></li>
<li><pre><code>                   myfree(header);
</code></pre>
</li>
<li><pre><code>                   vstring_free(fltstr);
</code></pre>
</li>
<li><pre><code>                   vstream_fclose(tmpfilter);
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>               myfree(filtername);
</code></pre>
</li>
<li><pre><code>           &#125; /* End-Of-Maildirfilter */
</code></pre>
</li>
<li></li>
<li><pre><code>           /* Deliver to curdir. */
</code></pre>
</li>
<li><pre><code>           if (mail_copy_status == 0) &#123;
</code></pre>
</li>
<li><pre><code>               if (sane_link(tmpfile, newfile) &lt; 0
</code></pre>
</li>
<li><pre><code>                   &amp;&amp; (errno != ENOENT
</code></pre>
</li>
<li><pre><code>                       || (make_dirs(curdir, 0700), make_dirs(newdir, 0700), make_dirs(tmpdir, 0700)) &lt; 0
</code></pre>
</li>
<li><pre><code>                       || sane_link(tmpfile, newfile) &lt; 0)) &#123;
</code></pre>
</li>
<li><pre><code>                   dsb_simple(why, mbox_dsn(errno, &quot;4.2.0&quot;), &quot;create maildir file %s: %m&quot;, newfile);
</code></pre>
</li>
<li><pre><code>                   mail_copy_status = MAIL_COPY_STAT_WRITE;
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>               if (var_virt_maildir_extended) &#123;
</code></pre>
</li>
<li><pre><code>                   time(&amp;tm);
</code></pre>
</li>
<li></li>
<li><pre><code>                   /* Check if the quota in the file is the same as the current one, if not, delete the file. */
</code></pre>
</li>
<li><pre><code>                   sizefile = vstream_fopen(sizefilename, O_RDONLY, 0);
</code></pre>
</li>
<li><pre><code>                   if (sizefile) &#123;
</code></pre>
</li>
<li><pre><code>                       filequota = vstring_alloc(128);
</code></pre>
</li>
<li><pre><code>                       vstring_get_null_bound(filequota, sizefile, 127);
</code></pre>
</li>
<li><pre><code>                       vstream_fclose(sizefile);
</code></pre>
</li>
<li><pre><code>                       if (atol(vstring_export(filequota)) != n)
</code></pre>
</li>
<li><pre><code>                           unlink(sizefilename);
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                   /* Open maildirsize file to append this transaction. */
</code></pre>
</li>
<li><pre><code>                   sizefile = vstream_fopen(sizefilename, O_WRONLY | O_APPEND, 0640);
</code></pre>
</li>
<li></li>
<li><pre><code>                   /* If the open fails (maildirsize doesn&#39;t exist), or it&#39;s too large, or too old, overwrite it. */
</code></pre>
</li>
<li><pre><code>                   if(!sizefile || (stat(sizefilename, &amp;sizefile_stat) &lt; 0) || (sizefile_stat.st_size &gt; SIZEFILE_MAX) || (sizefile_stat.st_mtime + 15*60 &lt; tm)) &#123;
</code></pre>
</li>
<li><pre><code>                       /* If the file exists, sizefile has been opened above, so close it first. */
</code></pre>
</li>
<li><pre><code>                       if (sizefile) &#123;
</code></pre>
</li>
<li><pre><code>                           vstream_fclose(sizefile);
</code></pre>
</li>
<li><pre><code>                           sizefile = vstream_fopen(sizefilename, O_WRONLY | O_TRUNC, 0640);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li><pre><code>                       else &#123;
</code></pre>
</li>
<li><pre><code>                           sizefile = vstream_fopen(sizefilename, O_WRONLY | O_CREAT, 0640);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                       /* If the creation worked, write to the file, otherwise just give up. */
</code></pre>
</li>
<li><pre><code>                       if (sizefile) &#123;
</code></pre>
</li>
<li><pre><code>                           vstream_fprintf(sizefile, &quot;%ldS\n%ld %ld\n&quot;, n, saved_size, saved_count);
</code></pre>
</li>
<li><pre><code>                           vstream_fclose(sizefile);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li><pre><code>                   else &#123;
</code></pre>
</li>
<li><pre><code>                       /* We opened maildirsize, so let&#39;s just append this transaction and close it. */
</code></pre>
</li>
<li><pre><code>                       vstream_fprintf(sizefile, &quot;%ld 1\n&quot;, (long) mail_stat.st_size);
</code></pre>
</li>
<li><pre><code>                       vstream_fclose(sizefile);
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>                   /*
</code></pre>
</li>
<li><pre><code>                    * 1) mdffilename != 0, so the maildirfilter code went through the MOVE to subfolder rule.
</code></pre>
</li>
<li><pre><code>                    * 2) stat() failed, maybe the file does not exist? Try to create it.
</code></pre>
</li>
<li><pre><code>                    */
</code></pre>
</li>
<li><pre><code>                   if (mdffilename &amp;&amp; (stat(mdffilename, &amp;mdffile_stat) &lt; 0)) &#123;
</code></pre>
</li>
<li><pre><code>                       mdffile = vstream_fopen(mdffilename, O_WRONLY | O_CREAT, 0600);
</code></pre>
</li>
<li><pre><code>                       if (mdffile) &#123;
</code></pre>
</li>
<li><pre><code>                           vstream_fclose(mdffile);
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li><pre><code>                       else &#123;
</code></pre>
</li>
<li><pre><code>                           msg_warn(&quot;Cannot create maildirfolder file &#39;%s&#39;: %s&quot;, mdffilename, strerror(errno));
</code></pre>
</li>
<li><pre><code>                       &#125;
</code></pre>
</li>
<li><pre><code>                   &#125;
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li><pre><code>   if (unlink(tmpfile) &lt; 0)
</code></pre>
</li>
<li><pre><code>       msg_warn(&quot;remove %s: %m&quot;, tmpfile);
</code></pre>
   }<br>   set_eugid(var_owner_uid, var_owner_gid);</li>
</ul>
<p>@@ -224,31 +955,64 @@<br>      * location possibly under user control.<br>      *&#x2F;<br>     if (mail_copy_status &amp; MAIL_COPY_STAT_CORRUPT) {<br>-	deliver_status &#x3D; DEL_STAT_DEFER;</p>
<ul>
<li>} else if (mail_copy_status !&#x3D; 0) {</li>
<li>   if (errno &#x3D;&#x3D; EACCES) {</li>
<li><pre><code>   msg_warn(&quot;maildir access problem for UID/GID=%lu/%lu: %s&quot;,
</code></pre>
</li>
<li><pre><code>       (long) usr_attr.uid, (long) usr_attr.gid,
</code></pre>
</li>
<li><pre><code>       STR(why-&gt;reason));
</code></pre>
</li>
<li><pre><code>   msg_warn(&quot;perhaps you need to create the maildirs in advance&quot;);
</code></pre>
</li>
<li>   }</li>
<li>   vstring_sprintf_prepend(why-&gt;reason, “maildir delivery failed: “);</li>
<li>   deliver_status &#x3D;</li>
<li><pre><code>   (STR(why-&gt;status)[0] == &#39;4&#39; ?
</code></pre>
</li>
<li><pre><code>    defer_append : bounce_append)
</code></pre>
</li>
<li><pre><code>   (BOUNCE_FLAGS(state.request),
</code></pre>
</li>
<li><pre><code>    BOUNCE_ATTR(state.msg_attr));
</code></pre>
</li>
<li>} else {</li>
<li>   dsb_simple(why, “2.0.0”, “delivered to maildir”);</li>
<li>   deliver_status &#x3D; sent(BOUNCE_FLAGS(state.request),</li>
<li><pre><code>           SENT_ATTR(state.msg_attr));
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>   deliver_status = DEL_STAT_DEFER;
</code></pre>
</li>
<li>}</li>
<li>else if (mail_copy_status !&#x3D; 0) {</li>
<li><pre><code>   if (errno == EACCES) &#123;
</code></pre>
</li>
<li><pre><code>       msg_warn(&quot;maildir access problem for UID/GID=%lu/%lu: %s&quot;,
</code></pre>
</li>
<li><pre><code>               (long) usr_attr.uid, (long) usr_attr.gid, STR(why-&gt;reason));
</code></pre>
</li>
<li><pre><code>       msg_warn(&quot;perhaps you need to create the maildirs in advance&quot;);
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>   /* Support per-recipient bounce messages. */
</code></pre>
</li>
<li><pre><code>   const char *limit_message;
</code></pre>
</li>
<li><pre><code>   int errnored = errno; /* Seems like mail_addr_find resets errno ... */
</code></pre>
</li>
<li></li>
<li><pre><code>   if (*var_virt_maildir_limit_message_maps != 0 &amp;&amp; (limit_message = mail_addr_find(virtual_maildir_limit_message_maps, state.msg_attr.user, (char **) NULL)) != 0) &#123;
</code></pre>
</li>
<li><pre><code>       errno = errnored;
</code></pre>
</li>
<li><pre><code>       if (errno == EFBIG) &#123;
</code></pre>
</li>
<li><pre><code>           dsb_simple(why, &quot;5.2.2&quot;, limit_message, NULL);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       if (errno == EDQUOT) &#123;
</code></pre>
</li>
<li><pre><code>           dsb_simple(why, &quot;4.2.2&quot;, limit_message, NULL);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li><pre><code>   else &#123;
</code></pre>
</li>
<li><pre><code>       errno = errnored;
</code></pre>
</li>
<li><pre><code>       if (errno == EFBIG) &#123;
</code></pre>
</li>
<li><pre><code>           dsb_simple(why, &quot;5.2.2&quot;, var_virt_maildir_limit_message, NULL);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       if (errno == EDQUOT) &#123;
</code></pre>
</li>
<li><pre><code>           dsb_simple(why, &quot;4.2.2&quot;, var_virt_maildir_limit_message, NULL);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li></li>
<li><pre><code>   vstring_sprintf_prepend(why-&gt;reason, &quot;maildir delivery failed: &quot;);
</code></pre>
</li>
<li><pre><code>   deliver_status =
</code></pre>
</li>
<li><pre><code>           (STR(why-&gt;status)[0] == &#39;4&#39; ? defer_append : bounce_append)
</code></pre>
</li>
<li><pre><code>           (BOUNCE_FLAGS(state.request), BOUNCE_ATTR(state.msg_attr));
</code></pre>
   }</li>
<li>else {</li>
<li><pre><code>   dsb_simple(why, &quot;2.0.0&quot;, &quot;delivered to maildir&quot;);
</code></pre>
</li>
<li><pre><code>   deliver_status = sent(BOUNCE_FLAGS(state.request), SENT_ATTR(state.msg_attr));
</code></pre>
</li>
<li>}</li>
<li><pre><code>vstring_free(buf);
</code></pre>
</li>
<li><pre><code>myfree(newdir);
myfree(tmpdir);
myfree(curdir);
</code></pre>
</li>
<li></li>
<li>if (sizefilename)</li>
<li><pre><code>   myfree(sizefilename);
</code></pre>
</li>
<li>if (mdffilename)</li>
<li><pre><code>   myfree(mdffilename);
</code></pre>
</li>
<li><pre><code>myfree(tmpfile);
if (newfile)
</code></pre>
</li>
</ul>
<ul>
<li>   myfree(newfile);</li>
</ul>
<ul>
<li><pre><code>   myfree(newfile);
</code></pre>
</li>
<li>if (bkpnewfile)</li>
<li><pre><code>   myfree(bkpnewfile);
</code></pre>
</li>
<li><pre><code>return (deliver_status);
</code></pre>
}<br>diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;virtual.c postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;virtual.c<br>— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;virtual.c	2011-02-19 01:46:06.000000000 +0100<br>+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;virtual.c	2013-06-07 13:21:22.840143270 +0200<br>@@ -335,12 +335,30 @@<br>char   <em>var_mail_spool_dir;		&#x2F;</em> XXX dependency fix *&#x2F;<br>bool    var_strict_mbox_owner;</li>
</ul>
<p>+char   *var_virt_mailbox_limit_maps;<br>+bool    var_virt_mailbox_limit_inbox;<br>+bool    var_virt_mailbox_limit_override;<br>+bool    var_virt_maildir_extended;<br>+bool    var_virt_overquota_bounce;<br>+char   *var_virt_maildir_limit_message;<br>+char   *var_virt_maildir_limit_message_maps;<br>+char   *var_virt_maildir_suffix;<br>+bool    var_virt_trash_count;<br>+char   *var_virt_trash_name;<br>+bool    var_virt_maildir_filter;<br>+char   <em>var_virt_maildir_filter_maps;<br>+<br>+<br>  &#x2F;</em></p>
<ul>
<li>Mappings.<br>   *&#x2F;<br> MAPS   *virtual_mailbox_maps;<br> MAPS   *virtual_uid_maps;<br> MAPS   *virtual_gid_maps;<br>+MAPS   *virtual_mailbox_limit_maps;<br>+MAPS   *virtual_maildir_limit_message_maps;<br>+MAPS   *virtual_maildir_filter_maps;</li>
</ul>
<ul>
<li></li>
</ul>
<p>  &#x2F;*</p>
<ul>
<li>Bit masks.<br>@@ -450,15 +468,28 @@<br> *&#x2F;<br>virtual_mailbox_maps &#x3D;<br>maps_create(VAR_VIRT_MAILBOX_MAPS, var_virt_mailbox_maps,</li>
</ul>
<ul>
<li><pre><code>      DICT_FLAG_LOCK | DICT_FLAG_PARANOID);
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>      DICT_FLAG_LOCK);

virtual_uid_maps =
maps_create(VAR_VIRT_UID_MAPS, var_virt_uid_maps,
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>      DICT_FLAG_LOCK | DICT_FLAG_PARANOID);
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>      DICT_FLAG_LOCK);

virtual_gid_maps =
maps_create(VAR_VIRT_GID_MAPS, var_virt_gid_maps,
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>      DICT_FLAG_LOCK | DICT_FLAG_PARANOID);
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>      DICT_FLAG_LOCK);
</code></pre>
</li>
<li></li>
<li>virtual_mailbox_limit_maps &#x3D;</li>
<li><pre><code>   maps_create(VAR_VIRT_MAILBOX_LIMIT_MAPS, var_virt_mailbox_limit_maps,
</code></pre>
</li>
<li><pre><code>               DICT_FLAG_LOCK);
</code></pre>
</li>
<li></li>
<li>virtual_maildir_limit_message_maps &#x3D;</li>
<li><pre><code>   maps_create(VAR_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS, var_virt_maildir_limit_message_maps,
</code></pre>
</li>
<li><pre><code>               DICT_FLAG_LOCK);
</code></pre>
</li>
<li></li>
<li>virtual_maildir_filter_maps &#x3D;</li>
<li><pre><code>   maps_create(VAR_VIRT_MAILDIR_FILTER_MAPS, var_virt_maildir_filter_maps,
</code></pre>
</li>
<li><pre><code>               DICT_FLAG_LOCK);
</code></pre>
</li>
<li></li>
</ul>
<pre><code> virtual_mbox_lock_mask = mbox_lock_mask(var_virt_mailbox_lock);
</code></pre>
<p> }<br>@@ -510,10 +541,22 @@<br>     VAR_VIRT_GID_MAPS, DEF_VIRT_GID_MAPS, &amp;var_virt_gid_maps, 0, 0,<br>     VAR_VIRT_MAILBOX_BASE, DEF_VIRT_MAILBOX_BASE, &amp;var_virt_mailbox_base, 1, 0,<br>     VAR_VIRT_MAILBOX_LOCK, DEF_VIRT_MAILBOX_LOCK, &amp;var_virt_mailbox_lock, 1, 0,<br>+	VAR_VIRT_MAILBOX_LIMIT_MAPS, DEF_VIRT_MAILBOX_LIMIT_MAPS, &amp;var_virt_mailbox_limit_maps, 0, 0,<br>+	VAR_VIRT_MAILDIR_LIMIT_MESSAGE, DEF_VIRT_MAILDIR_LIMIT_MESSAGE, &amp;var_virt_maildir_limit_message, 1, 0,<br>+	VAR_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS, DEF_VIRT_MAILDIR_LIMIT_MESSAGE_MAPS, &amp;var_virt_maildir_limit_message_maps, 0, 0,<br>+	VAR_VIRT_MAILDIR_SUFFIX, DEF_VIRT_MAILDIR_SUFFIX, &amp;var_virt_maildir_suffix, 0, 0,<br>+	VAR_VIRT_TRASH_NAME, DEF_VIRT_TRASH_NAME, &amp;var_virt_trash_name, 0, 0,<br>+	VAR_VIRT_MAILDIR_FILTER_MAPS, DEF_VIRT_MAILDIR_FILTER_MAPS, &amp;var_virt_maildir_filter_maps, 0, 0,<br>     0,<br>     };<br>     static const CONFIG_BOOL_TABLE bool_table[] &#x3D; {<br>     VAR_STRICT_MBOX_OWNER, DEF_STRICT_MBOX_OWNER, &amp;var_strict_mbox_owner,<br>+	VAR_VIRT_MAILBOX_LIMIT_INBOX, DEF_VIRT_MAILBOX_LIMIT_INBOX, &amp;var_virt_mailbox_limit_inbox,<br>+	VAR_VIRT_MAILBOX_LIMIT_OVERRIDE, DEF_VIRT_MAILBOX_LIMIT_OVERRIDE, &amp;var_virt_mailbox_limit_override,<br>+	VAR_VIRT_MAILDIR_EXTENDED, DEF_VIRT_MAILDIR_EXTENDED, &amp;var_virt_maildir_extended,<br>+	VAR_VIRT_OVERQUOTA_BOUNCE, DEF_VIRT_OVERQUOTA_BOUNCE, &amp;var_virt_overquota_bounce,<br>+	VAR_VIRT_TRASH_COUNT, DEF_VIRT_TRASH_COUNT, &amp;var_virt_trash_count,<br>+	VAR_VIRT_MAILDIR_FILTER, DEF_VIRT_MAILDIR_FILTER, &amp;var_virt_maildir_filter,<br>     0,<br>     };</p>
<p>@@ -530,6 +573,7 @@<br>                MAIL_SERVER_PRE_INIT, pre_init,<br>                MAIL_SERVER_POST_INIT, post_init,<br>                MAIL_SERVER_PRE_ACCEPT, pre_accept,</p>
<ul>
<li><pre><code>                  MAIL_SERVER_BOOL_TABLE, bool_table,
          MAIL_SERVER_PRIVILEGED,
          0);
</code></pre>
</li>
</ul>
<p> }<br>diff -uNr postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;virtual.h postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;virtual.h<br>— postfix-2.10.0.orig&#x2F;src&#x2F;virtual&#x2F;virtual.h	2006-01-08 00:59:47.000000000 +0100<br>+++ postfix-2.10.0&#x2F;src&#x2F;virtual&#x2F;virtual.h	2013-06-07 13:21:22.841143270 +0200<br>@@ -34,6 +34,9 @@<br> extern MAPS *virtual_mailbox_maps;<br> extern MAPS *virtual_uid_maps;<br> extern MAPS *virtual_gid_maps;<br>+extern MAPS *virtual_mailbox_limit_maps;<br>+extern MAPS *virtual_maildir_limit_message_maps;<br>+extern MAPS *virtual_maildir_filter_maps;</p>
<p>  &#x2F;*</p>
<ul>
<li>User attributes: these control the privileges for delivery to external</li>
</ul>



<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2023/09/28/Linux%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/wireshark/postfix/postfix/">2023-09-28</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2023/09/28/Linux%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/wireshark/openvpn/server.conf/">2023-09-28</a></div></section></div>








      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本站由 <a href="/">@anonymity</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.19.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->



<!-- inject -->


  </div>
</body>
</html>
